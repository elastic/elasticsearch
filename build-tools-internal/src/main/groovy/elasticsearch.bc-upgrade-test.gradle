/*
 * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
 * or more contributor license agreements. Licensed under the "Elastic License
 * 2.0", the "GNU Affero General Public License v3.0 only", and the "Server Side
 * Public License v 1"; you may not use this file except in compliance with, at
 * your election, the "Elastic License 2.0", the "GNU Affero General Public
 * License v3.0 only", or the "Server Side Public License, v 1".
 */

import org.elasticsearch.gradle.Version
import org.elasticsearch.gradle.testclusters.StandaloneRestIntegTestTask

tasks.register("bcUpgradeTest", StandaloneRestIntegTestTask) {
  project.gradle.taskGraph.whenReady { allTasks ->
    if (allTasks.hasTask(getPath())) {
      if (System.getProperty("tests.bwc.refspec.main") == null) {
        throw new GradleException("You must set the `tests.bwc.refspec.main` system property to run bcUpgradeTest")
      }
      if (System.getProperty("tests.bwc.main.version") == null) {
        throw new GradleException("You must set the `tests.bwc.main.version` system property to run bcUpgradeTest")
      }
    }
  }
  if (System.getProperty("tests.bwc.refspec.main") != null && System.getProperty("tests.bwc.main.version") != null) {
    usesBwcDistributionFromRef(System.getProperty("tests.bwc.refspec.main"), Version.fromString(System.getProperty("tests.bwc.main.version")))
    systemProperty("tests.old_cluster_version", System.getProperty("tests.bwc.main.version"))
  }
}

<?xml version="1.0"?>
<project name="elasticsearch-integration-tests">

  <macrodef name="run-script">
      <attribute name="script"/>
      <attribute name="dir"/>
      <attribute name="args"/>
    <sequential>
      <exec executable="cmd" osfamily="winnt" dir="@{dir}" spawn="true">
        <arg value="/c"/>
        <arg value="@{dir}/@{script}.bat"/>
        <arg line="@{args}"/>
      </exec>

      <exec executable="sh" osfamily="unix" dir="@{dir}" spawn="true">
        <arg value="@{dir}/@{script}"/>
        <arg line="@{args}"/>
      </exec>
    </sequential>
  </macrodef>

  <!-- unzip release artifact -->
  <target name="start-external-cluster">
    <property name="integ.finalname" value="${project.artifactId}-${project.version}"/>
    <property name="integ.scratch" location="${project.build.directory}/integ-tests"/>
    <unzip src="${project.build.directory}/releases/${integ.finalname}.zip"
           dest="${integ.scratch}"/>

    <property name="integ.home" location="${integ.scratch}/${integ.finalname}"/>

    <!-- execute -->
    <property name="integ.args"
              value="-Des.node.name=smoke_tester -Des.cluster.name=prepare_release
                     -Des.discovery.zen.ping.multicast.enabled=false -Des.script.inline=on
                     -Des.script.indexed=on"/>

    <echo>Starting up external cluster...</echo>

    <run-script dir="${integ.home}" script="bin/elasticsearch" args="${integ.args}"/>

    <waitfor maxwait="3" maxwaitunit="minute" checkevery="500">
      <http url="http://127.0.0.1:9200"/>
    </waitfor>

    <echo>External cluster started</echo>
  </target>

  <target name="stop-external-cluster">
    <!-- TODO: this is brutal, specify and read our pid file instead -->
    <!-- find ES processes with jps, then shoot them with 50 cal -->
    <exec executable="jps">
      <arg value="-l"/>
      <redirector outputproperty="process.pid">
        <outputfilterchain>
          <linecontains>
            <contains value="org.elasticsearch.bootstrap.Elasticsearch"/>
          </linecontains>
          <replacestring from=" org.elasticsearch.bootstrap.Elasticsearch"/>
        </outputfilterchain>
      </redirector>
    </exec>

    <echo>Shutting down external cluster</echo>

    <exec executable="taskkill" osfamily="winnt">
      <arg value="/F"/>
      <arg value="/PID"/>
      <arg value="${process.pid}"/>
    </exec>
    <exec executable="kill" osfamily="unix">
      <arg value="-9"/>
      <arg value="${process.pid}"/>
    </exec>

    <!-- best effort cleanup. 'clean' will take care in all cases -->
    <delete dir="${project.build.directory}/integ-tests" failonerror="false"/>
  </target>
</project>

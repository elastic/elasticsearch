---
"line_64":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "_ingest/pipeline/geoip"
        body: |
          {
            "description" : "Add geoip info",
            "processors" : [
              {
                "geoip" : {
                  "field" : "ip"
                }
              }
            ]
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "my-index-000001/_doc/my_id"
        pipeline: "geoip"
        body: |
          {
            "ip": "89.160.20.128"
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "my-index-000001/_doc/my_id"
  - is_false: _shards.failures
  - match:
      $body:
        {
          "found": true,
          "_index": "my-index-000001",
          "_id": "my_id",
          "_version": 1,
          "_seq_no" : $body._seq_no,
          "_primary_term": 1,
          "_source": {
            "ip": "89.160.20.128",
            "geoip": {
              "continent_name": "Europe",
              "country_name": "Sweden",
              "country_iso_code": "SE",
              "city_name" : "Linköping",
              "region_iso_code" : "SE-E",
              "region_name" : "Östergötland County",
              "location": { "lat": 58.4167, "lon": 15.6167 }
            }
          }
        }
---
"line_115":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "_ingest/pipeline/geoip"
        body: |
          {
            "description" : "Add geoip info",
            "processors" : [
              {
                "geoip" : {
                  "field" : "ip",
                  "target_field" : "geo",
                  "database_file" : "GeoLite2-Country.mmdb"
                }
              }
            ]
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "my-index-000001/_doc/my_id"
        pipeline: "geoip"
        body: |
          {
            "ip": "89.160.20.128"
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "my-index-000001/_doc/my_id"
  - is_false: _shards.failures
  - match:
      $body:
        {
          "found": true,
          "_index": "my-index-000001",
          "_id": "my_id",
          "_version": 1,
          "_seq_no" : $body._seq_no,
          "_primary_term": 1,
          "_source": {
            "ip": "89.160.20.128",
            "geo": {
              "continent_name": "Europe",
              "country_name": "Sweden",
              "country_iso_code": "SE"
            }
          }
        }
---
"line_167":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "_ingest/pipeline/geoip"
        body: |
          {
            "description" : "Add geoip info",
            "processors" : [
              {
                "geoip" : {
                  "field" : "ip"
                }
              }
            ]
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "my-index-000001/_doc/my_id"
        pipeline: "geoip"
        body: |
          {
            "ip": "80.231.5.0"
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "my-index-000001/_doc/my_id"
  - is_false: _shards.failures
  - match:
      $body:
        {
          "_index" : "my-index-000001",
          "_id" : "my_id",
          "_version" : 1,
          "_seq_no" : $body._seq_no,
          "_primary_term": 1,
          "found" : true,
          "_source" : {
            "ip" : "80.231.5.0"
          }
        }
---
"line_216":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "my_ip_locations"
        body: |
          {
            "mappings": {
              "properties": {
                "geoip": {
                  "properties": {
                    "location": { "type": "geo_point" }
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "_ingest/pipeline/geoip"
        body: |
          {
            "description" : "Add geoip info",
            "processors" : [
              {
                "geoip" : {
                  "field" : "ip"
                }
              }
            ]
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "my_ip_locations/_doc/1"
        refresh: "true"
        pipeline: "geoip"
        body: |
          {
            "ip": "89.160.20.128"
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "my_ip_locations/_search"
        body: |
          {
            "query": {
              "bool": {
                "must": {
                  "match_all": {}
                },
                "filter": {
                  "geo_distance": {
                    "distance": "1m",
                    "geoip.location": {
                      "lon": 15.6167,
                      "lat": 58.4167
                    }
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took" : $body.took,
          "timed_out" : false,
          "_shards" : {
            "total" : 1,
            "successful" : 1,
            "skipped" : 0,
            "failed" : 0
          },
          "hits" : {
            "total" : {
              "value": 1,
              "relation": "eq"
            },
            "max_score" : 1.0,
            "hits" : [
              {
                "_index" : "my_ip_locations",
                "_id" : "1",
                "_score" : 1.0,
                "_source" : {
                  "geoip" : {
                    "continent_name" : "Europe",
                    "country_name" : "Sweden",
                    "country_iso_code" : "SE",
                    "city_name" : "Linköping",
                    "region_iso_code" : "SE-E",
                    "region_name" : "Östergötland County",
                    "location" : {
                      "lon" : 15.6167,
                      "lat" : 58.4167
                    }
                  },
                  "ip" : "89.160.20.128"
                }
              }
            ]
          }
        }

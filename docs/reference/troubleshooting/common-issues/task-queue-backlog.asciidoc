[[task-queue-backlog]]
=== Task queue backlog

*******************************
*Product:* Elasticsearch +
*Deployment type:* Elastic Cloud (hosted or self-managed), self-managed +
*Versions:* All
*******************************

A backlogged task queue can prevent tasks from completing and lead to an 
unhealthy cluster state. Contributing factors include resource constraints, 
a large number of tasks triggered at once, and long-running tasks.

[discrete]
[[diagnose-task-queue-backlog]]
==== Diagnose a backlogged task queue

**Check the thread pool status**

A <<high-cpu-usage,depleted thread pool>> can result in
<<rejected-requests,rejected requests>>. 

Use the <<cat-thread-pool,cat thread pool API> to monitor
active threads, queued tasks, rejections, and completed tasks:

[source,console]
----
GET /_cat/thread_pool?v&s=t,n&h=type,name,node_name,active,queue,rejected,completed
----

* Look for high `active` and `queue` metrics, which indicate potential bottlenecks.
* Analyze whether thread pool issues are specific to a <<data-tiers,data tier>> or
caused by uneven node resource utilization such as <<hotspotting,hot spotting>>.

[discrete]
[[diagnose-hot-thread]]
**Inspect hot threads on each node**

If a particular thread pool queue is backed up, periodically poll the
<<cluster-nodes-hot-threads,nodes hot threads API>> to gauge the thread's
progression and ensure it has sufficient resources:

[source,console]
----
GET /_nodes/hot_threads
----

**Identify long-running node tasks**

Long-running tasks can also cause a backlog. Use the <<tasks,task
management API>> to check for excessive `running_time_in_nanos` values:

[source,console]
----
GET /_tasks?pretty=true&human=true&detailed=true
----

You can filter on a specific `action`, such as <<docs-bulk,bulk indexing>> or search-related tasks.

* Filter on <<docs-bulk,bulk index>> actions:
+
[source,console]
----
GET /_tasks?human&detailed&actions=indices:data/write/bulk
----

* Filter on search actions:
+
[source,console]
----
GET /_tasks?human&detailed&actions=indices:data/write/search
----

**Look for long-running cluster tasks**

Use the <<cluster-pending,cluster pending tasks API>> to identify delays
in cluster state synchronization: 

[source,console]
----
GET /_cluster/pending_tasks
----

Tasks with a high `timeInQueue` value are likely contributing to the backlog.

[discrete]
[[resolve-task-queue-backlog]]
==== Recommendations

**Increase available resources** 

<<reduce-cpu-usage>> or increase thread pool sizes. 

For example, the `force_merge` thread pool defaults to a single thread. 
Increasing the size to 2 in `elasticsearch.yml` might help reduce a backlog 
of force merge requests:

[source,yaml]
----
thread_pool.force_merge.size: 2
----

For more information, see <<settings>>.

**Cancel stuck tasks**

If an active task's <<diagnose-hot-thread,hot thread>> shows no progress, consider canceling the task.

[discrete]
==== Resources

Related symptoms:

* <<high-cpu-usage,High CPU usage>>
* <<rejected-requests,Rejected requests>>

// TODO add link to standard Additional resources when that topic exists

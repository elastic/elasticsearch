setup:
  - do:
      xpack.prelert.put_job:
        body:  >
          {
            "job_id":"job-1",
            "analysis_config" : {
                "bucket_span":3600,
                "detectors" :[{"function":"count"}]
            },
            "data_description" : {
                "format":"ELASTICSEARCH",
                "time_field":"time",
                "time_format":"epoch"
            }
          }

  - do:
      xpack.prelert.put_job:
        body:  >
          {
            "job_id":"job-2",
            "analysis_config" : {
                "bucket_span":3600,
                "detectors" :[{"function":"count"}]
            },
            "data_description" : {
                "format":"ELASTICSEARCH",
                "time_field":"time",
                "time_format":"epoch"
            }
          }
---
"Test put scheduler referring to missing job_id":
  - do:
      catch: /resource_not_found_exception/
      xpack.prelert.put_scheduler:
        scheduler_id: test-scheduler-1
        body:  >
          {
            "job_id":"a-missing-job",
            "indexes":["index-foo"],
            "types":["type-bar"]
          }

---
"Test put scheduler referring to existing job_id":
  - do:
      xpack.prelert.put_scheduler:
        scheduler_id: test-scheduler-1
        body:  >
          {
            "job_id":"job-1",
            "indexes":["index-foo"],
            "types":["type-bar"]
          }
  - match: { scheduler_id: "test-scheduler-1" }

---
"Test put scheduler whose id is already taken":
  - do:
      xpack.prelert.put_scheduler:
        scheduler_id: test-scheduler-1
        body:  >
          {
            "job_id":"job-1",
            "indexes":["index-foo"],
            "types":["type-bar"]
          }
  - match: { scheduler_id: "test-scheduler-1" }

  - do:
      catch: /resource_already_exists_exception/
      xpack.prelert.put_scheduler:
        scheduler_id: test-scheduler-1
        body:  >
          {
            "job_id":"job-2",
            "indexes":["index-foo"],
            "types":["type-bar"]
          }

---
"Test put scheduler with job_id that is already used by another scheduler":
  - do:
      xpack.prelert.put_scheduler:
        scheduler_id: test-scheduler-1
        body:  >
          {
            "job_id":"job-1",
            "indexes":["index-foo"],
            "types":["type-bar"]
          }
  - match: { scheduler_id: "test-scheduler-1" }

  - do:
      catch: /A scheduler \[test-scheduler-1\] already exists for job \[job-1\]/
      xpack.prelert.put_scheduler:
        scheduler_id: test-scheduler-2
        body:  >
          {
            "job_id":"job-1",
            "indexes":["index-foo"],
            "types":["type-bar"]
          }

---
"Test put scheduler with invalid query":
  - do:
      catch: /parsing_exception/
      xpack.prelert.put_scheduler:
        scheduler_id: test-scheduler-1
        body:  >
          {
            "job_id":"job-1",
            "indexes":["index-foo"],
            "types":["type-bar"],
            "query":{"match_all_mispelled":{}}
          }

---
"Test delete scheduler with missing id":
  - do:
      catch: /resource_not_found_exception/
      xpack.prelert.delete_scheduler:
        scheduler_id: a-missing-scheduler

---
"Test delete scheduler":
  - do:
      xpack.prelert.put_scheduler:
        scheduler_id: test-scheduler-1
        body:  >
          {
            "job_id":"job-1",
            "indexes":["index-foo"],
            "types":["type-bar"]
          }
  - match: { scheduler_id: "test-scheduler-1" }

  - do:
      xpack.prelert.delete_scheduler:
        scheduler_id: test-scheduler-1
  - match: { acknowledged: true }

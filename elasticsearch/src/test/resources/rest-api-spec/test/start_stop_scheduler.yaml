setup:
  - do:
      indices.create:
        index: airline-data
        body:
          mappings:
            response:
              properties:
                time:
                  type: date

  - do:
      xpack.ml.put_job:
        job_id: scheduled-job
        body:  >
          {
            "job_id":"scheduled-job",
            "description":"Analysis of response time by airline",
            "analysis_config" : {
                "bucket_span":3600,
                "detectors" :[{"function":"metric","field_name":"responsetime","by_field_name":"airline"}]
            },
            "data_description" : {
                "format":"JSON",
                "time_field":"time",
                "time_format":"epoch"
            }
          }
  - do:
      xpack.ml.put_scheduler:
        scheduler_id: scheduler-1
        body:  >
          {
            "job_id":"scheduled-job",
            "indexes":"airline-data",
            "types":"response"
          }
---
"Test start and stop scheduler happy path":
  - do:
      xpack.ml.open_job:
        job_id: "scheduled-job"
  - do:
      xpack.ml.start_scheduler:
        "scheduler_id": "scheduler-1"
        "start": 0
  - do:
      xpack.ml.get_schedulers_stats:
        scheduler_id: "scheduler-1"
  - match: { schedulers.0.status: STARTED }
  - do:
      xpack.ml.stop_scheduler:
        "scheduler_id": "scheduler-1"
  - do:
      xpack.ml.get_schedulers_stats:
        scheduler_id: "scheduler-1"
  - match: { schedulers.0.status: STOPPED }
---
"Test start non existing scheduler":
    - do:
        catch: missing
        xpack.ml.start_scheduler:
          "scheduler_id": "non-existing-scheduler"
          "start": 0

---
"Test start scheduled job, but not open":
    - do:
        catch: conflict
        xpack.ml.start_scheduler:
          "scheduler_id": "scheduler-1"
          "start": 0
    - do:
        catch: /cannot start scheduler, expected job status \[OPENED\], but got \[CLOSED\]/
        xpack.ml.start_scheduler:
          "scheduler_id": "scheduler-1"
          "start": 0

---
"Test start already started scheduled job":
  - do:
      xpack.ml.open_job:
        job_id: "scheduled-job"
  - do:
      xpack.ml.start_scheduler:
        "scheduler_id": "scheduler-1"
        "start": 0
  - do:
      catch: conflict
      xpack.ml.start_scheduler:
        "scheduler_id": "scheduler-1"
        "start": 0

  - do:
      catch: /scheduler already started, expected scheduler status \[STOPPED\], but got \[STARTED\]/
      xpack.ml.start_scheduler:
        "scheduler_id": "scheduler-1"
        "start": 0

---
"Test stop non existing scheduler":
    - do:
        catch: missing
        xpack.ml.stop_scheduler:
          "scheduler_id": "non-existing-scheduler"

---
"Test stop already stopped scheduled job":
  - do:
      catch: conflict
      xpack.ml.stop_scheduler:
        "scheduler_id": "scheduler-1"
  - do:
      catch: /scheduler already stopped, expected scheduler status \[STARTED\], but got \[STOPPED\]/
      xpack.ml.stop_scheduler:
        "scheduler_id": "scheduler-1"

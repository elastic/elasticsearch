---
setup:
  - do:
      cluster.health:
        wait_for_status: yellow

---
teardown:
  - do:
      xpack.watcher.delete_watch:
        id: "cluster_health_watch"
        ignore: 404

---
"Getting started - Monitor cluster health":
  - do:
      xpack.watcher.stats: {}
  - match: { "watcher_state": "started" }
  - match: { "watch_count": 0 }

  - do:
      xpack.watcher.put_watch:
        id: "cluster_health_watch"
        body:  >
          {
            "trigger": {
              "schedule": {
                "interval": "1s"
              }
            },
            "input": {
              "http": {
                "request": {
                  "host": "localhost",
                  "port": 9400,
                  "path": "/_cluster/health",
                  "auth" : {
                    "basic" : {
                      "username" : "test_admin",
                      "password" : "changeme"
                    }
                  }
                }
              }
            },
            "condition": {
              "compare": {
                "ctx.payload.number_of_data_nodes": {
                  "lt": "10"
                }
              }
            },
            "actions": {
              "log": {
                "logging": {
                  "text": "executed at {{ctx.execution_time}}"
                }
              }
            }
          }
  - match: { _id: "cluster_health_watch" }
  - match: { created: true }

  - do:
      xpack.watcher.stats: {}
  - match: { "watch_count": 1 }

  # Simulate a Thread.sleep()
  - do:
      catch: request_timeout
      cluster.health:
        wait_for_nodes: 99
        timeout: 10s
  - match: { "timed_out": true }

  - do:
      indices.refresh:
        index: .watcher-history-*

  - do:
      search:
        index: .watcher-history-*
        body: >
          {
            "query": {
              "bool": {
                "must" : [
                  {
                    "term": {
                      "watch_id": {
                        "value": "cluster_health_watch"
                      }
                    }
                  },
                  {
                    "term": {
                       "result.condition.met": {
                         "value": "true"
                       }
                    }
                  }
                ]
              }
            }
          }
  - gte:  { hits.total: 1 }

  - do:
      xpack.watcher.delete_watch:
        id: "cluster_health_watch"
  - match: { found: true }


  - do:
      xpack.watcher.stats: {}
  - match: { "watch_count": 0 }

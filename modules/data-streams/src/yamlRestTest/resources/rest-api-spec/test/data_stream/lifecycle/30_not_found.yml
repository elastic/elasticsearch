setup:
  - skip:
      features: allowed_warnings
      cluster_features: ["datastream_lifecycle"]
      reason: "Data stream lifecycle was GA in 8.11"
  - do:
      allowed_warnings:
        - "index template [my-lifecycle] has index patterns [my-data-stream-1] matching patterns from existing older templates [global] with patterns (global => [*]); this template [my-lifecycle] will take precedence during new index creation"
      indices.put_index_template:
        name: my-lifecycle
        body:
          index_patterns: [my-data-stream-1]
          template:
            settings:
              index.number_of_replicas: 0
            lifecycle:
              data_retention: "10d"
          data_stream: {}

  - do:
      indices.create_data_stream:
        name: my-data-stream-1

---
"Get data stream lifecycle":
  - skip:
      cluster_features: ["datastream_lifecycle", "data_stream.lifecycle.global_retention"]
      reason: "Data stream lifecycle with effective retention was released in 8.14"

  - do:
      indices.get_data_lifecycle:
        name: "*"
  - length: { data_streams: 1}
  - match: { data_streams.0.name: my-data-stream-1 }
  - match: { data_streams.0.lifecycle.data_retention: "10d" }
  - match: { data_streams.0.lifecycle.effective_retention: "10d"}
  - match: { data_streams.0.lifecycle.retention_determined_by: "data_stream_configuration"}
  - match: { data_streams.0.lifecycle.enabled: true}

---
"Get data stream lifecycle when at least one data stream does not exist":

  - do:
      catch:  missing
      indices.get_data_lifecycle:
        name: "my-data-stream-1,does-not-exist"
  - match: { error.reason: "no such index [does-not-exist]" }

---
"Put data stream lifecycle does not succeed when at lease one data stream does not exist":
  - skip:
      cluster_features: ["datastream_lifecycle", "data_stream.lifecycle.global_retention"]
      reason: "Data stream lifecycle with effective retention was released in 8.14"
  - do:
      catch:  missing
      indices.put_data_lifecycle:
        name: "my-data-stream-1,does-not-exist"
        body:
          data_retention: '30d'
  - match: { error.reason: "no such index [does-not-exist]" }

  - do:
      indices.get_data_lifecycle:
        name: "*"
  - length: { data_streams: 1 }
  - match: { data_streams.0.name: my-data-stream-1 }
  - match: { data_streams.0.lifecycle.data_retention: "10d" }
  - match: { data_streams.0.lifecycle.effective_retention: "10d"}
  - match: { data_streams.0.lifecycle.retention_determined_by: "data_stream_configuration"}
  - match: { data_streams.0.lifecycle.enabled: true }

---
"Delete data stream lifecycle does not succeed when at lease one data stream does not exist":
  - skip:
      cluster_features: ["datastream_lifecycle", "data_stream.lifecycle.global_retention"]
      reason: "Data stream lifecycle with effective retention was released in 8.14"
  - do:
      catch:  missing
      indices.delete_data_lifecycle:
        name: "my-data-stream-1,does-not-exist"
  - match: { error.reason: "no such index [does-not-exist]" }

  - do:
      indices.get_data_lifecycle:
        name: "*"
  - length: { data_streams: 1 }
  - match: { data_streams.0.name: my-data-stream-1 }
  - match: { data_streams.0.lifecycle.data_retention: "10d" }
  - match: { data_streams.0.lifecycle.effective_retention: "10d"}
  - match: { data_streams.0.lifecycle.retention_determined_by: "data_stream_configuration"}
  - match: { data_streams.0.lifecycle.enabled: true }

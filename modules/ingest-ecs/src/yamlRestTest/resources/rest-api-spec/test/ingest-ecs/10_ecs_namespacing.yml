---
setup:
  - do:
      ingest.put_pipeline:
        id: "ecs_namespacing_pipeline"
        body:
          processors:
            - ecs_namespacing: {}

---
teardown:
  - do:
      ingest.delete_pipeline:
        id: "ecs_namespacing_pipeline"
        ignore: 404

---
"Test attributes namespacing":
  - do:
      index:
        index: ecs_namespacing_test
        id: "nested_and_flat_attributes"
        pipeline: "ecs_namespacing_pipeline"
        body: {
          "agent.name": "agentNameValue",
          "agent": {
              "type": "agentTypeValue"
          },
          "cloud.provider": "cloudProviderValue",
          "cloud": {
              "type": "cloudTypeValue"
          },
          "host.name": "hostNameValue",
          "host": {
              "type": "hostTypeValue"
          },
          "service.name": "serviceNameValue",
          "service": {
              "type": "serviceTypeValue"
          }
        }

  - do:
      get:
        index: ecs_namespacing_test
        id: "nested_and_flat_attributes"
  - match: { _source.resource.attributes.agent\.name: "agentNameValue" }
  - match: { _source.resource.attributes.agent\.type: "agentTypeValue" }
  - match: { _source.resource.attributes.cloud\.provider: "cloudProviderValue" }
  - match: { _source.resource.attributes.cloud\.type: "cloudTypeValue" }
  - match: { _source.resource.attributes.host\.name: "hostNameValue" }
  - match: { _source.resource.attributes.host\.type: "hostTypeValue" }
  - match: { _source.attributes.service\.name: "serviceNameValue" }
  - match: { _source.attributes.service\.type: "serviceTypeValue" }
  - match: { _source.agent.name: null }
  - match: { _source.agent: null }
  - match: { _source.cloud.provider: null }
  - match: { _source.cloud: null }
  - match: { _source.host.name: null }
  - match: { _source.host: null }
  - match: { _source.service.name: null }
  - match: { _source.service: null }

---
"Test rename special keys":
  - do:
      index:
        index: ecs_namespacing_test
        id: "rename_special_keys"
        pipeline: "ecs_namespacing_pipeline"
        body: {
          "span": {
            "id": "nestedSpanIdValue"
          },
          "span.id": "topLevelSpanIdValue",
          "log.level": "topLevelLogLevelValue",
          "trace": {
            "id": "traceIdValue"
          },
          "trace.id": "topLevelTraceIdValue",
          "message": "this is a message"
        }

  - do:
      get:
        index: ecs_namespacing_test
        id: "rename_special_keys"
  - match: { _source.span_id: "nestedSpanIdValue" }
  - match: { _source.severity_text: "topLevelLogLevelValue" }
  - match: { _source.trace_id: "traceIdValue" }
  - match: { _source.body.text: "this is a message" }
  - match: { _source.span: null }
  - match: { _source.span\.id: null }
  - match: { _source.log\.level: null }
  - match: { _source.trace: null }
  - match: { _source.trace\.id: null }
  - match: { _source.message: null }

---
"Test valid OTel document":
  - do:
      index:
        index: ecs_namespacing_test
        id: "valid_otel_document"
        pipeline: "ecs_namespacing_pipeline"
        body: {
          "resource": {
            "attributes": {
              "foo": "bar"
            }
          },
          "scope": {},
          "attributes": {
            "foo": "bar"
          },
          "body": {
            "text": "a string",
            "structured": {}
          },
          "foo": "bar"
        }

  - do:
      get:
        index: ecs_namespacing_test
        id: "valid_otel_document"
  - match: { _source.resource.attributes.foo: "bar" }
  - match: { _source.scope: {} }
  - match: { _source.attributes.foo: "bar" }
  - match: { _source.body.text: "a string" }
  - match: { _source.body.structured: {} }
  - match: { _source.foo: "bar" }

---
"Test invalid body field":
  - do:
      index:
        index: ecs_namespacing_test
        id: "invalid_scope_field"
        pipeline: "ecs_namespacing_pipeline"
        body: {
          "resource": {},
          "scope": "invalid scope",
          "body": {
            "text": "test message",
            "structured": {
              "foo": "bar"
            }
          },
          "foo": "bar"
        }

  - do:
      get:
        index: ecs_namespacing_test
        id: "invalid_scope_field"
  - match: { _source.attributes.scope: "invalid scope" }
  - match: { _source.attributes.body\.text: "test message" }
  - match: { _source.attributes.body\.structured\.foo: "bar" }
  - match: { _source.attributes.foo: "bar" }
  - match: { _source.body: null }
  - match: { _source.scope: null }

---
"Test ip_location processor with defaults":
  - do:
      ingest.put_pipeline:
        id: "my_pipeline"
        body:  >
          {
            "description": "_description",
            "processors": [
              {
                "ip_location" : {
                  "field" : "field1"
                }
              }
            ]
          }
  - match: { acknowledged: true }

  - do:
      index:
        index: test
        id: "1"
        pipeline: "my_pipeline"
        body: {field1: "89.160.20.128"}

  - do:
      get:
        index: test
        id: "1"
  - match: { _source.field1: "89.160.20.128" }
  - length: { _source.ip_location: 7 }
  - match: { _source.ip_location.city_name: "Linköping" }
  - match: { _source.ip_location.country_iso_code: "SE" }
  - match: { _source.ip_location.location.lon: 15.6167 }
  - match: { _source.ip_location.location.lat: 58.4167 }
  - match: { _source.ip_location.region_iso_code: "SE-E" }
  - match: { _source.ip_location.country_name: "Sweden" }
  - match: { _source.ip_location.region_name: "Östergötland County" }
  - match: { _source.ip_location.continent_name: "Europe" }

---
"Test ip_location processor with a config directory database":
  - do:
      ingest.put_pipeline:
        id: "my_pipeline_2"
        body:  >
          {
            "description": "_description",
            "processors": [
              {
                "ip_location" : {
                  "field" : "field1",
                  "database_file" : "asn.mmdb"
                }
              }
            ]
          }
  - match: { acknowledged: true }

  - do:
      index:
        index: test
        id: "1"
        pipeline: "my_pipeline_2"
        body: {field1: "5.104.168.0"}

  - do:
      get:
        index: test
        id: "1"
  - match: { _source.field1: "5.104.168.0" }
  - length: { _source.ip_location: 4 }
  - match: { _source.ip_location.organization_name: "Telehouse EAD" }
  - match: { _source.ip_location.asn: 57344 }
  - match: { _source.ip_location.ip: "5.104.168.0" }
  - match: { _source.ip_location.network: "5.104.168.0/23" }

---
"Test ip_location processor with flexible field access mode":
  - skip:
      features: [ "flexible_field_access_pattern" ]
      reason: "Flexible field access pattern support required"
  - do:
      ingest.put_pipeline:
        id: "my_pipeline_flexible"
        body:  >
          {
            "description": "Test flexible field access mode with dotted target field",
            "field_access_pattern": "flexible",
            "processors": [
              {
                "ip_location" : {
                  "field" : "ip",
                  "target_field" : "geo.location_data"
                }
              }
            ]
          }
  - match: { acknowledged: true }
  - do:
      index:
        index: test
        id: "1"
        pipeline: "my_pipeline_flexible"
        body: {ip: "89.160.20.128"}
  - do:
      get:
        index: test
        id: "1"
  - match: { _source.ip: "89.160.20.128" }
  # In flexible mode, fields are written as dotted keys, not nested objects
  - match: { _source.geo\.location_data\.city_name: "Linköping" }
  - match: { _source.geo\.location_data\.country_iso_code: "SE" }
  - match: { _source.geo\.location_data\.country_name: "Sweden" }
  - match: { _source.geo\.location_data\.continent_name: "Europe" }
  - match: { _source.geo\.location_data\.region_iso_code: "SE-E" }
  - match: { _source.geo\.location_data\.region_name: "Östergötland County" }
  # Location should be written as an array [lon, lat] in flexible mode
  - match: { _source.geo\.location_data\.location.0: 15.6167 }
  - match: { _source.geo\.location_data\.location.1: 58.4167 }
  # Verify that nested object was NOT created
  - is_false: _source.geo
---
"Test ip_location processor flexible mode with ASN database":
  - skip:
      features: [ "flexible_field_access_pattern" ]

      reason: "Flexible field access pattern support required"
  - do:
      ingest.put_pipeline:
        id: "my_pipeline_flexible_asn"
        body:  >
          {
            "description": "Test flexible mode with ASN database",
            "field_access_pattern": "flexible",
            "processors": [
              {
                "ip_location" : {
                  "field" : "source_ip",
                  "target_field" : "network.asn_info",
                  "database_file" : "asn.mmdb"
                }
              }
            ]
          }
  - match: { acknowledged: true }
  - do:
      index:
        index: test
        id: "1"
        pipeline: "my_pipeline_flexible_asn"
        body: {source_ip: "5.104.168.0"}
  - do:
      get:
        index: test
        id: "1"
  - match: { _source.source_ip: "5.104.168.0" }
  # In flexible mode, ASN fields are written as dotted keys
  - match: { _source.network\.asn_info\.ip: "5.104.168.0" }
  - match: { _source.network\.asn_info\.asn: 57344 }
  - match: { _source.network\.asn_info\.organization_name: "Telehouse EAD" }
  - match: { _source.network\.asn_info\.network: "5.104.168.0/23" }
  # Verify that nested object was NOT created
  - is_false: _source.network
---
"Test ip_location processor flexible mode with first_only":
  - skip:

      features: [ "flexible_field_access_pattern" ]
      reason: "Flexible field access pattern support required"
  - do:
      ingest.put_pipeline:
        id: "my_pipeline_flexible_first"
        body:  >
          {
            "description": "Test flexible mode with array and first_only",
            "field_access_pattern": "flexible",
            "processors": [
              {
                "ip_location" : {
                  "field" : "ips",
                  "target_field" : "geo.data",
                  "first_only" : true
                }
              }
            ]
          }
  - match: { acknowledged: true }
  - do:
      index:
        index: test
        id: "1"
        pipeline: "my_pipeline_flexible_first"
        body: {ips: ["127.0.0.1", "89.160.20.128"]}
  - do:
      get:
        index: test
        id: "1"
  - match: { _source.ips.0: "127.0.0.1" }
  - match: { _source.ips.1: "89.160.20.128" }
  # Only the first valid IP should be processed
  - match: { _source.geo\.data\.city_name: "Linköping" }
  - match: { _source.geo\.data\.country_iso_code: "SE" }
  - match: { _source.geo\.data\.location.0: 15.6167 }
  - match: { _source.geo\.data\.location.1: 58.4167 }
---
"Test ip_location processor classic mode vs flexible mode comparison":
  - skip:

      features: [ "flexible_field_access_pattern" ]
      reason: "Flexible field access pattern support required"
  - do:
      ingest.put_pipeline:
        id: "classic_pipeline"
        body:  >
          {
            "description": "Classic mode creates nested objects",
            "processors": [
              {
                "ip_location" : {
                  "field" : "ip",
                  "target_field" : "geo.info"
                }
              }
            ]
          }
  - match: { acknowledged: true }
  - do:
      ingest.put_pipeline:
        id: "flexible_pipeline"
        body:  >
          {
            "description": "Flexible mode creates dotted fields",
            "field_access_pattern": "flexible",
            "processors": [
              {
                "ip_location" : {
                  "field" : "ip",
                  "target_field" : "geo.info"
                }
              }
            ]
          }
  - match: { acknowledged: true }
  - do:
      index:
        index: test
        id: "classic"
        pipeline: "classic_pipeline"
        body: {ip: "89.160.20.128"}
  - do:
      index:
        index: test
        id: "flexible"
        pipeline: "flexible_pipeline"
        body: {ip: "89.160.20.128"}
  - do:
      get:
        index: test
        id: "classic"
  # Classic mode creates nested objects
  - match: { _source.geo.info.city_name: "Linköping" }
  - match: { _source.geo.info.location.lon: 15.6167 }
  - do:
      get:
        index: test
        id: "flexible"
  # Flexible mode creates dotted fields
  - match: { _source.geo\.info\.city_name: "Linköping" }
  - match: { _source.geo\.info\.location.0: 15.6167 }
  - is_false: _source.geo

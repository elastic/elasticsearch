---
teardown:
  - do:
      streams.logs_disable: { }

---
"Check User Can't Use Restricted Params On Logs Endpoint":
  - do:
      streams.logs_enable: { }
  - is_true: acknowledged

  - do:
      streams.status: { }
  - is_true: logs.enabled

  - do:
      bulk:
        list_executed_pipelines: true
        body: |
          { "index": { "_index": "logs"} }
          { "foo": "bar" }
          { "index": { "_index": "not-logs" } }
          { "foo": "bar" }
  - match: { errors: true }
  - match: { items.0.index.status: 400 }
  - match: { items.0.index.error.type: "illegal_argument_exception" }
  - match: { items.0.index.error.reason: '/When\ writing\ to\ a\ stream\,\ only\ the\ following\ parameters\ are\ allowed\:\ \[.+\]\ however\ the\ following\ were\ used\:\ \[.+\]/' }
  - match: { items.1.index.status: 201 }

---
"Check User Can't Use Restricted Params On Logs Endpoint - Single Doc":
  - do:
      streams.logs_enable: { }
  - is_true: acknowledged

  - do:
      streams.status: { }
  - is_true: logs.enabled

  - do:
      index:
        require_alias: true
        index: logs
        body: { "foo": "bar" }
      catch: '/When writing to a stream, only the following parameters are allowed: \[.+\] however the following were used: \[.+\]/'

---
"Allowed Params Only - Bulk Should Succeed":
  - do:
      streams.logs_enable: { }
  - is_true: acknowledged

  - do:
      bulk:
        error_trace: true
        timeout: "1m"
        body: |
          { "index": { "_index": "logs"} }
          { "foo": "bar" }
  - match: { errors: false }
  - match: { items.0.index.status: 201 }

---
"Allowed Params Only - Single Doc Should Succeed":
  - do:
      streams.logs_enable: { }
  - is_true: acknowledged

  - do:
      index:
        index: logs
        error_trace: true
        timeout: "1m"
        body: |
          { "foo": "bar" }
  - match: { _index: "logs" }
  - match: { result: "created" }

---
"Allowed Params Only - Single Doc with ID Should Succeed":
  - do:
      streams.logs_enable: { }
  - is_true: acknowledged

  - do:
      index:
        index: logs
        id: 123456
        body: |
          { "foo": "bar" }
  - match: { _index: "logs" }
  - match: { result: "created" }

---
"Allowed Params Only - Bulk with serverlessRequest Should Succeed":
  - do:
      streams.logs_enable: { }
  - is_true: acknowledged

  - do:
      bulk:
        serverlessRequest: true
        body: |
          { "index": { "_index": "logs"} }
          { "foo": "bar" }
  - match: { errors: false }
  - match: { items.0.index.status: 201 }

---
"Allowed Params Only - Bulk with operatorRequest Should Succeed":
  - do:
      streams.logs_enable: { }
  - is_true: acknowledged

  - do:
      bulk:
        operatorRequest: true
        body: |
          { "index": { "_index": "logs"} }
          { "foo": "bar" }
  - match: { errors: false }
  - match: { items.0.index.status: 201 }

---
"Allowed Params Only - Single Doc with serverlessRequest Should Succeed":
  - do:
      streams.logs_enable: { }
  - is_true: acknowledged

  - do:
      index:
        index: logs
        serverlessRequest: true
        body: |
          { "foo": "bar" }
  - match: { _index: "logs" }
  - match: { result: "created" }

---
"Allowed Params Only - Single Doc with operatorRequest Should Succeed":
  - do:
      streams.logs_enable: { }
  - is_true: acknowledged

  - do:
      index:
        index: logs
        operatorRequest: true
        body: |
          { "foo": "bar" }
  - match: { _index: "logs" }
  - match: { result: "created" }

---
"No Params - Bulk Should Succeed":
  - do:
      streams.logs_enable: { }
  - is_true: acknowledged

  - do:
      bulk:
        body: |
          { "index": { "_index": "logs"} }
          { "foo": "bar" }
  - match: { errors: false }
  - match: { items.0.index.status: 201 }

---
"No Params - Single Doc Should Succeed":
  - do:
      streams.logs_enable: { }
  - is_true: acknowledged
  -
    do:
      index:
        index: logs
        body: { "foo": "bar" }
  - match: { _index: "logs" }
  - match: { result: "created" }

---
"Mixed Allowed and Disallowed Params - Bulk Should Fail":
  - do:
      streams.logs_enable: { }
  - is_true: acknowledged

  - do:
      bulk:
        error_trace: true
        timeout: "1m"
        routing: "custom-routing"
        refresh: true
        body: |
          { "index": { "_index": "logs"} }
          { "foo": "bar" }
  - match: { errors: true }
  - match: { items.0.index.status: 400 }
  - match: { items.0.index.error.type: "illegal_argument_exception" }
  - match: { items.0.index.error.reason: '/When\ writing\ to\ a\ stream\,\ only\ the\ following\ parameters\ are\ allowed\:\ \[.+\]\ however\ the\ following\ were\ used\:\ \[.+\]/' }

---
"Mixed Allowed and Disallowed Params - Single Doc Should Fail":
  - do:
      streams.logs_enable: { }
  - is_true: acknowledged

  - do:
      index:
        index: logs
        error_trace: true
        timeout: "1m"
        routing: "custom-routing"
        refresh: true
        body: { "foo": "bar" }
      catch: '/When writing to a stream, only the following parameters are allowed: \[.+\] however the following were used: \[.+\]/'

---
"Multiple Disallowed Params - Bulk Should Fail":
  - do:
      streams.logs_enable: { }
  - is_true: acknowledged

  - do:
      bulk:
        routing: "custom-routing"
        wait_for_active_shards: "2"
        refresh: true
        body: |
          { "index": { "_index": "logs"} }
          { "foo": "bar" }
  - match: { errors: true }
  - match: { items.0.index.status: 400 }
  - match: { items.0.index.error.type: "illegal_argument_exception" }
  - match: { items.0.index.error.reason: '/When\ writing\ to\ a\ stream\,\ only\ the\ following\ parameters\ are\ allowed\:\ \[.+\]\ however\ the\ following\ were\ used\:\ \[.+\]/' }

---
"Multiple Disallowed Params - Single Doc Should Fail":
  - do:
      streams.logs_enable: { }
  - is_true: acknowledged

  - do:
      index:
        index: logs
        routing: "custom-routing"
        pipeline: "my-pipeline"
        wait_for_active_shards: "2"
        refresh: true
        body: { "foo": "bar" }
      catch: '/When writing to a stream, only the following parameters are allowed: \[.+\] however the following were used: \[.+\]/'

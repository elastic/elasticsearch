/*
 * Licensed to Elasticsearch under one or more contributor
 * license agreements. See the NOTICE file distributed with
 * this work for additional information regarding copyright
 * ownership. Elasticsearch licenses this file to you under
 * the Apache License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */

esplugin {
  description 'The Azure ARM Discovery plugin allows to use Azure Resources Management API for the unicast discovery mechanism'
  classname 'org.elasticsearch.discovery.azure.arm.AzureArmDiscoveryPlugin'
}

versions << [
  'azure': '1.13.0',
  'azure_annotations': '1.7.0',
  'azure_auth': '1.5.4',
  'okhttp3': '3.4.2',
  'retrofit': '2.1.0'
]

dependencies {
  // TODO should we declare jackson version ${versions.jackson} instead? but warning we have a 2.8.x in global settings
  // Note that there is a bug to be reported at MS Azure project as they are not using a consistent version
  compile "com.fasterxml.jackson.core:jackson-annotations:2.7.0"
  // Azure is using JACKSON 2.6.0 but we have 2.8.10 which is causing kind of conflict
  // compile "com.fasterxml.jackson.core:jackson-core:2.6.0"
  compile "com.fasterxml.jackson.core:jackson-databind:2.7.2"
  compile "com.fasterxml.jackson.datatype:jackson-datatype-joda:2.7.2"
  compile "com.google.code.gson:gson:2.2.4"
  compile "com.google.guava:guava:20.0"
  compile "com.microsoft.azure:adal4j:1.1.2"
  compile "com.microsoft.azure:azure-annotations:${versions.azure_annotations}"
  compile "com.microsoft.azure:azure-client-authentication:${versions.azure_auth}"
  compile "com.microsoft.azure:azure-client-runtime:${versions.azure_auth}"
  compile "com.microsoft.azure:azure-keyvault-core:0.8.0"
  compile "com.microsoft.azure:azure-mgmt-compute:${versions.azure}"
  compile "com.microsoft.azure:azure-mgmt-graph-rbac:${versions.azure}"
  compile "com.microsoft.azure:azure-mgmt-network:${versions.azure}"
  compile "com.microsoft.azure:azure-mgmt-resources:${versions.azure}"
  compile "com.microsoft.azure:azure-mgmt-storage:${versions.azure}"
  compile "com.microsoft.azure:azure-storage:4.4.0"
  compile "com.microsoft.azure:azure:${versions.azure}"
  compile "com.microsoft.rest:client-runtime:${versions.azure_auth}"
  compile "com.nimbusds:lang-tag:1.4"
  compile "com.nimbusds:nimbus-jose-jwt:3.1.2"
  compile "com.nimbusds:oauth2-oidc-sdk:4.5"
  compile "com.squareup.okhttp3:logging-interceptor:${versions.okhttp3}"
  compile "com.squareup.okhttp3:okhttp-urlconnection:${versions.okhttp3}"
  compile "com.squareup.okhttp3:okhttp:${versions.okhttp3}"
  compile "com.squareup.okio:okio:1.9.0"
  compile "com.squareup.retrofit2:adapter-rxjava:${versions.retrofit}"
  compile "com.squareup.retrofit2:converter-jackson:${versions.retrofit}"
  compile "com.squareup.retrofit2:retrofit:${versions.retrofit}"
  compile "commons-codec:commons-codec:1.10"
  compile "io.reactivex:rxjava:1.2.4"
  compile "javax.mail:mail:1.4.7"
  // Azure is using JODA 2.1 but we have 2.9.5 which is causing kind of conflict
  // compile "joda-time:joda-time:2.1"
  compile "net.jcip:jcip-annotations:1.0"
  compile "net.minidev:json-smart:1.1.1"
  compile "org.apache.commons:commons-lang3:3.4"
  compile "org.apache.httpcomponents:httpcore:4.4.5"
  compile "org.bouncycastle:bcprov-jdk15on:1.51"
  // TODO should we declare slf4j version ${versions.slf4j} instead? but warning we have a 1.6.2 in global settings
  compile "org.slf4j:slf4j-api:1.7.22"
  compile "org.slf4j:slf4j-simple:1.7.5"
}

dependencyLicenses {
  mapping from: /adal4j.*/, to: 'azure'
  mapping from: /azure-.*/, to: 'azure'
  mapping from: /client-runtime.*/, to: 'azure'
  mapping from: /api-annotations.*/, to: 'azure'
  mapping from: /okhttp-.*/, to: 'okhttp'
  mapping from: /logging-interceptor.*/, to: 'okhttp'
  mapping from: /adapter-rxjava.*/, to: 'retrofit'
  mapping from: /converter-jackson.*/, to: 'retrofit'
  mapping from: /jackson-.*/, to: 'jackson'
  mapping from: /nimbus-jose-jwt.*/, to: 'nimbus'
  mapping from: /oauth2-oidc-sdk.*/, to: 'nimbus'
  mapping from: /slf4j.*/, to: 'slf4j'
}

thirdPartyAudit {
  ignoreMissingClasses (
          // Classes are missing
          'android.os.Build$VERSION',
          'android.os.Handler',
          'android.os.Looper',
          'android.util.Log',
          'com.microsoft.azure.management.appservice.WebApps',
          'com.microsoft.azure.management.appservice.implementation.AppServiceManager',
          'com.microsoft.azure.management.batch.BatchAccounts',
          'com.microsoft.azure.management.batch.implementation.BatchManager',
          'com.microsoft.azure.management.batchai.BatchAIUsages',
          'com.microsoft.azure.management.batchai.BatchAIWorkspaces',
          'com.microsoft.azure.management.batchai.implementation.BatchAIManager',
          'com.microsoft.azure.management.cdn.CdnProfiles',
          'com.microsoft.azure.management.cdn.implementation.CdnManager',
          'com.microsoft.azure.management.containerinstance.ContainerGroups',
          'com.microsoft.azure.management.containerinstance.implementation.ContainerInstanceManager',
          'com.microsoft.azure.management.containerregistry.Registries',
          'com.microsoft.azure.management.containerregistry.implementation.ContainerRegistryManager',
          'com.microsoft.azure.management.containerservice.ContainerServices',
          'com.microsoft.azure.management.containerservice.KubernetesClusters',
          'com.microsoft.azure.management.containerservice.implementation.ContainerServiceManager',
          'com.microsoft.azure.management.cosmosdb.CosmosDBAccounts',
          'com.microsoft.azure.management.cosmosdb.implementation.CosmosDBManager',
          'com.microsoft.azure.management.dns.DnsZones',
          'com.microsoft.azure.management.dns.implementation.DnsZoneManager',
          'com.microsoft.azure.management.eventhub.EventHubDisasterRecoveryPairings',
          'com.microsoft.azure.management.eventhub.EventHubNamespaces',
          'com.microsoft.azure.management.eventhub.EventHubs',
          'com.microsoft.azure.management.eventhub.implementation.EventHubManager',
          'com.microsoft.azure.management.keyvault.Vaults',
          'com.microsoft.azure.management.keyvault.implementation.KeyVaultManager',
          'com.microsoft.azure.management.locks.ManagementLocks',
          'com.microsoft.azure.management.locks.implementation.AuthorizationManager',
          'com.microsoft.azure.management.monitor.ActionGroups',
          'com.microsoft.azure.management.monitor.ActivityLogs',
          'com.microsoft.azure.management.monitor.DiagnosticSettings',
          'com.microsoft.azure.management.monitor.MetricDefinitions',
          'com.microsoft.azure.management.monitor.implementation.MonitorManager',
          'com.microsoft.azure.management.msi.Identities',
          'com.microsoft.azure.management.msi.Identity',
          'com.microsoft.azure.management.msi.implementation.MSIManager',
          'com.microsoft.azure.management.redis.RedisCaches',
          'com.microsoft.azure.management.redis.implementation.RedisManager',
          'com.microsoft.azure.management.search.SearchServices',
          'com.microsoft.azure.management.search.implementation.SearchServiceManager',
          'com.microsoft.azure.management.servicebus.ServiceBusNamespaces',
          'com.microsoft.azure.management.servicebus.implementation.ServiceBusManager',
          'com.microsoft.azure.management.sql.SqlServers',
          'com.microsoft.azure.management.sql.implementation.SqlServerManager',
          'com.microsoft.azure.management.trafficmanager.TrafficManagerProfiles',
          'com.microsoft.azure.management.trafficmanager.implementation.TrafficManager',
          'javax.servlet.http.HttpServletRequest',
          'javax.servlet.http.HttpServletResponse',
          'rx.Completable$CompletableOnSubscribe',
          'rx.Completable$CompletableSubscriber')

  ignoreViolations(
          // sun.misc.Unsafe usage
          'com.google.common.cache.Striped64$1',
          'com.google.common.cache.Striped64',
          'com.google.common.cache.Striped64$Cell',
          'com.google.common.primitives.UnsignedBytes$LexicographicalComparatorHolder$UnsafeComparator',
          'com.google.common.primitives.UnsignedBytes$LexicographicalComparatorHolder$UnsafeComparator$1',
          'com.google.common.hash.LittleEndianByteArray$UnsafeByteArray$1',
          'com.google.common.hash.LittleEndianByteArray$UnsafeByteArray$2',
          'com.google.common.hash.LittleEndianByteArray$UnsafeByteArray$3',
          'com.google.common.hash.LittleEndianByteArray$UnsafeByteArray',
          'com.google.common.util.concurrent.AbstractFuture$UnsafeAtomicHelper$1',
          'com.google.common.util.concurrent.AbstractFuture$UnsafeAtomicHelper',
          'rx.internal.util.unsafe.BaseLinkedQueueConsumerNodeRef',
          'rx.internal.util.unsafe.BaseLinkedQueueProducerNodeRef',
          'rx.internal.util.unsafe.ConcurrentCircularArrayQueue',
          'rx.internal.util.unsafe.ConcurrentSequencedCircularArrayQueue',
          'rx.internal.util.unsafe.MpmcArrayQueueConsumerField',
          'rx.internal.util.unsafe.MpmcArrayQueueProducerField',
          'rx.internal.util.unsafe.MpscLinkedQueue',
          'rx.internal.util.unsafe.SpmcArrayQueueConsumerField',
          'rx.internal.util.unsafe.SpmcArrayQueueProducerField',
          'rx.internal.util.unsafe.MpscLinkedQueue',
          'rx.internal.util.unsafe.SpmcArrayQueueConsumerField',
          'rx.internal.util.unsafe.SpmcArrayQueueProducerField',
          'rx.internal.util.unsafe.SpscArrayQueue',
          'rx.internal.util.unsafe.SpscUnboundedArrayQueue',
          'rx.internal.util.unsafe.UnsafeAccess'
  )
}

if (JavaVersion.current() > JavaVersion.VERSION_1_8) {
  // jarhell with jdk (intentionally, because jaxb was removed from default modules in java 9)
  thirdPartyAudit.ignoreMissingClasses (
          'javax.activation.ActivationDataFlavor',
          'javax.activation.DataContentHandler',
          'javax.activation.DataHandler',
          'javax.activation.DataSource',
          'javax.activation.FileDataSource',
          'javax.activation.FileTypeMap'
  )
}

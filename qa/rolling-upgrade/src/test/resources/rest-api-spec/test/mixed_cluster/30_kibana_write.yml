---
setup:
  - do:
      cluster.health:
        wait_for_status: yellow
        wait_for_nodes: 2

  - do:
      update:
        index: ".security"
        type: "reserved-user"
        id: "kibana"
        refresh: true
        body:
          doc: { enabled: true, password: "" }
          doc_as_upsert : true
  - do:
      xpack.security.clear_cached_realms:
        realms: "_all"
---
teardown:
  - do:
      update:
        index: ".security"
        type: "reserved-user"
        id: "kibana"
        refresh: true
        body: >
          {
            "doc": {
              "enabled": false,
              "password": ""
            }
          }
  - do:
      xpack.security.clear_cached_realms:
        realms: "_all"
---
"Verify kibana user role works in mixed cluster":
  - do:
      headers:
        Authorization: "Basic a2liYW5hOmNoYW5nZW1l"
      cluster.health:
        wait_for_status: yellow
        wait_for_nodes: 2
  - match: { timed_out: false }

  - do:
     headers:
       Authorization: "Basic a2liYW5hOmNoYW5nZW1l"
     indices.create:
       index: .kibana-foo

  - do:
     headers:
       Authorization: "Basic a2liYW5hOmNoYW5nZW1l"
     bulk:
       refresh: true
       body:
         - '{"index": {"_index": ".kibana-foo", "_type": "test_type"}}'
         - '{"f1": "v1_old", "f2": 0}'
         - '{"index": {"_index": ".kibana-foo", "_type": "test_type"}}'
         - '{"f1": "v2_old", "f2": 1}'
         - '{"index": {"_index": ".kibana-foo", "_type": "test_type"}}'
         - '{"f1": "v3_old", "f2": 2}'
         - '{"index": {"_index": ".kibana-foo", "_type": "test_type"}}'
         - '{"f1": "v4_old", "f2": 3}'
         - '{"index": {"_index": ".kibana-foo", "_type": "test_type"}}'
         - '{"f1": "v5_old", "f2": 4}'

  - do:
     headers:
       Authorization: "Basic a2liYW5hOmNoYW5nZW1l"
     indices.flush:
        index: .kibana-foo

  - do:
     headers:
       Authorization: "Basic a2liYW5hOmNoYW5nZW1l"
     search:
       index: .kibana-foo

  - match: { hits.total: 5 }

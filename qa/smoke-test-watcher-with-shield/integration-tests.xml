<?xml version="1.0"?>
<!--
  ~ ELASTICSEARCH CONFIDENTIAL
  ~ __________________
  ~
  ~  [2014] Elasticsearch Incorporated. All Rights Reserved.
  ~
  ~ NOTICE:  All information contained herein is, and remains
  ~ the property of Elasticsearch Incorporated and its suppliers,
  ~ if any.  The intellectual and technical concepts contained
  ~ herein are proprietary to Elasticsearch Incorporated
  ~ and its suppliers and may be covered by U.S. and Foreign Patents,
  ~ patents in process, and are protected by trade secret or copyright law.
  ~ Dissemination of this information or reproduction of this material
  ~ is strictly forbidden unless prior written permission is obtained
  ~ from Elasticsearch Incorporated.
  -->

<project name="smoke-test-watcher-and-shield"
         xmlns:ac="antlib:net.sf.antcontrib">

  <import file="${elasticsearch.integ.antfile.default}"/>

  <!-- redefined to work with auth -->
  <macrodef name="waitfor-elasticsearch">
      <attribute name="port"/>
      <attribute name="timeoutproperty"/>
    <sequential>
      <echo>Waiting for elasticsearch to become available on port @{port}...</echo>
      <waitfor maxwait="30" maxwaitunit="second"
               checkevery="500" checkeveryunit="millisecond"
               timeoutproperty="@{timeoutproperty}">
        <socket server="127.0.0.1" port="@{port}"/>
      </waitfor>
    </sequential>
  </macrodef>

  <!-- FIXME remove this redefinition and fix in core -->
  <macrodef name="startup-elasticsearch">
    <attribute name="home" default="${integ.scratch}/elasticsearch-${elasticsearch.version}"/>
    <attribute name="spawn" default="true"/>
    <attribute name="args" default="${integ.args}"/>
    <attribute name="es.unicast.enabled" default="false"/>
    <attribute name="es.unicast.hosts" default=""/>
    <attribute name="es.cluster.name" default="${integ.cluster.name}"/>
    <attribute name="es.http.port" default="${integ.http.port}"/>
    <attribute name="es.transport.tcp.port" default="${integ.transport.port}"/>
    <attribute name="es.pidfile" default="${integ.pidfile}"/>
    <attribute name="jvm.args" default="${tests.jvm.argline}"/>
    <element name="nestedA" optional="true"/>
    <sequential>
      <!-- run bin/elasticsearch with args -->
      <echo>Starting up external cluster...</echo>

      <run-script script="@{home}/bin/elasticsearch"
                  spawn="@{spawn}">
        <nested>
          <env key="JAVA_HOME" value="${java.home}"/>
          <!-- we pass these as gc options, even if they arent, to avoid conflicting gc options -->
          <env key="ES_GC_OPTS" value="@{jvm.args}"/>
          <arg value="-Des.cluster.name=@{es.cluster.name}"/>
          <arg value="-Des.http.port=@{es.http.port}"/>
          <arg value="-Des.transport.tcp.port=@{es.transport.tcp.port}"/>
          <arg value="-Des.pidfile=@{es.pidfile}"/>
          <arg value="-Des.discovery.zen.ping.unicast.enabled=@{es.unicast.enabled}"/>
          <arg value="-Des.discovery.zen.ping.unicast.hosts=@{es.unicast.hosts}"/>
          <arg value="-Des.path.repo=@{home}/repo"/>
          <arg value="-Des.discovery.zen.ping.multicast.enabled=false"/>
          <arg value="-Des.script.inline=on"/>
          <arg value="-Des.script.indexed=on"/>
          <arg value="-Des.repositories.url.allowed_urls=http://snapshot.test*"/>
          <arg value="-Des.http.cors.enabled=true"/>
          <arg value="-Des.http.cors.allow-origin=*"/>
          <nestedA/>
        </nested>
      </run-script>

      <!-- wait for startup -->
      <local name="failed.to.start"/>
      <waitfor-elasticsearch port="@{es.http.port}"
                             timeoutproperty="failed.to.start"/>

      <!-- best effort, print console log. useful if it fails especially -->
      <local name="log.contents"/>
      <loadfile srcFile="@{home}/logs/@{es.cluster.name}.log"
                property="log.contents"
                failonerror="false"/>
      <echo message="${log.contents}" taskname="elasticsearch"/>

      <fail message="ES instance did not start" if="failed.to.start"/>

      <local name="integ.pid"/>
      <extract-pid file="@{es.pidfile}" property="integ.pid"/>
      <echo>External node started PID ${integ.pid}</echo>
    </sequential>
  </macrodef>

  <target name="start-external-cluster-with-watcher-and-shield" depends="setup-workspace">
    <ac:for list="${xplugins.list}" param="xplugin.name">
      <sequential>
        <fail message="Expected @{xplugin.name}-${version}.zip as a dependency, but could not be found in ${integ.deps}/plugins}">
          <condition>
            <not>
              <available file="${integ.deps}/plugins/@{xplugin.name}-${elasticsearch.version}.zip" />
            </not>
          </condition>
        </fail>
      </sequential>
    </ac:for>

    <ac:for param="file">
      <path>
        <fileset dir="${integ.deps}/plugins"/>
      </path>
      <sequential>
        <local name="plugin.name"/>
        <convert-plugin-name file="@{file}" outputproperty="plugin.name"/>
        <install-plugin name="${plugin.name}" file="@{file}"/>
      </sequential>
    </ac:for>

    <local name="home"/>
    <property name="home" location="${integ.scratch}/elasticsearch-${elasticsearch.version}"/>

    <echo>Adding roles.yml with watcher roles</echo>
    <copy file="watcher-with-shield-roles.yml" tofile="${home}/config/shield/roles.yml" overwrite="true"/>

    <echo>Adding shield users...</echo>
    <run-script script="${home}/bin/shield/esusers">
      <nested>
        <arg value="useradd"/>
        <arg value="test_admin"/>
        <arg value="-p"/>
        <arg value="changeme"/>
        <arg value="-r"/>
        <arg value="admin"/>
      </nested>
    </run-script>
    <run-script script="${home}/bin/shield/esusers">
      <nested>
        <arg value="useradd"/>
        <arg value="watcher_manager"/>
        <arg value="-p"/>
        <arg value="changeme"/>
        <arg value="-r"/>
        <arg value="watcher_manager"/>
      </nested>
    </run-script>
    <run-script script="${home}/bin/shield/esusers">
      <nested>
        <arg value="useradd"/>
        <arg value="powerless_user"/>
        <arg value="-p"/>
        <arg value="changeme"/>
        <arg value="-r"/>
        <arg value="crapy_role"/>
      </nested>
    </run-script>

    <startup-elasticsearch />

    <echo>Checking we can connect with basic auth on port ${integ.http.port}...</echo>
    <local name="temp.file"/>
    <tempfile property="temp.file" destdir="${java.io.tmpdir}"/>
    <get src="http://127.0.0.1:${integ.http.port}" dest="${temp.file}" 
         username="test_admin" password="changeme" verbose="true" retries="10"/>
  </target>
</project>

---
"Discovery stats":
  - skip:
      version:     " - 6.99.99"
      reason:      "published_cluster_states_received is not (yet) in 6.x"
  - do:
      cluster.state: {}

  # Get master node id
  - set: { master_node: master }

  - do:
      nodes.stats:
        metric: [ discovery ]

  - is_true: cluster_name
  - is_true: nodes
  - is_true: nodes.$master.name
  - is_false: nodes.$master.jvm
  - is_true:  nodes.$master.discovery
  - is_true:  nodes.$master.discovery.cluster_state_queue
  - is_true:  nodes.$master.discovery.published_cluster_states_received
  - gte: { nodes.$master.discovery.published_cluster_states_received.full_cluster_states: 0 }
  - gte: { nodes.$master.discovery.published_cluster_states_received.incompatible_cluster_state_diffs: 0 }
  - gte: { nodes.$master.discovery.published_cluster_states_received.compatible_cluster_state_diffs: 0 }
  - is_true:  nodes.$master.roles

  - do:
      nodes.stats:
        filter_path: "nodes.*.discovery"

  - is_false: cluster_name
  - is_true:  nodes
  - is_false: nodes.$master.name
  - is_false: nodes.$master.jvm
  - is_true:  nodes.$master.discovery
  - is_true:  nodes.$master.discovery.cluster_state_queue
  - is_true:  nodes.$master.discovery.published_cluster_states_received
  - gte: { nodes.$master.discovery.published_cluster_states_received.full_cluster_states: 0 }
  - gte: { nodes.$master.discovery.published_cluster_states_received.incompatible_cluster_state_diffs: 0 }
  - gte: { nodes.$master.discovery.published_cluster_states_received.compatible_cluster_state_diffs: 0 }
  - is_false:  nodes.$master.roles

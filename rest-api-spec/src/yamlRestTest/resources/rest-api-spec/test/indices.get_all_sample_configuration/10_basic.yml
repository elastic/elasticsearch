---
setup:
  - requires:
      cluster_features: [ "random_sampling" ]
      reason: requires feature 'random_sampling' to get random samples

---
teardown:
  - do:
      indices.delete:
        index: "*test*"
        ignore_unavailable: true
        allow_no_indices: true

---
"Get all sampling configurations with no configurations":
  - do:
      indices.create:
        index: test-no-config-index-1

  - do:
      indices.create:
        index: test-no-config-index-2

  - do:
      indices.get_all_sample_configuration: {}

  # Should return an empty array
  - length: { configurations: 0 }

---
"Get all sampling configurations with single configuration":
  - do:
      indices.create:
        index: test-single-config-index

  - do:
      indices.put_sample_configuration:
        index: test-single-config-index
        body:
          rate: 0.5
          max_samples: 100
          max_size: "100kb"
          time_to_live: "1h"

  - match: { acknowledged: true }

  - do:
      indices.get_all_sample_configuration:
        human: true

  - length: { configurations: 1 }
  - match: { configurations.0.index: "test-single-config-index" }
  - match: { configurations.0.configuration.rate: 0.5 }
  - match: { configurations.0.configuration.max_samples: 100 }
  - match: { configurations.0.configuration.max_size: "100kb" }
  - match: { configurations.0.configuration.time_to_live: "1h" }

---
"Get all sampling configurations with multiple configurations":
  - do:
      indices.create:
        index: test-multi-config-index-1

  - do:
      indices.create:
        index: test-multi-config-index-2

  - do:
      indices.create:
        index: test-multi-config-index-3

  - do:
      indices.put_sample_configuration:
        index: test-multi-config-index-1
        body:
          rate: 0.3
          max_samples: 50

  - match: { acknowledged: true }

  - do:
      indices.put_sample_configuration:
        index: test-multi-config-index-2
        body:
          rate: 0.7
          max_samples: 200
          max_size: "100kb"

  - match: { acknowledged: true }

  - do:
      indices.put_sample_configuration:
        index: test-multi-config-index-3
        body:
          rate: 1.0
          if: "ctx?.field == 'sample_me'"

  - match: { acknowledged: true }

  - do:
      indices.get_all_sample_configuration:
        human: true

  - length: { configurations: 3 }
  # Note: Array order may vary, so we just verify all 3 configurations exist
  - is_true: configurations.0.index
  - is_true: configurations.0.configuration
  - is_true: configurations.1.index
  - is_true: configurations.1.configuration
  - is_true: configurations.2.index
  - is_true: configurations.2.configuration

---
"Get all sampling configurations with mixed indices":
  - do:
      indices.create:
        index: test-mixed-configured-1

  - do:
      indices.create:
        index: test-mixed-unconfigured

  - do:
      indices.create:
        index: test-mixed-configured-2

  - do:
      indices.put_sample_configuration:
        index: test-mixed-configured-1
        body:
          rate: 0.4
          max_samples: 75

  - match: { acknowledged: true }

  - do:
      indices.put_sample_configuration:
        index: test-mixed-configured-2
        body:
          rate: 0.6
          time_to_live: "2h"

  - match: { acknowledged: true }

  - do:
      indices.get_all_sample_configuration:
        human: true

  # Should only return configured indices (2 items)
  - length: { configurations: 2 }
  - is_true: configurations.0.index
  - is_true: configurations.0.configuration
  - is_true: configurations.1.index
  - is_true: configurations.1.configuration

---
"Get all sampling configurations after update":
  - do:
      indices.create:
        index: test-update-all-index

  # Set initial configuration
  - do:
      indices.put_sample_configuration:
        index: test-update-all-index
        body:
          rate: 0.2
          max_samples: 30

  - match: { acknowledged: true }

  - do:
      indices.get_all_sample_configuration:
        human: true

  - length: { configurations: 1 }
  - match: { configurations.0.index: "test-update-all-index" }
  - match: { configurations.0.configuration.rate: 0.2 }
  - match: { configurations.0.configuration.max_samples: 30 }

  # Update configuration
  - do:
      indices.put_sample_configuration:
        index: test-update-all-index
        body:
          rate: 0.9
          max_samples: 150
          max_size: "100kb"

  - match: { acknowledged: true }

  # Verify updated configuration in get all
  - do:
      indices.get_all_sample_configuration:
        human: true

  - length: { configurations: 1 }
  - match: { configurations.0.index: "test-update-all-index" }
  - match: { configurations.0.configuration.rate: 0.9 }
  - match: { configurations.0.configuration.max_samples: 150 }
  - match: { configurations.0.configuration.max_size: "100kb" }

---
"Get all sampling configurations after deletion":
  - do:
      indices.create:
        index: test-delete-all-index-1

  - do:
      indices.create:
        index: test-delete-all-index-2

  - do:
      indices.put_sample_configuration:
        index: test-delete-all-index-1
        body:
          rate: 0.5
          max_samples: 100

  - match: { acknowledged: true }

  - do:
      indices.put_sample_configuration:
        index: test-delete-all-index-2
        body:
          rate: 0.8
          max_samples: 200

  - match: { acknowledged: true }

  # Verify both configurations exist
  - do:
      indices.get_all_sample_configuration:
        human: true

  - length: { configurations: 2 }

  # Delete one configuration
  - do:
      indices.delete_sample_configuration:
        index: test-delete-all-index-1

  - match: { acknowledged: true }

  # Verify only one configuration remains
  - do:
      indices.get_all_sample_configuration:
        human: true

  - length: { configurations: 1 }
  - match: { configurations.0.index: "test-delete-all-index-2" }
  - match: { configurations.0.configuration.rate: 0.8 }
  - match: { configurations.0.configuration.max_samples: 200 }

# To run this test via the command line:
# ./gradlew ":rest-api-spec:yamlRestTest" --tests org.elasticsearch.test.rest.ClientYamlTestSuiteIT -Dtests.method="test {yaml=search.retrievers/result-diversification/10_mmr_result_diversification_retriever/*}"
setup:
  - requires:
      cluster_features: [ "retriever.result_diversification_mmr" ]
      reason: "Added retriever for result diversification using MMR"

  - requires:
      test_runner_features:
        - contains
        - headers

  - do:
      indices.create:
        index: test-result-diversification-index
        body:
          settings:
            number_of_shards: 1
          mappings:
            properties:
              textbody:
                type: text
              keywordfield:
                type: keyword
              textvector:
                type: dense_vector
                dims: 4

  - do:
      indices.create:
        index: test-result-diversification-index-other
        body:
          settings:
            number_of_shards: 1
          mappings:
            properties:
              textbody:
                type: text
              keywordfield:
                type: keyword
              textvector:
                type: dense_vector
                dims: 4

  - do:
      indices.create:
        index: test-result-byte-diversification-index
        body:
          settings:
            number_of_shards: 1
          mappings:
            properties:
              textbody:
                type: text
              keywordfield:
                type: keyword
              textvector:
                type: dense_vector
                dims: 16
                element_type: bit

  - do:
      headers:
        Content-Type: application/json
      bulk:
        index: test-result-diversification-index
        refresh: true
        body: |
          {"index":{}}
          {"textbody": "first text", "textvector": [0.4, 0.2, 0.4, 0.4], "keywordfield": "test1"}
          {"index":{}}
          {"textbody": "second text", "textvector": [0.4, 0.2, 0.3, 0.3], "keywordfield": "test2"}
          {"index":{}}
          {"textbody": "second text duplicate", "textvector": [0.4, 0.2, 0.3, 0.3], "keywordfield": "test2_dup"}
          {"index":{}}
          {"textbody": "third text", "textvector": [0.4, 0.1, 0.3, 0.3], "keywordfield": "test3"}
          {"index":{}}
          {"textbody": "third text duplicate", "textvector": [0.4, 0.1, 0.3, 0.3], "keywordfield": "test3_dup"}
          {"index":{}}
          {"textbody": "fourth text", "textvector": [0.1, 0.9, 0.5, 0.9], "keywordfield": "test4"}
          {"index":{}}
          {"textbody": "fifth text", "textvector": [0.1, 0.9, 0.5, 0.9], "keywordfield": "test5"}
          {"index":{}}
          {"textbody": "sixth text", "textvector": [0.05, 0.05, 0.05, 0.05], "keywordfield": "test6"}

  - do:
      headers:
        Content-Type: application/json
      bulk:
        index: test-result-diversification-index-other
        refresh: true
        body: |
          {"index":{}}
          {"textbody": "first text other", "textvector": [0.4, 0.2, 0.4, 0.4], "keywordfield": "test1"}
          {"index":{}}
          {"textbody": "second text other", "textvector": [0.4, 0.2, 0.3, 0.3], "keywordfield": "test2"}
          {"index":{}}
          {"textbody": "second text duplicate other", "textvector": [0.4, 0.2, 0.3, 0.3], "keywordfield": "test2_dup"}
          {"index":{}}
          {"textbody": "third text other", "textvector": [0.4, 0.1, 0.3, 0.3], "keywordfield": "test3"}
          {"index":{}}
          {"textbody": "third text duplicate other", "textvector": [0.4, 0.1, 0.3, 0.3], "keywordfield": "test3_dup"}
          {"index":{}}
          {"textbody": "fourth text other", "textvector": [0.1, 0.9, 0.5, 0.9], "keywordfield": "test4"}
          {"index":{}}
          {"textbody": "fifth text other", "textvector": [0.1, 0.9, 0.5, 0.9], "keywordfield": "test5"}
          {"index":{}}
          {"textbody": "sixth text other", "textvector": [0.05, 0.05, 0.05, 0.05], "keywordfield": "test6"}

  - do:
      headers:
        Content-Type: application/json
      bulk:
        index: test-result-byte-diversification-index
        refresh: true
        body: |
          {"index":{}}
          {"textbody": "first text", "textvector": "0BB8", "keywordfield": "test1"}
          {"index":{}}
          {"textbody": "second text", "textvector": "94A2", "keywordfield": "test2"}
          {"index":{}}
          {"textbody": "second text duplicate", "textvector": "94A2", "keywordfield": "test2_dup"}
          {"index":{}}
          {"textbody": "third text", "textvector": "0560", "keywordfield": "test3"}
          {"index":{}}
          {"textbody": "third text duplicate", "textvector": "0560", "keywordfield": "test3_dup"}
          {"index":{}}
          {"textbody": "fourth text", "textvector": "2112", "keywordfield": "test4"}
          {"index":{}}
          {"textbody": "fifth text", "textvector": "5051", "keywordfield": "test5"}

---
teardown:
  - do:
      indices.delete:
        index: test-result-diversification-index
        ignore: 404

  - do:
      indices.refresh: { }

---
"Test MMR result diversification single index float type":
  - do:
      search:
        index: test-result-diversification-index
        body:
          retriever:
            knn:
              field: "textvector"
              query_vector: [ 0.5, 0.2, 0.4, 0.4 ]
              k: 10
              num_candidates: 10

  - match: { hits.total.value: 8 }
  - match: { hits.hits.0._source.textbody: "second text" }
  - match: { hits.hits.1._source.textbody: "second text duplicate" }
  - match: { hits.hits.2._source.textbody: "third text" }
  - match: { hits.hits.3._source.textbody: "third text duplicate" }
  - match: { hits.hits.4._source.textbody: "first text" }
  - match: { hits.hits.5._source.textbody: "sixth text" }
  - match: { hits.hits.6._source.textbody: "fourth text" }
  - match: { hits.hits.7._source.textbody: "fifth text" }

  - do:
      search:
        index: test-result-diversification-index
        body:
          retriever:
            diversify:
              type: "mmr"
              field: "textvector"
              lambda: 0.3
              rank_window_size: 10
              size: 3
              retriever:
                knn:
                  field: "textvector"
                  query_vector: [ 0.5, 0.2, 0.4, 0.4 ]
                  k: 10
                  num_candidates: 10

  - match: { hits.total.value: 8 }
  - length: { hits.hits: 3 }
  - match: { hits.hits.0._source.textbody: "second text" }
  - match: { hits.hits.1._source.textbody: "third text" }
  - match: { hits.hits.2._source.textbody: "sixth text" }

  - do:
      search:
        index: test-result-diversification-index
        body:
          retriever:
            diversify:
              type: "mmr"
              field: "textvector"
              lambda: 0.3
              rank_window_size: 10
              size: 3
              retriever:
                standard:
                  query:
                    match_all: { }

  - match: { hits.total.value: 8 }
  - length: { hits.hits: 3 }
  - match: { hits.hits.0._source.textbody: "first text" }
  - match: { hits.hits.1._source.textbody: "third text" }
  - match: { hits.hits.2._source.textbody: "sixth text" }

---
"Test MMR result diversification byte vector type":
  - do:
      search:
        index: test-result-byte-diversification-index
        body:
          retriever:
            standard:
              query:
                match_all: { }

  - match: { hits.total.value: 7 }
  - length: { hits.hits: 7 }
  - match: { hits.hits.0._source.textbody: "first text" }
  - match: { hits.hits.1._source.textbody: "second text" }
  - match: { hits.hits.2._source.textbody: "second text duplicate" }
  - match: { hits.hits.3._source.textbody: "third text" }
  - match: { hits.hits.4._source.textbody: "third text duplicate" }
  - match: { hits.hits.5._source.textbody: "fourth text" }
  - match: { hits.hits.6._source.textbody: "fifth text" }

  - do:
      search:
        index: test-result-byte-diversification-index
        body:
          retriever:
            diversify:
              type: "mmr"
              field: "textvector"
              lambda: 0.7
              rank_window_size: 10
              size: 3
              retriever:
                standard:
                  query:
                    match_all: { }

  - match: { hits.total.value: 7 }
  - length: { hits.hits: 3 }
  - match: { hits.hits.0._source.textbody: "first text" }
  - match: { hits.hits.1._source.textbody: "fourth text" }
  - match: { hits.hits.2._source.textbody: "fifth text" }

---
"Test MMR result diversification multiple indexes":
  - do:
      search:
        index: "test-result-diversification-index*"
        body:
          retriever:
            standard:
              query:
                match_all: { }

  - match: { hits.total.value: 16 }
  - length: { hits.hits: 10 }
  - match: { hits.hits.0._source.textbody: "first text" }
  - match: { hits.hits.1._source.textbody: "second text" }
  - match: { hits.hits.2._source.textbody: "second text duplicate" }
  - match: { hits.hits.3._source.textbody: "third text" }
  - match: { hits.hits.4._source.textbody: "third text duplicate" }
  - match: { hits.hits.5._source.textbody: "fourth text" }
  - match: { hits.hits.6._source.textbody: "fifth text" }
  - match: { hits.hits.7._source.textbody: "sixth text" }
  - match: { hits.hits.8._source.textbody: "first text other" }
  - match: { hits.hits.9._source.textbody: "second text other" }

  - do:
      search:
        index: "test-result-diversification-index*"
        body:
          retriever:
            diversify:
              type: "mmr"
              field: "textvector"
              lambda: 0.3
              rank_window_size: 10
              size: 3
              retriever:
                standard:
                  query:
                    match_all: { }

  - match: { hits.total.value: 16 }
  - length: { hits.hits: 3 }
  - match: { hits.hits.0._source.textbody: "third text" }
  - match: { hits.hits.1._source.textbody: "sixth text" }
  - match: { hits.hits.2._source.textbody: "first text other" }

---
"Test MMR result diversification required parameters":

  - do:
      catch: bad_request
      search:
        index: test-result-diversification-index
        body:
          retriever:
            diversify:
              type: "mmr"
              field: "textvector"
              lambda: 0.7
              size: 3
              retriever:
                knn:
                  field: "textvector"
                  query_vector: [ 0.5, 0.2, 0.4, 0.4 ]
                  k: 6
                  num_candidates: 6

  - match: { status: 400 }
  - match: { error.type: illegal_argument_exception }
  - match: { error.reason: "Required [rank_window_size]" }

  - do:
      catch: bad_request
      search:
        index: test-result-diversification-index
        body:
          retriever:
            diversify:
              type: "mmr"
              field: "textvector"
              lambda: 0.7
              rank_window_size: 10
              size: 3

  - match: { status: 400 }
  - match: { error.type: illegal_argument_exception }
  - match: { error.reason: "Required [retriever]" }

  - do:
      catch: bad_request
      search:
        index: test-result-diversification-index
        body:
          retriever:
            diversify:
              type: "mmr"
              field: "textvector"
              rank_window_size: 10
              size: 3
              retriever:
                knn:
                  field: "textvector"
                  query_vector: [ 0.5, 0.2, 0.4, 0.4 ]
                  k: 6
                  num_candidates: 6

  - match: { status: 400 }
  - match: { error.type: action_request_validation_exception }
  - match: { error.reason: "Validation Failed: 1: [diversify] MMR result diversification must have a [lambda] between 0.0 and 1.0;" }

  - do:
      catch: bad_request
      search:
        index: test-result-diversification-index
        body:
          retriever:
            diversify:
              type: "mmr"
              field: "textvector"
              lambda: -0.5
              rank_window_size: 10
              size: 3
              retriever:
                knn:
                  field: "textvector"
                  query_vector: [ 0.5, 0.2, 0.4, 0.4 ]
                  k: 6
                  num_candidates: 6

  - match: { status: 400 }
  - match: { error.type: action_request_validation_exception }
  - match: { error.reason: "Validation Failed: 1: [diversify] MMR result diversification must have a [lambda] between 0.0 and 1.0;" }

  - do:
      catch: bad_request
      search:
        index: test-result-diversification-index
        body:
          retriever:
            diversify:
              type: "mmr"
              field: "textvector"
              lambda: 1.5
              rank_window_size: 10
              size: 3
              retriever:
                knn:
                  field: "textvector"
                  query_vector: [ 0.5, 0.2, 0.4, 0.4 ]
                  k: 6
                  num_candidates: 6

  - match: { status: 400 }
  - match: { error.type: action_request_validation_exception }
  - match: { error.reason: "Validation Failed: 1: [diversify] MMR result diversification must have a [lambda] between 0.0 and 1.0;" }

---
"Test MMR result diversification required field type":

  - do:
      catch: bad_request
      search:
        index: test-result-diversification-index
        body:
          retriever:
            diversify:
              type: "mmr"
              field: "unknown_field"
              lambda: 0.7
              rank_window_size: 10
              size: 3
              retriever:
                knn:
                  field: "textvector"
                  query_vector: [ 0.5, 0.2, 0.4, 0.4 ]
                  k: 6
                  num_candidates: 6

  - match: { status: 400 }
  - match: { error.type: status_exception }
  - contains: { error.reason: "[diversify] search failed - retrievers '[diversify]'" }
  - match: { error.suppressed.0.type: status_exception }
  - match: { error.suppressed.0.reason: "Failed to retrieve vectors for field [unknown_field]. Is it a [dense_vector] field?" }

  - do:
      catch: bad_request
      search:
        index: test-result-diversification-index
        body:
          retriever:
            diversify:
              type: "mmr"
              field: "keywordfield"
              lambda: 0.7
              rank_window_size: 10
              size: 3
              retriever:
                knn:
                  field: "textvector"
                  query_vector: [ 0.5, 0.2, 0.4, 0.4 ]
                  k: 6
                  num_candidates: 6

  - match: { status: 400 }
  - match: { error.type: status_exception }
  - contains: { error.reason: "[diversify] search failed - retrievers '[diversify]'" }
  - match: { error.suppressed.0.type: status_exception }
  - match: { error.suppressed.0.reason: "Failed to retrieve vectors for field [keywordfield]. Is it a [dense_vector] field?" }

  - do:
      catch: bad_request
      search:
        index: test-result-diversification-index
        body:
          retriever:
            diversify:
              type: "mmr"
              field: "textbody"
              lambda: 0.7
              rank_window_size: 10
              size: 3
              retriever:
                knn:
                  field: "textvector"
                  query_vector: [ 0.5, 0.2, 0.4, 0.4 ]
                  k: 6
                  num_candidates: 6

  - match: { status: 400 }
  - match: { error.type: status_exception }
  - contains: { error.reason: "[diversify] search failed" }
  - match: { error.suppressed.0.type: illegal_argument_exception }
  - match: { error.suppressed.0.reason: "Failed to retrieve vectors for field [textbody]. Is it a [dense_vector] field?" }

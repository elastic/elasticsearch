setup:
  - requires:
      capabilities:
        - method: POST
          path: /_search
          capabilities: [ knn_query_vector_base64 ]
      test_runner_features: [ capabilities ]
      reason: Capability required to run test

  - do:
      indices.create:
        index: knn_query_base64_index
        body:
          settings:
            number_of_shards: 1
          mappings:
            dynamic: false
            properties:
              name:
                type: keyword
              vector_float:
                type: dense_vector
                dims: 3
                index: true
                element_type: float
                similarity: l2_norm
              vector_byte:
                type: dense_vector
                dims: 3
                index: true
                element_type: byte
                similarity: l2_norm
              vector_bfloat16:
                type: dense_vector
                dims: 3
                index: true
                element_type: bfloat16
                similarity: l2_norm
              vector_bit:
                type: dense_vector
                dims: 8
                index: true
                element_type: bit
                similarity: l2_norm

  - do:
      index:
        index: knn_query_base64_index
        id: "1"
        body:
          name: doc1
          vector_float: [0.1, 0.2, 0.3]
          vector_byte: [10, 20, 30]
          vector_bfloat16: [0.1, 0.2, 0.3]
          vector_bit: [3]

  - do:
      index:
        index: knn_query_base64_index
        id: "2"
        body:
          name: doc2
          vector_float: [0.2, 0.3, 0.4]
          vector_byte: [20, 30, 40]
          vector_bfloat16: [0.2, 0.3, 0.4]
          vector_bit: [5]

  - do:
      index:
        index: knn_query_base64_index
        id: "3"
        body:
          name: doc3
          vector_float: [0.4, 0.5, 0.6]
          vector_byte: [40, 50, 60]
          vector_bfloat16: [0.4, 0.5, 0.6]
          vector_bit: [7]

  - do:
      indices.refresh: {}

---
"kNN query with base64 float vector":
  # [0.1, 0.2, 0.3] is encoded as 'PczMzT5MzM0+mZma'
  - do:
      search:
        index: knn_query_base64_index
        body:
          fields: [ "name" ]
          query:
            knn:
              field: vector_float
              query_vector: "PczMzT5MzM0+mZma"
              k: 2
              num_candidates: 3

  - match: { hits.total.value: 2 }
  - match: { hits.hits.0._id: "1" }
  - match: { hits.hits.0.fields.name.0: "doc1" }
  - match: { hits.hits.1._id: "2" }
  - match: { hits.hits.1.fields.name.0: "doc2" }

---
"kNN query with base64 byte vector":
  # [10, 20, 30] is encoded as 'ChQe'
  - do:
      search:
        index: knn_query_base64_index
        body:
          fields: [ "name" ]
          query:
            knn:
              field: vector_byte
              query_vector: "ChQe"
              k: 2
              num_candidates: 3

  - match: { hits.total.value: 2 }
  - match: { hits.hits.0._id: "1" }
  - match: { hits.hits.0.fields.name.0: "doc1" }
  - match: { hits.hits.1._id: "2" }
  - match: { hits.hits.1.fields.name.0: "doc2" }

---
"kNN query with base64 produces same results as float array":
  - do:
      search:
        index: knn_query_base64_index
        body:
          fields: [ "name" ]
          query:
            knn:
              field: vector_float
              query_vector: [0.1, 0.2, 0.3]
              k: 2
              num_candidates: 3

  - set: { hits.hits.0._id: array_result_1 }
  - set: { hits.hits.1._id: array_result_2 }

  # [0.1, 0.2, 0.3] is encoded as 'PczMzT5MzM0+mZma'
  - do:
      search:
        index: knn_query_base64_index
        body:
          fields: [ "name" ]
          query:
            knn:
              field: vector_float
              query_vector: "PczMzT5MzM0+mZma"
              k: 2
              num_candidates: 3

  - match: { hits.hits.0._id: $array_result_1 }
  - match: { hits.hits.1._id: $array_result_2 }

---
"kNN query with base64 produces same results as bfloat16 array":
  - do:
      search:
        index: knn_query_base64_index
        body:
          fields: [ "name" ]
          query:
            knn:
              field: vector_bfloat16
              query_vector: [0.1, 0.2, 0.3]
              k: 2
              num_candidates: 3

  - set: { hits.hits.0._id: bfloat16_result_1 }
  - set: { hits.hits.1._id: bfloat16_result_2 }

  # [0.1, 0.2, 0.3] is encoded as 'PczMzT5MzM0+mZma'
  - do:
      search:
        index: knn_query_base64_index
        body:
          fields: [ "name" ]
          query:
            knn:
              field: vector_bfloat16
              query_vector: "PczMzT5MzM0+mZma"
              k: 2
              num_candidates: 3

  - match: { hits.hits.0._id: $bfloat16_result_1 }
  - match: { hits.hits.1._id: $bfloat16_result_2 }

---
"kNN query with base64 produces same results as bit array":
  - do:
      search:
        index: knn_query_base64_index
        body:
          fields: [ "name" ]
          query:
            knn:
              field: vector_bit
              query_vector: [3]
              k: 2
              num_candidates: 3

  - set: { hits.hits.0._id: bit_result_1 }
  - set: { hits.hits.1._id: bit_result_2 }

  # [3] is encoded as 'Aw=='
  - do:
      search:
        index: knn_query_base64_index
        body:
          fields: [ "name" ]
          query:
            knn:
              field: vector_bit
              query_vector: "Aw=="
              k: 2
              num_candidates: 3

  - match: { hits.hits.0._id: $bit_result_1 }
  - match: { hits.hits.1._id: $bit_result_2 }

---
"Invalid base64 encoding fails":
  - do:
      catch: bad_request
      search:
        index: knn_query_base64_index
        body:
          query:
            knn:
              field: vector_float
              query_vector: "not-valid-base64!!!"
              k: 2
              num_candidates: 3

---
"Wrong dimensions in base64 vector fails":
  - do:
      catch: bad_request
      search:
        index: knn_query_base64_index
        body:
          query:
            knn:
              field: vector_float
              # [0.1, 0.2] - only 2 dimensions instead of 3
              query_vector: "PczMzT5MzM0="
              k: 2
              num_candidates: 3


setup:
  - requires:
      cluster_features: "gte_v8.14.0"
      reason: 'base64 encoding for query vectors added in 8.14'

  - do:
      indices.create:
        index: knn_query_base64_index
        body:
          settings:
            number_of_shards: 1
          mappings:
            dynamic: false
            properties:
              name:
                type: keyword
              vector_float:
                type: dense_vector
                dims: 3
                index: true
                element_type: float
                similarity: l2_norm
              vector_byte:
                type: dense_vector
                dims: 3
                index: true
                element_type: byte
                similarity: l2_norm

  - do:
      index:
        index: knn_query_base64_index
        id: "1"
        body:
          name: doc1
          vector_float: [0.1, 0.2, 0.3]
          vector_byte: [10, 20, 30]

  - do:
      index:
        index: knn_query_base64_index
        id: "2"
        body:
          name: doc2
          vector_float: [0.2, 0.3, 0.4]
          vector_byte: [20, 30, 40]

  - do:
      index:
        index: knn_query_base64_index
        id: "3"
        body:
          name: doc3
          vector_float: [0.4, 0.5, 0.6]
          vector_byte: [40, 50, 60]

  - do:
      indices.refresh: {}

---
"kNN query with base64 float vector":
  # [0.1, 0.2, 0.3] is encoded as 'zczMPc3MTD6amZk+'
  - do:
      search:
        index: knn_query_base64_index
        body:
          fields: [ "name" ]
          query:
            knn:
              field: vector_float
              query_vector_base64: "zczMPc3MTD6amZk+"
              k: 2
              num_candidates: 3

  - match: { hits.total.value: 2 }
  - match: { hits.hits.0._id: "1" }
  - match: { hits.hits.0.fields.name.0: "doc1" }
  - match: { hits.hits.1._id: "2" }
  - match: { hits.hits.1.fields.name.0: "doc2" }

---
"kNN query with base64 byte vector":
  # [10, 20, 30] is encoded as 'ChQe'
  - do:
      search:
        index: knn_query_base64_index
        body:
          fields: [ "name" ]
          query:
            knn:
              field: vector_byte
              query_vector_base64: "ChQe"
              k: 2
              num_candidates: 3

  - match: { hits.total.value: 2 }
  - match: { hits.hits.0._id: "1" }
  - match: { hits.hits.0.fields.name.0: "doc1" }
  - match: { hits.hits.1._id: "2" }
  - match: { hits.hits.1.fields.name.0: "doc2" }

---
"kNN query with base64 produces same results as float array":
  - do:
      search:
        index: knn_query_base64_index
        body:
          fields: [ "name" ]
          query:
            knn:
              field: vector_float
              query_vector: [0.1, 0.2, 0.3]
              k: 2
              num_candidates: 3

  - set: { hits.hits.0._id: array_result_1 }
  - set: { hits.hits.1._id: array_result_2 }

  # [0.1, 0.2, 0.3] is encoded as 'zczMPc3MTD6amZk+'
  - do:
      search:
        index: knn_query_base64_index
        body:
          fields: [ "name" ]
          query:
            knn:
              field: vector_float
              query_vector_base64: "zczMPc3MTD6amZk+"
              k: 2
              num_candidates: 3

  - match: { hits.hits.0._id: $array_result_1 }
  - match: { hits.hits.1._id: $array_result_2 }

---
"Cannot use both query_vector and query_vector_base64":
  - do:
      catch: bad_request
      search:
        index: knn_query_base64_index
        body:
          query:
            knn:
              field: vector_float
              query_vector: [0.1, 0.2, 0.3]
              query_vector_base64: "zczMPc3MTD6amZk+"
              k: 2
              num_candidates: 3

---
"Invalid base64 encoding fails":
  - do:
      catch: bad_request
      search:
        index: knn_query_base64_index
        body:
          query:
            knn:
              field: vector_float
              query_vector_base64: "not-valid-base64!!!"
              k: 2
              num_candidates: 3

---
"Wrong dimensions in base64 vector fails":
  - do:
      catch: bad_request
      search:
        index: knn_query_base64_index
        body:
          query:
            knn:
              field: vector_float
              # [0.1, 0.2] - only 2 dimensions instead of 3
              query_vector_base64: "zczMPc3MTD4="
              k: 2
              num_candidates: 3


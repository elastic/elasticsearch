setup:
  - requires:
      capabilities:
        - method: POST
          path: /{index}/_downsample/{target_index}
          capabilities: [ "downsample.sampling_mode.last_value", "downsampling.exponential_histograms", "downsampling.tdigest_histograms" ]
      test_runner_features: [ "capabilities" ]
      reason: Downsampling histograms as metrics was added in 9.3

  - do:
      indices.create:
        index: test-exponential-histogram
        body:
          settings:
            number_of_shards: 1
            index:
              mode: time_series
              routing_path: [ metricset ]
              time_series:
                start_time: 2021-04-28T00:00:00Z
                end_time: 2021-04-29T00:00:00Z
          mappings:
            properties:
              "@timestamp":
                type: date
              metricset:
                type: keyword
                time_series_dimension: true
              metric:
                type: exponential_histogram
                time_series_metric: histogram
              non-metric:
                type: exponential_histogram

  - do:
      bulk:
        refresh: true
        index: test-exponential-histogram
        body:
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:50:04.467Z", "metricset": "set_1", "metric": {"scale":38,"sum":-2.659439830689209,"min":-0.9985699620066124,"max":0.9991606633362218,"positive":{"indices":[-1349015837690,-1133741949749,-1093555204471,-878875428260,-870694284095,-831557211207,-801793317707,-633655864830,-583473541038,-576512037819,-568470393517,-555322469609,-510705457264,-497886869173,-485920366989,-459535642468,-433595368145,-390027945362,-356113581539,-343989550188,-340618512768,-292750567759,-278017998597,-273632142061,-265328573027,-262313863416,-261799809534,-243544433917,-200039973732,-189492605429,-153154647965,-134459061772,-117996065668,-111711978805,-109965984611,-101785856856,-93187164407,-79681306932,-76611651392,-65149069301,-58423697696,-56765280861,-41035363279,-39729265577,-7007278892,-332991304],"counts":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]},"negative":{"indices":[-1722041245251,-1507876068779,-1461993774485,-1437177146905,-1022221748846,-909329959788,-902070008615,-869527704039,-859349507080,-836401169293,-835541219174,-827446708753,-823853818576,-767042645194,-764466131268,-698239247988,-598695656860,-560446067886,-554301612745,-521812328033,-508700015492,-462218888037,-417010270052,-384781248780,-371405487026,-366789447120,-349996665670,-300317310192,-287581746174,-287132961026,-284865058959,-255687331935,-236975923503,-200065874687,-196100184062,-147243768507,-145933242978,-140904484007,-136697299301,-117022220796,-87401418251,-63863967756,-62902280835,-59450473434,-53232718483,-49452610935,-45384224466,-36361788727,-34176300034,-12469429575,-9431189993,-3254481828,-2083495024,-567508884],"counts":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}}, "non-metric": {"scale":38,"sum":-2.659439830689209,"min":-0.9985699620066124,"max":0.9991606633362218,"positive":{"indices":[-1349015837690,-1133741949749,-1093555204471,-878875428260,-870694284095,-831557211207,-801793317707,-633655864830,-583473541038,-576512037819,-568470393517,-555322469609,-510705457264,-497886869173,-485920366989,-459535642468,-433595368145,-390027945362,-356113581539,-343989550188,-340618512768,-292750567759,-278017998597,-273632142061,-265328573027,-262313863416,-261799809534,-243544433917,-200039973732,-189492605429,-153154647965,-134459061772,-117996065668,-111711978805,-109965984611,-101785856856,-93187164407,-79681306932,-76611651392,-65149069301,-58423697696,-56765280861,-41035363279,-39729265577,-7007278892,-332991304],"counts":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]},"negative":{"indices":[-1722041245251,-1507876068779,-1461993774485,-1437177146905,-1022221748846,-909329959788,-902070008615,-869527704039,-859349507080,-836401169293,-835541219174,-827446708753,-823853818576,-767042645194,-764466131268,-698239247988,-598695656860,-560446067886,-554301612745,-521812328033,-508700015492,-462218888037,-417010270052,-384781248780,-371405487026,-366789447120,-349996665670,-300317310192,-287581746174,-287132961026,-284865058959,-255687331935,-236975923503,-200065874687,-196100184062,-147243768507,-145933242978,-140904484007,-136697299301,-117022220796,-87401418251,-63863967756,-62902280835,-59450473434,-53232718483,-49452610935,-45384224466,-36361788727,-34176300034,-12469429575,-9431189993,-3254481828,-2083495024,-567508884],"counts":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:51:04.467Z", "metricset": "set_1", "metric": {"scale":38,"sum":-2.612341035444145,"min":-0.8596842630789088,"max":0.9412120998532649,"positive":{"indices":[-1527782821719,-1491647186305,-912103649399,-744031889051,-669036239523,-602111557612,-586601121715,-567461548128,-483021101785,-450865160617,-331097834736,-293981770197,-289290353357,-246965149109,-203070759894,-180702903638,-135653049938,-93843302593,-78356307212,-76729181967,-65070806329,-64241350555,-24026590621],"counts":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]},"negative":{"indices":[-1423777207002,-923870284341,-877992064499,-870206177266,-850685295282,-759799372292,-643924938249,-570457241089,-528116212727,-369003212885,-315079526687,-292745353109,-235218433328,-222024648135,-204603508425,-195434414609,-177993661419,-172367743205,-168351131368,-149696012047,-115115447928,-95206374327,-74115574931,-74013160315,-64191774880,-63955626713,-59956698242],"counts":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}}, "non-metric": {"scale":38,"sum":-2.612341035444145,"min":-0.8596842630789088,"max":0.9412120998532649,"positive":{"indices":[-1527782821719,-1491647186305,-912103649399,-744031889051,-669036239523,-602111557612,-586601121715,-567461548128,-483021101785,-450865160617,-331097834736,-293981770197,-289290353357,-246965149109,-203070759894,-180702903638,-135653049938,-93843302593,-78356307212,-76729181967,-65070806329,-64241350555,-24026590621],"counts":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]},"negative":{"indices":[-1423777207002,-923870284341,-877992064499,-870206177266,-850685295282,-759799372292,-643924938249,-570457241089,-528116212727,-369003212885,-315079526687,-292745353109,-235218433328,-222024648135,-204603508425,-195434414609,-177993661419,-172367743205,-168351131368,-149696012047,-115115447928,-95206374327,-74115574931,-74013160315,-64191774880,-63955626713,-59956698242],"counts":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:57:04.467Z", "metricset": "set_2", "metric": {"scale":3,"sum":-2.612341035444145,"min":-0.596,"max":0.9,"positive":{"indices":[-100,-90,-88],"counts":[1,1,1]},"negative":{"indices":[-142,-92,-87],"counts":[1,1,1]}}, "non-metric": {"scale":3,"sum":-2.612341035444145,"min":-0.596,"max":0.9,"positive":{"indices":[-100,-90,-88],"counts":[1,1,1]},"negative":{"indices":[-142,-92,-87],"counts":[1,1,1]}}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T19:57:04.467Z", "metricset": "set_1", "metric": {"scale":3,"sum":-2.612341035444145,"min":-0.596,"max":0.9,"positive":{"indices":[-100,-90,-88],"counts":[1,1,1]},"negative":{"indices":[-142,-92,-87],"counts":[1,1,1]}}, "non-metric": {"scale":3,"sum":-2.612341035444145,"min":-0.596,"max":0.9,"positive":{"indices":[-100,-90,-88],"counts":[1,1,1]},"negative":{"indices":[-142,-92,-87],"counts":[1,1,1]}}}'

  - do:
      indices.put_settings:
        index: test-exponential-histogram
        body:
          index.blocks.write: true

  - do:
      indices.create:
        index: test-histogram
        body:
          settings:
            number_of_shards: 1
            index:
              mode: time_series
              routing_path: [ metricset ]
              time_series:
                start_time: 2021-04-28T00:00:00Z
                end_time: 2021-04-29T00:00:00Z
          mappings:
            properties:
              "@timestamp":
                type: date
              metricset:
                type: keyword
                time_series_dimension: true
              metric:
                type: histogram
                time_series_metric: histogram
              non-metric:
                type: histogram

  - do:
      bulk:
        refresh: true
        index: test-histogram
        body:
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:50:04.467Z", "metricset": "set_1", "metric": {"values": [-3, -2, 0], "counts": [2, 11, 36]}, "non-metric": {"values": [-3, -2, 0], "counts": [2, 11, 36]}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:51:04.467Z", "metricset": "set_1", "metric": {"values": [-9, -8, -7, -4, -3, -2, -1], "counts": [1, 2, 1, 3, 3, 2, 6]}, "non-metric": {"values": [-9, -8, -7, -4, -3, -2, -1], "counts": [1, 2, 1, 3, 3, 2, 6]}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:57:04.467Z", "metricset": "set_2", "metric": {"values": [3, 5, 7, 8, 9, 22, 41], "counts": [3, 4, 1, 5, 32, 21, 6]}, "non-metric": {"values": [3, 5, 7, 8, 9, 22, 41], "counts": [3, 4, 1, 5, 32, 21, 6]}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T19:57:04.467Z", "metricset": "set_1", "metric": {"values": [3, 5, 7, 8, 9, 22, 41], "counts": [3, 4, 1, 5, 32, 21, 6]}, "non-metric": {"values": [3, 5, 7, 8, 9, 22, 41], "counts": [3, 4, 1, 5, 32, 21, 6]}}'

  - do:
      indices.put_settings:
        index: test-histogram
        body:
          index.blocks.write: true

---
"Downsample exponential histogram with last value":
  - do:
      indices.downsample:
        index: test-exponential-histogram
        target_index: last-value-exponential-histogram
        body: >
          {
            "fixed_interval": "1h",
            "sampling_method": "last_value"
          }
  - is_true: acknowledged

  - do:
      search:
        index: last-value-exponential-histogram
        body: >
          {
            "query": { "term": { "metricset": "set_1" } },
            "sort": [ "@timestamp" ]
          }


  - length: { hits.hits: 2 }

  - match: { hits.hits.0._source._doc_count: 2 }
  - match: { hits.hits.0._source.metricset: set_1 }
  - match: { hits.hits.0._source.@timestamp: "2021-04-28T18:00:00.000Z" }
  - match: { hits.hits.0._source.metric.max: 00.9412120998532649 }
  - match: { hits.hits.0._source.metric.min: -0.8596842630789088 }
  - match: { hits.hits.0._source.metric.scale: 38 }
  - match: { hits.hits.0._source.metric.sum: -2.612341035444145 }
  - match: { hits.hits.0._source.non-metric.max: 0.9412120998532649 }
  - match: { hits.hits.0._source.non-metric.min: -0.8596842630789088 }
  - match: { hits.hits.0._source.non-metric.scale: 38 }
  - match: { hits.hits.0._source.non-metric.sum: -2.612341035444145 }

---
"Downsample exponential histogram with aggregate":
  - do:
      indices.downsample:
        index: test-exponential-histogram
        target_index: aggregate-exponential-histogram
        body: >
          {
            "fixed_interval": "1h"
          }
  - is_true: acknowledged

  - do:
      search:
        index: aggregate-exponential-histogram
        body: >
          {
            "query": { "term": { "metricset": "set_1" } },
            "sort": [ "@timestamp" ]
          }

  - length: { hits.hits: 2 }

  - match: { hits.hits.0._source._doc_count: 2 }
  - match: { hits.hits.0._source.metricset: set_1 }
  - match: { hits.hits.0._source.@timestamp: "2021-04-28T18:00:00.000Z" }
  - match: { hits.hits.0._source.metric.max: 0.9991606633362218 }
  - match: { hits.hits.0._source.metric.min: -0.9985699620066124 }
  - match: { hits.hits.0._source.metric.scale: 38 }
  - match: { hits.hits.0._source.metric.sum: -5.271780866133354 }
  - match: { hits.hits.0._source.non-metric.max: 0.9412120998532649 }
  - match: { hits.hits.0._source.non-metric.min: -0.8596842630789088 }
  - match: { hits.hits.0._source.non-metric.scale: 38 }
  - match: { hits.hits.0._source.non-metric.sum: -2.612341035444145 }

---
"Downsample histogram with last value":

  - do:
      indices.downsample:
        index: test-histogram
        target_index: last-value-histogram
        body: >
          {
            "fixed_interval": "1h",
            "sampling_method": "last_value"
          }
  - is_true: acknowledged

  - do:
      search:
        index: last-value-histogram
        body: >
          {
            "query": { "term": { "metricset": "set_1" } },
            "sort": [ "@timestamp" ]
          }

  - length: { hits.hits: 2 }

  - match: { hits.hits.0._source._doc_count: 2 }
  - match: { hits.hits.0._source.metricset: set_1 }
  - match: { hits.hits.0._source.@timestamp: "2021-04-28T18:00:00.000Z" }
  - match: { hits.hits.0._source.metric.values: [-9.0, -8.0, -7.0, -4.0, -3.0, -2.0, -1.0] }
  - match: { hits.hits.0._source.metric.counts: [1, 2, 1, 3, 3, 2, 6] }
  - match: { hits.hits.0._source.non-metric.values: [-9.0, -8.0, -7.0, -4.0, -3.0, -2.0, -1.0] }
  - match: { hits.hits.0._source.non-metric.counts: [1, 2, 1, 3, 3, 2, 6] }

---
"Downsample histogram with aggregate":
  - do:
      indices.downsample:
        index: test-histogram
        target_index: aggregate-histogram
        body: >
          {
            "fixed_interval": "1h"
          }
  - is_true: acknowledged

  - do:
      search:
        index: aggregate-histogram
        body: >
          {
            "query": { "term": { "metricset": "set_1" } },
            "sort": [ "@timestamp" ]
          }

  - length: { hits.hits: 2 }

  - match: { hits.hits.0._source._doc_count: 2 }
  - match: { hits.hits.0._source.metricset: set_1 }
  - match: { hits.hits.0._source.@timestamp: "2021-04-28T18:00:00.000Z" }
  - match: { hits.hits.0._source.metric.values: [-9.0, -8.0, -7.0, -4.0, -3.0, -2.0, -1.0, 0.0] }
  - match: { hits.hits.0._source.metric.counts: [1, 2, 1, 3, 5, 13, 6, 36] }
  - match: { hits.hits.0._source.non-metric.values: [-9.0, -8.0, -7.0, -4.0, -3.0, -2.0, -1.0] }
  - match: { hits.hits.0._source.non-metric.counts: [1, 2, 1, 3, 3, 2, 6] }

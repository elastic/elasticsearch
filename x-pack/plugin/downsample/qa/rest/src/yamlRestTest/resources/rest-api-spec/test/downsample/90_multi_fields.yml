setup:
  - requires:
      capabilities:
        - method: POST
          path: /{index}/_downsample/{target_index}
          capabilities: ['downsample.multi_field_fix']
      test_runner_features: [ "capabilities", "allowed_warnings" ]
      reason: Requires the fix for downsampling multi fields

---
"Downsample index with multi-fields":
  - do:
      indices.create:
        index: test
        body:
          settings:
            number_of_shards: 1
            index:
              mode: time_series
              routing_path: [ dimension ]
              time_series:
                start_time: 2021-04-28T00:00:00Z
                end_time: 2021-04-29T00:00:00Z
          mappings:
            properties:
              "@timestamp":
                type: date
              dimension:
                type: keyword
                time_series_dimension: true
              label-dimension:
                type: keyword
                fields:
                  dimension:
                    type: keyword
                    time_series_dimension: true
              label-text:
                type: text
                fields:
                  keyword:
                    type: keyword
                  other-keyword:
                    type: keyword
              metric:
                type: long
                time_series_metric: gauge
  - is_true: shards_acknowledged

  - do:
      bulk:
        refresh: true
        index: test
        body:
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:50:04.467Z", "dimension": "pod", "label-dimension": "my label", "label-text": "my text", "metric": 1}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:50:24.467Z", "dimension": "pod", "label-dimension": "my label", "label-text": "my other text", "metric": 3}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T20:50:44.467Z", "dimension": "pod", "label-dimension": "my label", "label-text": "my random text", "metric": 2}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T20:51:04.467Z", "dimension": "pod", "label-dimension": "my other label", "label-text": "some text", "metric": 4}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:50:03.142Z", "dimension": "pod", "label-dimension": "my label", "label-text": "some other text", "metric": 6}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:50:23.142Z", "dimension": "pod", "label-dimension": "my label", "label-text": "some random text", "metric": 3}'

  - do:
      indices.put_settings:
        index: test
        body:
          index.blocks.write: true
  - is_true: acknowledged

  - do:
      allowed_warnings:
        - "Parameter [default_metric] is deprecated and will be removed in a future version"
      indices.downsample:
        index: test
        target_index: test-downsample
        body: >
          {
            "fixed_interval": "1h"
          }
  - is_true: acknowledged

  - do:
      search:
        index: test-downsample
        body:
          sort: [ "@timestamp", "_tsid" ]

  - length: { hits.hits: 3 }
  - match: { hits.hits.0._source._doc_count: 4 }
  - match: { hits.hits.0._source.dimension: pod }
  - match: { hits.hits.0._source.@timestamp: 2021-04-28T18:00:00.000Z }
  - match: { hits.hits.0._source.label-dimension: "my label" }
  - match: { hits.hits.0._source.label-text: "my other text" }
  - match: { hits.hits.0._source.metric.sum: 13 }
  - match: { hits.hits.0._source.metric.value_count: 4 }
  - match: { hits.hits.0._source.metric.min: 1 }
  - match: { hits.hits.0._source.metric.max: 6 }

---
"Downsampling index fails with metrics as multi-fields":
  - do:
      indices.create:
        index: test
        body:
          settings:
            number_of_shards: 1
            index:
              mode: time_series
              routing_path: [ dimension ]
              time_series:
                start_time: 2021-04-28T00:00:00Z
                end_time: 2021-04-29T00:00:00Z
          mappings:
            properties:
              "@timestamp":
                type: date
              dimension:
                type: keyword
                time_series_dimension: true
              cpu_usage:
                type: long
                fields:
                  gauge:
                    type: long
                    time_series_metric: gauge
  - is_true: shards_acknowledged

  - do:
      bulk:
        refresh: true
        index: test
        body:
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:50:04.467Z", "dimension": "pod", "cpu_usage": 1}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:50:24.467Z", "dimension": "pod", "cpu_usage": 3}'

  - do:
      indices.put_settings:
        index: test
        body:
          index.blocks.write: true
  - is_true: acknowledged

  - do:
      catch: /Downsampling failed because index mapping contains time series metrics as a multi field/
      indices.downsample:
        index: test
        target_index: test-downsample
        body: >
          {
            "fixed_interval": "1h"
          }

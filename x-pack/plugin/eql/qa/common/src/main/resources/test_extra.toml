[[queries]]
name = "basic"
query = '''
  sequence by transID
    [ REQUEST where true ]
    [ ERROR where true ]
    [ STAT where true ]
'''
expected_event_ids  = [1,2,3,4,5,6]
join_keys = ["1234","1235"]

[[queries]]
name = "basicWithFilter"
query = '''
  sequence by transID
    [ REQUEST where transID == 1234 ]
    [ ERROR where true ]
    [ STAT where true ]
'''
expected_event_ids  = [1,2,3]
join_keys = ["1234"]

[[queries]]
name = "basicWithFilters"
query = '''
  sequence by transID
    [ REQUEST where transID == 1234 ]
    [ ERROR where transID == 1234 ]
    [ STAT where transID == 1234 ]
'''
expected_event_ids  = [1,2,3]
join_keys = ["1234"]

[[queries]]
name = "byDate"
query = '''
  sequence by date_tags
    [ process where true ]
    [ process where true ]
'''
expected_event_ids  = [10, 12]
join_keys = ["1970-01-01T00:00:00.000Z"]

[[queries]]
name = "optionalNoDocsFieldNullEquality"
query = '''
  OPTIONAL where ?optional_field_mapping_only == null
'''
expected_event_ids  = [7,8,9]

[[queries]]
name = "optionalNoDocsFieldNumericEquality"
query = '''
  OPTIONAL where ?optional_field_mapping_only == 123
'''
expected_event_ids  = []

[[queries]]
name = "optionalDefaultNullValueFieldEqualNull"
query = '''
  OPTIONAL where ?optional_field_default_null == null
'''
expected_event_ids  = [8]

[[queries]]
name = "optionalDefaultNullValueFieldEqualDefaultValue"
query = '''
  OPTIONAL where ?optional_field_default_null == "NULL"
'''
expected_event_ids  = [7,9]

[[queries]]
name = "optionalMissingFieldNullEquality"
query = '''
  OPTIONAL where ?inexistent_field == null
'''
expected_event_ids  = [7,8,9]

[[queries]]
name = "optionalMissingFieldImplicitBooleanEquality"
query = '''
  OPTIONAL where ?inexistent_field
'''
expected_event_ids  = []

[[queries]]
name = "sequenceOptionalFieldAsKeyAndFirstFilter"
query = '''
sequence by ?x
  [OPTIONAL where ?x == null]
  [OPTIONAL where true]
'''
expected_event_ids  = [7,8,8,9]
join_keys = ["null","null"]

[[queries]]
name = "sequenceOptionalFieldAsKeyAndSecondFilter"
query = '''
sequence by ?x
  [REQUEST where transID == 1234]
  [OPTIONAL where ?x == null]
'''
expected_event_ids  = [1,7]
join_keys = ["null"]

[[queries]]
name = "sequenceOptionalFieldAsQueryKeys"
query = '''
sequence by ?x, transID
  [ERROR where true] by ?x
  [OPTIONAL where true] by ?y
'''
expected_event_ids  = [5,8]
join_keys = ["null","1235","null"]

[[queries]]
name = "sequenceOptionalFieldAsKeyAndMultipleConditions"
query = '''
sequence by ?x, ?y
  [ERROR where ?x == null or ?y == null]
  [OPTIONAL where ?y == null and ?x == null]
'''
expected_event_ids  = [5,7]
join_keys = ["null","null"]

[[queries]]
name = "sequenceOptionalFieldAsQueryKeysOnly"
query = '''
sequence by transID
  [ REQUEST where transID == 1234 ] by ?z
  [ ERROR where ?x == ?y ] by ?y
  [ STAT where true ] by ?x
'''
expected_event_ids  = [1,2,3]
join_keys = ["1234","null"]

[[queries]]
name = "sequenceAllKeysOptional"
query = '''
sequence by ?process.entity_id, ?process.pid
  [process where transID == 2]
  [file where transID == 0] with runs=2
'''
expected_event_ids  = [12,13,14,
                       11,16,17,
                       18,19,20]
join_keys = ["null","123",
             "null","null",
             "512","123"]

[[queries]]
name = "sequenceOneKeyOptional_1"
query = '''
sequence by process.entity_id, ?process.pid
  [process where transID == 2]
  [file where transID == 0] with runs=2
'''
expected_event_ids  = [18,19,20]
join_keys = ["512","123"]

[[queries]]
name = "sequenceOneKeyOptional_2"
query = '''
sequence by ?process.entity_id, process.pid
  [process where transID == 2]
  [file where transID == 0] with runs=2
'''
expected_event_ids  = [12,13,14,
                       18,19,20]
join_keys = ["null","123",
             "512","123"]

[[queries]]
name = "sequenceNoOptionalKeys"
query = '''
sequence by process.entity_id, process.pid
  [process where transID == 2]
  [file where transID == 0] with runs=2
'''
expected_event_ids  = [18,19,20]
join_keys = ["512","123"]

# Known issue: same key used as both optional and non-optional doesn't work as expected. Does it even make sense such scenario?
#[[queries]]
#name = "sequenceSameKeyBothOptionalAndNonOptional"
#query = '''
#sequence by ?process.entity_id, ?process.pid, process.entity_id
#  [process where ?process.entity_id == 512 or transID == 2]
#  [file where ?process.pid == 123 or transID == 0] with runs=2
#'''
#expected_event_ids  = [18,19,20]
#join_keys = ["512","123","512"]

[[queries]]
name = "sequenceWithOptionalFieldsAndUntil_1"
query = '''
sequence by ?process.entity_id, ?process.pid
  [process where transID == 2]
  [file where transID == 0] with runs=2
  until [file where `sequence` == 20]
'''
expected_event_ids  = [12,13,14,
                       11,16,17,
                       18,19,20]
join_keys = ["null","123",
             "null","null",
             "512","123"]

[[queries]]
name = "sequenceWithOptionalFieldsAndUntil_2"
query = '''
sequence by ?process.entity_id, ?process.pid
  [process where transID == 2]
  [file where transID == 0] with runs=2
  until [file where `sequence` == 19]
'''
expected_event_ids  = [12,13,14,
                       11,16,17]
join_keys = ["null","123",
             "null","null"]

[[queries]]
name = "sequenceWithVersionCheck"
query = '''
  sequence by transID
    [ file where version == "1.2.4" ]
    [ file where version == "1.11.3" ]
'''
expected_event_ids  = [20, 21]
join_keys = ["0"]

[[queries]]
name = "sequenceWithVersionRangeCheck"
query = '''
  sequence by transID
    [ file where version == "1.2.4" ]
    [ file where version > "1.5.0" ]
'''
expected_event_ids  = [20, 21]
join_keys = ["0"]

[[queries]]
name = "sequenceWithVersionRangeCheck2"
query = '''
  sequence by transID
    [ file where version == "1.2.4" ]
    [ file where version < "1.5.0" ]
'''
expected_event_ids  = [20, 23]
join_keys = ["0"]


[[queries]]
name = "sequenceWithInvalidVersion"
query = '''
  sequence by transID
    [ file where version == "1.2.4" ]
    [ file where version == "bad" ]
'''
expected_event_ids  = [20, 22]
join_keys = ["0"]


[[queries]]
name = "sequenceWithVersionConcat"
query = '''
  sequence by transID
    [ file where CONCAT(version, "") == "1.2.4" ]
    [ file where version == "bad" ]
'''
expected_event_ids  = [20, 22]
join_keys = ["0"]


[[queries]]
name = "sequenceWithVersionJoinKey"
query = '''
  sequence by version
    [ process where true ]
    [ file where true ]
'''
expected_event_ids  = [18, 19]
join_keys = ["1.5.0"]


[[queries]]
name = "sequenceWithMultivalue_OneToMany"
query = '''
  sequence by tags
    [ REQUEST where true ]
    [ ERROR where true ]
'''
expected_event_ids  = [1, 2]
join_keys = ["tag1"]


[[queries]]
name = "sequenceWithMultivalue_ManyToOne"
query = '''
  sequence by tags
    [ process where true ]
    [ process where true ]
'''
expected_event_ids  = [10, 11]
join_keys = ["tag6"]


[[queries]]
name = "sequenceWithMultivalue_ManyToMany"
query = '''
  sequence by tags
    [ REQUEST where true ]
    [ file where true ]
'''
expected_event_ids  = [1, 23, 4, 23, 4, 23]
join_keys = ["tag1", "tag3", "tag4"]


[[queries]]
name = "sequenceWithMultivalue_CartesianProduct"
query = '''
  sequence by tags, items
    [ REQUEST where true ]
    [ file where true ]
'''
expected_event_ids  = [4, 23, 4, 23, 4, 23, 4, 23]
join_keys = ["tag3", "item1", "tag3", "item2", "tag4", "item1", "tag4", "item2"]


[[queries]]
name = "sequenceWithMultivalue_Duplicates"
query = '''
  sequence by tags_with_duplicates
    [ process where true ]
    [ file where true ]
'''
expected_event_ids  = [12, 13, 12, 13]
join_keys = ["tag1", "tag2"]


[[queries]]
name = "sequenceWithMultivalue_RandomOrder"
query = '''
  sequence by tags_unordered
    [ file where true ]
    [ file where true ]
'''
expected_event_ids  = [14, 15, 14, 15]
join_keys = ["tag1", "tag5"]


[[queries]]
name = "sequenceWithMultivalue_NullValues"
query = '''
  sequence by tags_with_null
    [ file where true ]
    [ file where true ]
'''
expected_event_ids  = [16, 19, 16, 20]
join_keys = ["tag1", "tag2"]

[[queries]]
name = "sequenceWithMultivalue_DateValues"
query = '''
  sequence by date_tags
    [ file where true ]
    [ file where true ]
'''
expected_event_ids  = [20, 21, 21, 22]
join_keys = [ "1970-01-01T00:00:00.000Z", "1970-01-02T00:00:00.000Z" ]


[[queries]]
name = "sequenceWithOptionalMultivalue_simple"
query = '''
  sequence by ?optional_tags
    [ process where true ]
    [ process where true ]
'''
expected_event_ids  = [11, 12]
join_keys = [null]

[[queries]]
name = "sequenceWithOptionalMultivalue_perQuery"
query = '''
  sequence
    [ process where true ] by ?optional_tags
    [ process where true ] by ?optional_tags
'''
expected_event_ids  = [11, 12]
join_keys = [null]


[[queries]]
name = "sequenceWithOptionalMultivalue_multiPlusOptional"
query = '''
  sequence by tags, ?optional_tags
    [ REQUEST where true ]
    [ ERROR where true ]
'''
expected_event_ids  = [1, 2]
join_keys = ["tag1", null]


[[queries]]
name = "sequenceWithOptionalMultivalue_optionalPlusMulti"
query = '''
  sequence by ?optional_tags, tags
    [ REQUEST where true ]
    [ ERROR where true ]
'''
expected_event_ids  = [1, 2]
join_keys = [null, "tag1"]


[[queries]]
name = "sequenceWithOptionalMultivalue_twoOptionals"
query = '''
  sequence by ?optional_tags, ?tags
    [ REQUEST where true ]
    [ ERROR where true ]
'''
expected_event_ids  = [1, 2]
join_keys = [null, "tag1"]


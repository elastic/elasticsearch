// Tests focused on query approximation.
//
// The data set "many_numbers" contains 200,100 rows with a multi-valued field
// "value" containing 10 integers each. Aggregated all over rows, there are
// 1x1, 2x2, ..., 1999x1999 and 2000x2000, and no row contains the same number
// twice. This adds up to over 2 million numbers, so that query approximation
// kicks in. It's not one number per row, because that's slow to ingest. 
//
// Note: this tests only basic behavior, because of limitations of the CSV tests.
// Most tests assert that the count, average and sum of some values are within a
// range. All ranges are very loose, so that the tests should practically never fail.
// The assertions on the confidence intervals are similarly loose, and the assertions
// on the reliability match anything, because it has a small false-negative rate,
// which would make the tests flaky.


total count
required_capability: approximation

SET approximation={"rows":10000}\;
FROM many_numbers | STATS count=COUNT(*)
;

count:long
200100
;


approximate stats on large data
required_capability: approximation

SET approximation=true\;
FROM many_numbers
    | MV_EXPAND value
    | STATS count=COUNT(), avg=AVG(value), sum=SUM(value)
;

count:long       | avg:double | sum:long               | CONFIDENCE_INTERVAL(count):long     | CERTIFIED(count):boolean | CONFIDENCE_INTERVAL(avg):double | CERTIFIED(avg):boolean | CONFIDENCE_INTERVAL(sum):long                   | CERTIFIED(sum):boolean
1300000..2700000 | 1315..1350 | 1700000000..3600000000 | [1300000..2700000,1300000..2700000] | {any}                    | [1315..1350,1315..1350]         | {any}                  | [1700000000..3600000000,1700000000..3600000000] | {any}
;


exact stats on small data
required_capability: approximation

SET approximation={"rows":100000}\;
FROM many_numbers
    | MV_EXPAND value
    | WHERE value <= 25
    | STATS count=COUNT(), avg=AVG(value), sum=SUM(value)
;

count:long | avg:double | sum:long | CONFIDENCE_INTERVAL(count):long | CERTIFIED(count):boolean | CONFIDENCE_INTERVAL(avg):double | CERTIFIED(avg):boolean | CONFIDENCE_INTERVAL(sum):long | CERTIFIED(sum):boolean
325        | 17.0       | 5525     | [325, 325]                      | true                     | [17.0, 17.0]                    | true                  | [5525, 5525]                   | true
;


exact total count and approximate stats on large data
required_capability: approximation

SET approximation={"rows":10000}\;
FROM many_numbers
    | STATS count=COUNT(), count2=COUNT(*), count3=COUNT("*"), countValue=COUNT(value)
;

count:long | count2:long | count3:long | countValue:long  | CONFIDENCE_INTERVAL(countValue):long | CERTIFIED(countValue):boolean
200100     | 200100      | 200100      | 1300000..2700000 | [1300000..2700000,1300000..2700000]  | {any}
;


with where
required_capability: approximation

SET approximation=true\;
FROM many_numbers
    | MV_EXPAND value
    | WHERE value >= 1000
    | STATS count=COUNT(), avg=AVG(value), sum=SUM(value)
;

count:long       | avg:double | sum:long               | CONFIDENCE_INTERVAL(count):long     | CERTIFIED(count):boolean | CONFIDENCE_INTERVAL(avg):double | CERTIFIED(avg):boolean | CONFIDENCE_INTERVAL(sum):long                   | CERTIFIED(sum):boolean
1000000..2000000 | 1545..1565 | 1500000000..3000000000 | [1000000..2000000,1000000..2000000] | {any}                    | [1545..1565,1545..1565]         | {any}                  | [1500000000..3000000000,1500000000..3000000000] | {any}
;


with stats where
required_capability: approximation

SET approximation={"confidence_level":0.85}\;
FROM many_numbers
    | MV_EXPAND value
    | STATS count=COUNT()  WHERE value >= 1000,
            avg=AVG(value) WHERE value >= 1000,
            sum=SUM(value) WHERE value >= 1000
;

count:long       | avg:double  | sum:long              | CONFIDENCE_INTERVAL(count):long     | CERTIFIED(count):boolean | CONFIDENCE_INTERVAL(avg):double | CERTIFIED(avg):boolean | CONFIDENCE_INTERVAL(sum):long                   | CERTIFIED(sum):boolean
1000000..2000000 | 1545..1565 | 1500000000..3000000000 | [1000000..2000000,1000000..2000000] | {any}                    | [1545..1565,1545..1565]         | {any}                  | [1500000000..3000000000,1500000000..3000000000] | {any}
;


with sample
required_capability: approximation

SET approximation={"rows":100000,"confidence_level":0.85}\;
FROM many_numbers
    | MV_EXPAND value
    | SAMPLE 0.8
    | STATS count=COUNT(), avg=AVG(value), sum=SUM(value)
;

count:long       | avg:double  | sum:long             | CONFIDENCE_INTERVAL(count):long     | CERTIFIED(count):boolean | CONFIDENCE_INTERVAL(avg):double | CERTIFIED(avg):boolean | CONFIDENCE_INTERVAL(sum):long                 | CERTIFIED(sum):boolean
1000000..2000000 | 1315..1350 | 130000000..2900000000 | [1000000..2000000,1000000..2000000] | {any}                    | [1315..1350,1315..1350]         | {any}                  | [130000000..2900000000,130000000..2900000000] | {any}
;


with commands before stats
required_capability: approximation

SET approximation={}\;
FROM many_numbers
    | MV_EXPAND value
    | EVAL value2 = 2 * value
    | DROP value
    | SORT value2 DESC
    | RENAME value2 AS value3
    | MV_EXPAND value3
    | EVAL value4 = TO_STRING(value3)
    | SORT value4 ASC
    | GROK value4 "%{NUMBER:value5}"
    | EVAL value5 = TO_INTEGER(value5)
    | KEEP value3, value5
    | STATS count=COUNT(), avg=AVG(value5), sum=SUM(value5)
;

count:long       | avg:double | sum:long               | CONFIDENCE_INTERVAL(count):long     | CERTIFIED(count):boolean | CONFIDENCE_INTERVAL(avg):double | CERTIFIED(avg):boolean | CONFIDENCE_INTERVAL(sum):long                   | CERTIFIED(sum):boolean
1300000..2700000 | 2630..2700 | 3400000000..7200000000 | [1300000..2700000,1300000..2700000] | {any}                    | [2630..2700,2630..2700]         | {any}                  | [3400000000..7200000000,3400000000..7200000000] | {any}
;


with commands after stats
required_capability: approximation

SET approximation=true\;
FROM many_numbers
    | MV_EXPAND value
    | STATS count=COUNT(), avg=AVG(value), sum=SUM(value)
    | EVAL avg2 = 2 * avg
    | LIMIT 10
    | MV_EXPAND avg
    | SORT count ASC
    | KEEP avg, avg2
;

avg:double | avg2:double | CONFIDENCE_INTERVAL(avg):double | CERTIFIED(avg):boolean | CONFIDENCE_INTERVAL(avg2):double | CERTIFIED(avg2):boolean
1315..1350 | 2630..2700  | [1315..1350,1315..1350]         | {any}                  | [2630..2700,2630..2700]          | {any} 
;


with dependent variables that have confidence interval
required_capability: approximation

SET approximation=true\;
FROM many_numbers
    | MV_EXPAND value
    | STATS avg=AVG(value)
    | EVAL x = 2*avg*avg + sin(avg), y = 1
    | KEEP x, y
    | EVAL plus_one = y + x + 1
    | RENAME plus1 = plus_one
    | DROP x 
;

y:integer | plus1:double     | CONFIDENCE_INTERVAL(plus1):double   | CERTIFIED(plus1):boolean
1         | 3400000..3700000 | [3400000..3700000,3400000..3700000] | {any}
;


with dependent string variable
required_capability: approximation

SET approximation=true\;
FROM many_numbers
    | MV_EXPAND value
    | STATS avg=AVG(value)
    | EVAL str=TO_STRING(avg)
    | EVAL from_str = str::DOUBLE
    | KEEP from_str
;

from_str:double
1315..1350
;


with dependent multivalued variable
required_capability: approximation

SET approximation=true\;
FROM many_numbers
    | MV_EXPAND value
    | STATS avg=AVG(value)
    | EVAL mv=MV_APPEND(1.0,avg)
    | DROP avg
;

mv:double
[1,1315..1350]
;


approximate stats with zero variance
required_capability: approximation

SET approximation=true\;
FROM many_numbers
    | MV_EXPAND value
    | STATS avg=avg(value), median=median(value), one=3/(1+SUM(2.0*value)/SUM(value)) BY value
    | SORT value DESC
    | LIMIT 5
;

avg:double | median:double | one:double | value:integer | CONFIDENCE_INTERVAL(avg):double | CERTIFIED(avg):boolean | CONFIDENCE_INTERVAL(median):double | CERTIFIED(median):boolean | CONFIDENCE_INTERVAL(one):double | CERTIFIED(one):boolean
2000       | 2000          | 1          | 2000          | [2000,2000]                     | {any}                  | [2000,2000]                        | {any}                    | [1,1]                            | {any}
1999       | 1999          | 1          | 1999          | [1999,1999]                     | {any}                  | [1999,1999]                        | {any}                    | [1,1]                            | {any}
1998       | 1998          | 1          | 1998          | [1998,1998]                     | {any}                  | [1998,1998]                        | {any}                    | [1,1]                            | {any}
1997       | 1997          | 1          | 1997          | [1997,1997]                     | {any}                  | [1997,1997]                        | {any}                    | [1,1]                            | {any}
1996       | 1996          | 1          | 1996          | [1996,1996]                     | {any}                  | [1996,1996]                        | {any}                    | [1,1]                            | {any}
;


approximate stats by on large data
required_capability: approximation

SET approximation={"rows":100000}\;
FROM many_numbers
    | MV_EXPAND value
    | STATS count=COUNT() BY value
    | SORT value DESC
    | KEEP value, count
    | LIMIT 5
;

value:integer | count:long | CONFIDENCE_INTERVAL(count):long | CERTIFIED(count):boolean
2000          | 1000..3000 | [500..2500,1500..4000]          | {any}
1999          | 1000..3000 | [500..2500,1500..4000]          | {any}
1998          | 1000..3000 | [500..2500,1500..4000]          | {any}
1997          | 1000..3000 | [500..2500,1500..4000]          | {any}
1996          | 1000..3000 | [500..2500,1500..4000]          | {any}
;


exact stats by on small data
required_capability: approximation

SET approximation={"rows":100000}\;
FROM many_numbers
    | MV_EXPAND value
    | WHERE value <= 5
    | STATS count=COUNT() BY value
    | SORT value
;

count:long | value:integer | CONFIDENCE_INTERVAL(count):long | CERTIFIED(count):boolean 
1          | 1             | [1, 1]                          | true
2          | 2             | [2, 2]                          | true
3          | 3             | [3, 3]                          | true
4          | 4             | [4, 4]                          | true
5          | 5             | [5, 5]                          | true
;

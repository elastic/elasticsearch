###############################################
# Tests for Match function
#

matchWithField
required_capability: match_operator_colon

// tag::match-with-field[]
FROM books 
| WHERE author:"Faulkner"
| KEEP book_no, author 
| SORT book_no 
| LIMIT 5;
// end::match-with-field[]

// tag::match-with-field-result[]
book_no:keyword | author:text
2378            | [Carol Faulkner, Holly Byers Ochoa, Lucretia Mott]
2713            | William Faulkner
2847            | Colleen Faulkner
2883            | William Faulkner
3293            | Danny Faulkner
;
// end::match-with-field-result[]

matchWithMultipleFunctions
required_capability: match_operator_colon

from books 
| where title:"Return" AND author:"Tolkien"  
| keep book_no, title;
ignoreOrder:true

book_no:keyword | title:text
2714            | Return of the King Being the Third Part of The Lord of the Rings
7350            | Return of the Shadow
;

matchAfterKeep
required_capability: match_operator_colon

from books 
| keep book_no, author 
| where author:"Faulkner"
| sort book_no 
| limit 5;

book_no:keyword | author:text
2378            | [Carol Faulkner, Holly Byers Ochoa, Lucretia Mott]
2713            | William Faulkner
2847            | Colleen Faulkner
2883            | William Faulkner
3293            | Danny Faulkner
;

matchAfterDrop
required_capability: match_operator_colon

from books 
| drop ratings, description, year, publisher, title, author.keyword
| where author:"Faulkner"
| keep book_no, author
| sort book_no 
| limit 5;

book_no:keyword | author:text
2378            | [Carol Faulkner, Holly Byers Ochoa, Lucretia Mott]
2713            | William Faulkner
2847            | Colleen Faulkner
2883            | William Faulkner
3293            | Danny Faulkner
;

matchAfterEval
required_capability: match_operator_colon

from books 
| eval stars = to_long(ratings / 2.0) 
| where author:"Faulkner"
| sort book_no 
| keep book_no, author, stars
| limit 5;

book_no:keyword | author:text                                           | stars:long
2378            | [Carol Faulkner, Holly Byers Ochoa, Lucretia Mott]    | 3
2713            | William Faulkner                                      | 2
2847            | Colleen Faulkner                                      | 3
2883            | William Faulkner                                      | 2
3293            | Danny Faulkner                                        | 2
;

matchWithConjunction
required_capability: match_operator_colon

from books 
| where title:"Rings" and ratings > 4.6
| keep book_no, title;
ignoreOrder:true

book_no:keyword | title:text
4023            |A Tolkien Compass: Including J. R. R. Tolkien's Guide to the Names in The Lord of the Rings
7140            |The Lord of the Rings Poster Collection: Six Paintings by Alan Lee (No. 1)     
;

matchWithFunctionPushedToLucene
required_capability: match_operator_colon

from hosts 
| where host:"beta" and cidr_match(ip1, "127.0.0.2/32", "127.0.0.3/32") 
| keep card, host, ip0, ip1;
ignoreOrder:true

card:keyword   |host:keyword   |ip0:ip                   |ip1:ip
eth1           |beta           |127.0.0.1                |127.0.0.2
;

matchWithNonPushableConjunction
required_capability: match_operator_colon

from books 
| where title:"Rings" and length(title) > 75
| keep book_no, title;
ignoreOrder:true

book_no:keyword | title:text
4023            | A Tolkien Compass: Including J. R. R. Tolkien's Guide to the Names in The Lord of the Rings
;

matchWithMultipleWhereClauses
required_capability: match_operator_colon

from books 
| where title:"rings" 
| where title:"lord" 
| keep book_no, title;
ignoreOrder:true

book_no:keyword | title:text
2675            | The Lord of the Rings - Boxed Set           
2714            | Return of the King Being the Third Part of The Lord of the Rings
4023            | A Tolkien Compass: Including J. R. R. Tolkien's Guide to the Names in The Lord of the Rings
7140            | The Lord of the Rings Poster Collection: Six Paintings by Alan Lee (No. 1)
;

matchMultivaluedField
required_capability: match_operator_colon

from employees 
| where job_positions:"Tech Lead" and job_positions:"Reporting Analyst"
| keep emp_no, first_name, last_name;
ignoreOrder:true

emp_no:integer | first_name:keyword | last_name:keyword
10004          | Chirstian          | Koblick        
10010          | Duangkaew          | Piveteau       
10011          | Mary               | Sluis          
10088          | Jungsoon           | Syrzycki       
10093          | Sailaja            | Desikan        
10097          | Remzi              | Waschkowski    
;

testMultiValuedFieldWithConjunction
required_capability: match_operator_colon

from employees 
| where job_positions:"Data Scientist" and job_positions:"Support Engineer"
| keep emp_no, first_name, last_name;
ignoreOrder:true

emp_no:integer | first_name:keyword | last_name:keyword  
10043          | Yishay             | Tzvieli      
;

testMatchAndQueryStringFunctions
required_capability: match_operator_colon
required_capability: qstr_function

from employees 
| where job_positions:"Data Scientist" and qstr("job_positions: (Support Engineer) and gender: F")
| keep emp_no, first_name, last_name;
ignoreOrder:true

emp_no:integer | first_name:keyword | last_name:keyword  
10041          | Uri                 | Lenart         
10043          | Yishay              | Tzvieli        
;

combinedMatchWithFunctions
required_capability: match_operator_colon

from books
| where title:"Tolkien" AND author:"Tolkien" AND year > 2000
| where mv_count(author) == 1
| keep book_no, title, author, year
| sort book_no
;

book_no:keyword | title:text               | author:text    | year:integer
5335            | Letters of J R R Tolkien | J.R.R. Tolkien | 2014
;

matchWithStats
required_capability: match_operator_colon

from books
| where author:"faulkner" AND year > 1990
| where mv_count(author) == 1
| stats count(*) BY author.keyword
| sort author.keyword
;

count(*): long  | author.keyword:keyword
1               | Bettilu Stein Faulkner
2               | Colleen Faulkner
1               | Danny Faulkner
1               | Keith Faulkner
1               | Paul Faulkner
8               | William Faulkner
;

singleMatchWithTextFieldScoring
required_capability: metadata_score
required_capability: match_operator_colon

from books metadata _score 
| where author:"William Faulkner" 
| sort book_no 
| keep author, _score 
| LIMIT 5;

author:text | _score:double
William Faulkner                                   | 4.272439002990723
William Faulkner                                   | 4.272439002990723
William Faulkner                                   | 4.272439002990723
William Faulkner                                   | 4.272439002990723
William Faulkner                                   | 4.272439002990723
;

singleMatchWithKeywordFieldScoring
required_capability: metadata_score
required_capability: match_operator_colon

from books metadata _score 
| where author.keyword:"William Faulkner" 
| keep book_no, author, _score 
| sort book_no;

book_no:keyword | author:text | _score:double
2713            | William Faulkner | 2.3142893314361572
2883            | William Faulkner | 2.3142893314361572
4724            | William Faulkner | 2.3142893314361572
4977            | William Faulkner | 2.3142893314361572
5119            | William Faulkner | 2.3142893314361572
5404            | William Faulkner | 2.3142893314361572
5578            | William Faulkner | 2.3142893314361572
8077            | William Faulkner | 2.3142893314361572
9896            | William Faulkner | 2.3142893314361572
;

multipleMatchScoring-Ignore
required_capability: metadata_score
required_capability: match_operator_colon

from books metadata _score
| where (description:"Sauron" OR description:"Dark Lord") AND
  (author:"J. R. R. Tolkien" OR author:"John Ronald Reuel Tolkien")
| keep book_no, title, author, _score
| sort book_no
| limit 3
;

book_no:keyword | title:text                                                       | author:text               | _score:double
1463            | Realms of Tolkien: Images of Middle-earth                        | J. R. R. Tolkien          | 12.25712776184082
2714            | Return of the King Being the Third Part of The Lord of the Rings | J. R. R. Tolkien          | 17.39082145690918
2936            | Fellowship of the Ring 2ND Edition                               | John Ronald Reuel Tolkien | 15.420738220214844
;

multipleWhereWithMatchScoring
required_capability: metadata_score
required_capability: match_operator_colon

from books metadata _score
| where title:"short stories"
| where author:"Ursula K. Le Guin"
| keep book_no, title, author, _score
| sort book_no;

book_no:keyword | title:text                                | author:text        | _score:double
8480            | The wind's twelve quarters: Short stories | Ursula K. Le Guin  | 14.489097595214844
;

multipleWhereWithMatchScoringNoSort
required_capability: metadata_score
required_capability: match_operator_colon

from books metadata _score
| where title:"short stories"
| where author:"Ursula K. Le Guin"
| keep book_no, title, author, _score;

ignoreOrder:true
book_no:keyword | title:text                                | author:text        | _score:double
8480            | The wind's twelve quarters: Short stories | Ursula K. Le Guin  | 14.489097595214844
;

combinedMatchWithFunctionsScoring
required_capability: metadata_score
required_capability: match_operator_colon

from books metadata _score
| where title:"Tolkien" AND author:"Tolkien" AND year > 2000
| where mv_count(author) == 1
| keep book_no, title, author, year, _score
| sort book_no;

book_no:keyword | title:text               | author:text    | year:integer | _score:double
5335            | Letters of J R R Tolkien | J.R.R. Tolkien | 2014         | 5.448054313659668
;

combinedMatchWithFunctionsScoringNoSort
required_capability: metadata_score
required_capability: match_operator_colon

from books metadata _score
| where title:"Tolkien" AND author:"Tolkien" AND year > 2000
| where mv_count(author) == 1
| keep book_no, title, author, year, _score;

ignoreOrder:true
book_no:keyword | title:text               | author:text    | year:integer | _score:double
5335            | Letters of J R R Tolkien | J.R.R. Tolkien | 2014         | 5.448054313659668
;

combinedMatchWithScoringEval
required_capability: metadata_score
required_capability: match_operator_colon

from books metadata _score
| where title:"Tolkien" AND author:"Tolkien" AND year > 2000
| where mv_count(author) == 1
| eval c_score = ceil(_score)
| keep book_no, title, author, year, c_score
| sort book_no;

book_no:keyword | title:text               | author:text    | year:integer | c_score:double
5335            | Letters of J R R Tolkien | J.R.R. Tolkien | 2014         | 6
;

combinedMatchWithScoringEvalNoSort
required_capability: metadata_score
required_capability: match_operator_colon

from books metadata _score
| where title:"Tolkien" AND author:"Tolkien" AND year > 2000
| where mv_count(author) == 1
| eval c_score = ceil(_score)
| keep book_no, title, author, year, c_score;

ignoreOrder:true
book_no:keyword | title:text               | author:text    | year:integer | c_score:double
5335            | Letters of J R R Tolkien | J.R.R. Tolkien | 2014         | 6
;

###############################################
# Tests for QSTR function
#

qstrWithField
required_capability: qstr_function

// tag::qstr-with-field[]
from books 
| where qstr("author: Faulkner")
| keep book_no, author 
| sort book_no 
| limit 5;
// end::qstr-with-field[]

// tag::qstr-with-field-result[]
book_no:keyword | author:text
2378            | [Carol Faulkner, Holly Byers Ochoa, Lucretia Mott]
2713            | William Faulkner
2847            | Colleen Faulkner
2883            | William Faulkner
3293            | Danny Faulkner
;
// end::qstr-with-field-result[]

qstrWithMultipleFields
required_capability: qstr_function

from books 
| where qstr("title:Return* AND author:*Tolkien")  
| keep book_no, title;
ignoreOrder:true

book_no:keyword | title:text
2714            | Return of the King Being the Third Part of The Lord of the Rings
7350            | Return of the Shadow
;

qstrWithQueryExpressions
required_capability: qstr_function

from books 
| where qstr(CONCAT("title:Return*", " AND author:*Tolkien"))  
| keep book_no, title;
ignoreOrder:true

book_no:keyword | title:text
2714            | Return of the King Being the Third Part of The Lord of the Rings
7350            | Return of the Shadow
;

qstrWithDisjunction
required_capability: qstr_function

from books 
| where qstr("title:Return") or year > 2020
| keep book_no, title;
ignoreOrder:true

book_no:keyword | title:text
2714            | Return of the King Being the Third Part of The Lord of the Rings
6818            | Hadji Murad                                                     
7350            | Return of the Shadow         
;

qstrWithConjunction
required_capability: qstr_function

from books 
| where qstr("title: Rings") and ratings > 4.6
| keep book_no, title;
ignoreOrder:true

book_no:keyword | title:text
4023            |A Tolkien Compass: Including J. R. R. Tolkien's Guide to the Names in The Lord of the Rings
7140            |The Lord of the Rings Poster Collection: Six Paintings by Alan Lee (No. 1)     
;

qstrWithFunctionPushedToLucene
required_capability: qstr_function

from hosts 
| where qstr("host: beta") and cidr_match(ip1, "127.0.0.2/32", "127.0.0.3/32") 
| keep card, host, ip0, ip1;
ignoreOrder:true

card:keyword   |host:keyword   |ip0:ip                   |ip1:ip
eth1           |beta           |127.0.0.1                |127.0.0.2
;

qstrWithFunctionNotPushedToLucene
required_capability: qstr_function

from books 
| where qstr("title: rings") and length(description) > 600 
| keep book_no, title;
ignoreOrder:true

book_no:keyword | title:text
2675            | The Lord of the Rings - Boxed Set                               
2714            | Return of the King Being the Third Part of The Lord of the Rings     
;

qstrWithMultipleWhereClauses
required_capability: qstr_function

from books 
| where qstr("title: rings") 
| where qstr("year: [1 TO 2005]") 
| keep book_no, title;
ignoreOrder:true

book_no:keyword | title:text
4023            | A Tolkien Compass: Including J. R. R. Tolkien's Guide to the Names in The Lord of the Rings           
7140            | The Lord of the Rings Poster Collection: Six Paintings by Alan Lee (No. 1)
;

qstrWithFieldAndScoringSorted
required_capability: qstr_function
required_capability: metadata_score

// tag::qstr-with-field-scoring-sorted[]
from books metadata _score
| where qstr("title:rings")
| sort _score desc, book_no desc
| keep book_no, title, _score
| limit 3;
// end::qstr-with-field-scoring-sorted[]

// tag::qstr-with-field-scoring-sorted-result[]
book_no:keyword | title:text                                                                 | _score:double 
2675            | The Lord of the Rings - Boxed Set                                          | 2.7583377361297607
7140            | The Lord of the Rings Poster Collection: Six Paintings by Alan Lee (No. 1) | 1.9239964485168457
2714            | Return of the King Being the Third Part of The Lord of the Rings           | 1.9239964485168457
;
// end::qstr-with-field-scoring-sorted-result[]

singleQstrScoring
required_capability: metadata_score
required_capability: qstr_function
from books METADATA _score | where qstr("author:William Faulkner") | keep book_no, author, _score 
| sort book_no | LIMIT 5;

book_no:keyword | author:text | _score:double
2378            | [Carol Faulkner, Holly Byers Ochoa, Lucretia Mott] | 0.9976131916046143
2713            | William Faulkner                                   | 5.9556169509887695
2847            | Colleen Faulkner                                   | 1.7401835918426514
2883            | William Faulkner                                   | 4.272439002990723
3293            | Danny Faulkner                                     | 1.7401835918426514
;

singleQstrScoringManipulated
required_capability: metadata_score
required_capability: qstr_function
from books METADATA _score | where qstr("author:William Faulkner") | eval add_score = _score + 1 
| keep book_no, author, add_score | sort book_no | LIMIT 5;

book_no:keyword | author:text | add_score:double
2378            | [Carol Faulkner, Holly Byers Ochoa, Lucretia Mott] | 1.9976131916046143
2713            | William Faulkner                                   | 6.9556169509887695
2847            | Colleen Faulkner                                   | 2.7401835918426514
2883            | William Faulkner                                   | 5.272439002990723
3293            | Danny Faulkner                                     | 2.7401835918426514
;

singleQstrBoostScoringSorted
required_capability: metadata_score
required_capability: qstr_function
from books METADATA _score | where qstr("author:Lord Rings^2") | keep book_no, title, _score | sort _score desc | LIMIT 3;

book_no:keyword | title:text | _score:double
8875            | The Two Towers | 5.901181697845459
4023            | A Tolkien Compass: Including J. R. R. Tolkien's Guide to the Names in The Lord of the Rings | 5.665572166442871
2675            | The Lord of the Rings - Boxed Set | 5.5166754722595215
;

singleQstrScoringEval
required_capability: metadata_score
required_capability: qstr_function
from books METADATA _score | where qstr("author:Lord Rings") | eval c_score = ceil(_score) | keep book_no, c_score 
| sort book_no desc | LIMIT 3;

book_no:keyword | c_score:double
8875            | 3.0
7350            | 2.0
7140            | 3.0
;

singleQstrScoringGrok
required_capability: metadata_score
required_capability: qstr_function
from books METADATA _score | where qstr("author:Lord Rings") 
| GROK title "%{WORD:title} %{WORD}" 
| sort _score desc | keep book_no, title, _score | LIMIT 3;

book_no:keyword | title:keyword | _score:double
8875            | The | 2.9505908489227295
4023            | A | 2.8327860832214355
2675            | The | 2.7583377361297607
;

singleQstrScoringRename
required_capability: metadata_score
required_capability: qstr_function
from books METADATA _score | where qstr("author:Lord Rings") 
| rename _score as rank | sort rank desc | keep book_no, rank | LIMIT 3;

book_no:keyword | rank:double
8875            | 2.9505908489227295
4023            | 2.8327860832214355
2675            | 2.7583377361297607
;


// Note:
// The "test_reranker" service scores the row from the inputText length and does not really score by relevance.
// This makes the output more predictable which is helpful here.
 

reranker using a single field, overwrite existing _score column
required_capability: rerank
required_capability: match_operator_colon
required_capability: routing_function_update

FROM books METADATA _score
| WHERE title:"war and peace" AND author:"Tolstoy"
| SORT _score DESC, book_no ASC
| RERANK "war and peace" ON title WITH { "inference_id" : "test_reranker" }
| EVAL _score=ROUND(_score, 2)
| KEEP book_no, title, author, _score
;

book_no:keyword | title:text                                            | author:text                                 | _score:double
5327            | War and Peace                                         | Leo Tolstoy                                 | 0.96
9032            | War and Peace: A Novel (6 Volumes)                    | Tolstoy Leo                                 | 0.12
4536            | War and Peace (Signet Classics)                       | [John Hockenberry, Leo Tolstoy, Pat Conroy] | 0.58
2776            | The Devil and Other Stories (Oxford World's Classics) | Leo Tolstoy                                 | 0.95
;

reranker using a single field, create a mew column
required_capability: rerank
required_capability: match_operator_colon
required_capability: routing_function_update

FROM books METADATA _score
| WHERE title:"war and peace" AND author:"Tolstoy"
| SORT _score DESC, book_no ASC
| RERANK rerank_score="war and peace" ON title WITH { "inference_id" : "test_reranker" }
| EVAL _score=ROUND(_score, 2), rerank_score=ROUND(rerank_score, 2)
| KEEP book_no, title, author, rerank_score
;

book_no:keyword | title:text                                            | author:text                                 | rerank_score:double
5327            | War and Peace                                         | Leo Tolstoy                                 | 0.96
9032            | War and Peace: A Novel (6 Volumes)                    | Tolstoy Leo                                 | 0.12
4536            | War and Peace (Signet Classics)                       | [John Hockenberry, Leo Tolstoy, Pat Conroy] | 0.58
2776            | The Devil and Other Stories (Oxford World's Classics) | Leo Tolstoy                                 | 0.95
;

reranker using a single field, create a mew column, sort by rerank_score
required_capability: rerank
required_capability: match_operator_colon
required_capability: routing_function_update

FROM books METADATA _score
| WHERE title:"war and peace" AND author:"Tolstoy"
| SORT _score DESC
| RERANK rerank_score="war and peace" ON title WITH { "inference_id" : "test_reranker" }
| EVAL _score=ROUND(_score, 2), rerank_score=ROUND(rerank_score, 2)
| SORT rerank_score, _score ASC, book_no ASC
| KEEP book_no, title, author, rerank_score
;

book_no:keyword | title:text                                            | author:text                                 | rerank_score:double
9032            | War and Peace: A Novel (6 Volumes)                    | Tolstoy Leo                                 | 0.12
4536            | War and Peace (Signet Classics)                       | [John Hockenberry, Leo Tolstoy, Pat Conroy] | 0.58
2776            | The Devil and Other Stories (Oxford World's Classics) | Leo Tolstoy                                 | 0.95
5327            | War and Peace                                         | Leo Tolstoy                                 | 0.96
;

reranker using a non text field
required_capability: rerank
required_capability: match_operator_colon

FROM books METADATA _score
| WHERE title:"war and peace" AND author:"Tolstoy"
| RERANK "war and peace" ON ratings WITH { "inference_id" : "test_reranker" }
| EVAL _score=ROUND(_score, 2), ratings = ROUND(ratings, 2)
| SORT _score DESC, book_no ASC
| KEEP book_no, title, ratings, _score
;

book_no:keyword | title:text                                            | ratings:double | _score:double
5327            | War and Peace                                         | 3.84           | 0.94
9032            | War and Peace: A Novel (6 Volumes)                    | 3.81           | 0.41
2776            | The Devil and Other Stories (Oxford World's Classics) | 5.0            | 0.0
4536            | War and Peace (Signet Classics)                       | 4.75           | 0.0
;


reranker using a sparse input field
required_capability: rerank
required_capability: match_operator_colon
required_capability: routing_function_update

FROM books METADATA _score
| WHERE MATCH(title, "lord of the rings", {"minimum_should_match": "100%"}) AND author:"tolkien"
| RERANK rerank_score="war and peace" ON collection WITH { "inference_id" : "test_reranker" }
| EVAL _score=ROUND(_score, 2), rerank_score=ROUND(rerank_score, 2)
| SORT rerank_score DESC NULLS LAST, _score  DESC
| LIMIT 3
| KEEP book_no, title, author, collection, rerank_score, _score
;

book_no:keyword | title:text                                                                                  | author:text                                                                      | collection:text       | rerank_score:double | _score:double
2675            | The Lord of the Rings - Boxed Set                                                           | J.R.R. Tolkien                                                                   | The Lord of the Rings | 0.88                | 7.28
2714            | Return of the King Being the Third Part of The Lord of the Rings                            | J. R. R. Tolkien                                                                 | The Lord of the Rings | 0.88                | 7.25
4023            | A Tolkien Compass: Including J. R. R. Tolkien's Guide to the Names in The Lord of the Rings | [Agnes Perkins, Charles Adolph Huttar, John Ronald Reuel Tolkien, Walter Scheps] | null                  | null                | 5.36
;


reranker using multiple fields
required_capability: rerank
required_capability: match_operator_colon

FROM books METADATA _score
| WHERE title:"war and peace" AND author:"Tolstoy"
| RERANK "war and peace" ON title, author WITH { "inference_id" : "test_reranker" }
| EVAL _score=ROUND(_score, 2)
| SORT _score DESC, book_no ASC
| KEEP book_no, title, author, _score
;

book_no:keyword | title:text                                            | author:text                                 | _score:double
5327            | War and Peace                                         | Leo Tolstoy                                 | 0.92
9032            | War and Peace: A Novel (6 Volumes)                    | Tolstoy Leo                                 | 0.89
4536            | War and Peace (Signet Classics)                       | [John Hockenberry, Leo Tolstoy, Pat Conroy] | 0.55
2776            | The Devil and Other Stories (Oxford World's Classics) | Leo Tolstoy                                 | 0.38     
;


reranker using multiple fields with some non text fields
required_capability: rerank
required_capability: match_operator_colon

FROM books METADATA _score
| WHERE title:"war and peace" AND author:"Tolstoy"
| RERANK "war and peace" ON title, ratings WITH { "inference_id" : "test_reranker" }
| EVAL _score=ROUND(_score, 2), ratings = ROUND(ratings, 2)
| SORT _score DESC, book_no ASC
| KEEP book_no, title, ratings, _score
;

book_no:keyword | title:text                                            | ratings:double | _score:double
2776            | The Devil and Other Stories (Oxford World's Classics) | 5.0            | 0.53
9032            | War and Peace: A Novel (6 Volumes)                    | 3.81           | 0.35
4536            | War and Peace (Signet Classics)                       | 4.75           | 0.24
5327            | War and Peace                                         | 3.84           | 0.08 
;


reranker after a limit
required_capability: rerank
required_capability: match_operator_colon

FROM books METADATA _score
| WHERE title:"war and peace" AND author:"Tolstoy"
| SORT _score DESC, book_no ASC
| LIMIT 3
| RERANK "war and peace" ON title WITH { "inference_id" : "test_reranker" }
| EVAL _score=ROUND(_score, 2)
| SORT _score DESC, book_no ASC
| KEEP book_no, title, author, _score
;

book_no:keyword | title:text                         | author:text                                 | _score:double
5327            | War and Peace                      | Leo Tolstoy                                 | 0.96
4536            | War and Peace (Signet Classics)    | [John Hockenberry, Leo Tolstoy, Pat Conroy] | 0.58
9032            | War and Peace: A Novel (6 Volumes) | Tolstoy Leo                                 | 0.12
;


reranker before a limit
required_capability: rerank
required_capability: match_operator_colon

FROM books METADATA _score
| WHERE title:"war and peace" AND author:"Tolstoy"
| RERANK "war and peace" ON title WITH { "inference_id" : "test_reranker" }
| EVAL _score=ROUND(_score, 2)
| SORT _score DESC, book_no ASC
| KEEP book_no, title, author, _score
| LIMIT 3
;

book_no:keyword | title:text                                            | author:text                                 | _score:double
5327            | War and Peace                                         | Leo Tolstoy                                 | 0.96
2776            | The Devil and Other Stories (Oxford World's Classics) | Leo Tolstoy                                 | 0.95
4536            | War and Peace (Signet Classics)                       | [John Hockenberry, Leo Tolstoy, Pat Conroy] | 0.58
;


reranker using another sort order
required_capability: rerank
required_capability: match_operator_colon

FROM books
| WHERE title:"war and peace" AND author:"Tolstoy"
| RERANK "war and peace" ON title WITH { "inference_id" : "test_reranker" }
| EVAL _score=ROUND(_score, 2)
| KEEP book_no, title, author, _score
| SORT author, title 
| LIMIT 3
;

book_no:keyword | title:text                                            | author:text                                 | _score:double
4536            | War and Peace (Signet Classics)                       | [John Hockenberry, Leo Tolstoy, Pat Conroy] | 0.58
2776            | The Devil and Other Stories (Oxford World's Classics) | Leo Tolstoy                                 | 0.95
5327            | War and Peace                                         | Leo Tolstoy                                 | 0.96
;


reranker after FUSE
required_capability: fork_v9
required_capability: fuse_v6
required_capability: match_operator_colon
required_capability: rerank
required_capability: routing_function_update

FROM books METADATA _id, _index, _score
| FORK ( WHERE title:"Tolkien" | SORT _score, _id DESC | LIMIT 3 )
       ( WHERE author:"Tolkien" | SORT _score, _id DESC | LIMIT 3 )
| FUSE
| RERANK "Tolkien" ON title WITH { "inference_id" : "test_reranker" }
| EVAL _score=ROUND(_score, 2)
| SORT _score DESC, book_no ASC
| LIMIT 2
| KEEP book_no, title, author, _score
;

book_no:keyword | title:keyword                         | author:keyword                                   | _score:double
5335            | Letters of J R R Tolkien              | J.R.R. Tolkien                                   | 0.64
2130            | The J. R. R. Tolkien Audio Collection | [Christopher Tolkien, John Ronald Reuel Tolkien] | 0.57
;

simple
required_capability: rerank
required_capability: routing_function_update

// tag::simple-query[]
FROM books METADATA _score
| WHERE MATCH(description, "hobbit")
| SORT _score DESC
| LIMIT 100
| RERANK "hobbit" ON description WITH { "inference_id" : "test_reranker" }
| EVAL _score=ROUND(_score, 2)
| LIMIT 3
| KEEP title, _score
// end::simple-query[]
;

// tag::simple-query-result[]
title:text                        | _score:double
Poems from the Hobbit             | 0.86
The Lord of the Rings - Boxed Set | 0.30
Letters of J R R Tolkien          | 0.35
// end::simple-query-result[]
;

two_queries
required_capability: rerank
required_capability: routing_function_update

// tag::two-queries[]
FROM books METADATA _id, _score
| WHERE MATCH(description, "hobbit") OR MATCH(author, "Tolkien")
| SORT _score DESC
| LIMIT 100
| RERANK rerank_score = "hobbit" ON description, author WITH { "inference_id" : "test_reranker" }
| EVAL rerank_score=ROUND(rerank_score, 2), _score=ROUND(_score, 2)
| SORT rerank_score, _id
| LIMIT 3
| KEEP title, _score, rerank_score
// end::two-queries[]
;

// tag::two-queries-result[]
title:text                                   | _score:double | rerank_score:double
The Two Towers                               | 1.29          | 0.05
Smith of Wooten Manor & Farmer Giles of Ham  | 2.59          | 0.14
Smith of Wootton Major & Farmer Giles of Ham | 2.59          | 0.14
// end::two-queries-result[]
;

combine
required_capability: rerank

// tag::combine[]
FROM books METADATA _score
| WHERE MATCH(description, "hobbit") OR MATCH(author, "Tolkien")
| SORT _score DESC
| LIMIT 100
| RERANK rerank_score = "hobbit" ON description, author WITH { "inference_id" : "test_reranker" }
| EVAL original_score = ROUND(_score, 2), rerank_score=ROUND(rerank_score, 2), _score = rerank_score + original_score
| SORT _score
| LIMIT 3
| KEEP title, original_score, rerank_score, _score
// end::combine[]
;

// tag::combine-result[]
title:text                                                                 | original_score:double | rerank_score:double | _score:double
The Lord of the Rings Poster Collection: Six Paintings by Alan Lee (No. 1) | 0.80                  | 0.19                | 0.99
A Middle English Reader and Vocabulary                                     | 1.04                  | 0.22                | 1.26
The Two Towers                                                             | 1.29                  | 0.05                | 1.34
// end::combine-result[]
;

reranker followed by stats
required_capability: rerank
required_capability: match_operator_colon

FROM books METADATA _score
| WHERE title:"war and peace" AND author:"Tolstoy"
| SORT _score DESC, book_no ASC
| RERANK "war and peace" ON title WITH { "inference_id" : "test_reranker" }
| STATS count_book = COUNT(*) WHERE _score >= 0.5
;

count_book:long
3
;

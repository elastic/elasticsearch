// Tests focused on the SAMPLE command
// Note: this tests only basic behavior, because of limitations of the CSV tests.
// Most tests assert that the count, average and sum of some values are within a
// range. All ranges are very loose, so that the tests should practically never fail.

row
required_capability: sample_v3

ROW x = 1 | SAMPLE .999999999
;

x:integer
1
;


row and mv_expand
required_capability: sample_v3

ROW x = [1,2,3,4,5] | MV_EXPAND x | SAMPLE .999999999
;

x:integer
1
2
3
4
5
;


adjust stats for sampling
required_capability: sample_v3

FROM employees
  | SAMPLE 0.5
  | STATS count = COUNT(), avg_emp_no = AVG(emp_no), sum_emp_no = SUM(emp_no)
;

count:long | avg_emp_no:double | sum_emp_no:long
5..95      | 10010.0..10090.0  | 100100..908100
;


before where
required_capability: sample_v3

FROM employees
  | SAMPLE 0.5
  | WHERE emp_no > 10050 
  | STATS count = COUNT(), avg_emp_no = AVG(emp_no)
;

count:long | avg_emp_no:double
1..49      | 10051..10100
;


after where
required_capability: sample_v3

FROM employees
  | WHERE emp_no <= 10050 
  | SAMPLE 0.5
  | STATS count = COUNT(), avg_emp_no = AVG(emp_no)
;

count:long | avg_emp_no:double
1..49      | 10001..10050
;


before sort
required_capability: sample_v3

FROM employees
  | SAMPLE 0.5
  | SORT emp_no
  | STATS count = COUNT(), avg_emp_no = AVG(emp_no)
;

count:long | avg_emp_no:double
5..95      | 10010..10090
;


after sort
required_capability: sample_v3

FROM employees
  | SORT emp_no
  | SAMPLE 0.5
  | STATS count = COUNT(), avg_emp_no = AVG(emp_no)
;

count:long | avg_emp_no:double
5..95      | 10010..10090
;


before limit
required_capability: sample_v3

FROM employees
  | SAMPLE 0.5
  | LIMIT 10
  | STATS count = COUNT(emp_no)
;

count:long
10
;


after limit
required_capability: sample_v3

FROM employees
  | LIMIT 50
  | SAMPLE 0.5
  | STATS count = COUNT(emp_no)
;

count:long
2..48
;


before mv_expand
required_capability: sample_v3

ROW x = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50], y = [1,2]
  | MV_EXPAND x
  | SAMPLE 0.85
  | MV_EXPAND y
  | STATS count = COUNT() BY x
  | STATS counts = VALUES(count)

;

counts:long
2
;


after mv_expand
required_capability: sample_v3

ROW x = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50], y = [1,2]
  | MV_EXPAND x
  | MV_EXPAND y
  | SAMPLE 0.85
  | STATS count = COUNT() BY x
  | STATS counts = MV_SORT(VALUES(count))
;

counts:long
[1,2]
;


multiple samples
required_capability: sample_v3

FROM employees
  | SAMPLE 0.7
  | SAMPLE 0.8
  | SAMPLE 0.9
  | STATS count = COUNT(), avg_emp_no = AVG(emp_no)
;

count:long | avg_emp_no:double
5..95      | 10010..10090
;


after stats
required_capability: sample_v3

FROM employees
  | SAMPLE 0.5
  | STATS avg_salary = AVG(salary) BY job_positions
  | SAMPLE 0.8
  | STATS count = COUNT(), avg_avg_salary = AVG(avg_salary)
;

count:long | avg_avg_salary:double
1..16      | 25000..75000
;


example for docs
required_capability: sample_v3

// tag::sampleForDocs[]
FROM employees
| KEEP emp_no
| SAMPLE 0.05
// end::sampleForDocs[]
// Hardcode the sample values to work around the limitations of the CSV tests in the 
// presence of randomness, and be able to specify an expected result for the docs.
| STATS emp_no = COUNT()
| EVAL emp_no = [10018, 10024, 10062, 10081]
| MV_EXPAND emp_no
;

// tag::sampleForDocs-result[]
emp_no:integer
10018
10024
10062
10081
// end::sampleForDocs-result[]
;


sampleStatsEval
required_capability: fix_no_columns
required_capability: sample_v3

FROM employees | SAMPLE 0.5 | LIMIT 10 | STATS count = COUNT() | EVAL is_expected = count > 0;

count:long | is_expected:boolean
10         | true
;

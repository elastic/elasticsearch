setup:
  - do:
      indices.create:
        index: test-timeout
        body:
          settings:
            number_of_shards: "1"
            refresh_interval: "-1"

  - do:
      indices.create:
        index: test-after-refresh
        body:
          settings:
            number_of_shards: "1"

  - do:
      indices.put_alias:
        index: test-after-refresh
        name: test-alias

  - do:
      index:
        index: test-timeout
        body: { }

  - do:
      index:
        index:  test-after-refresh
        body:   { }

  - do:
      index:
        index: test-after-refresh
        body: { }

  - do:
      indices.refresh: {}

---
"Execute successful after refresh search":
  - do:
      fleet.search:
        index: "test-after-refresh"
        allow_partial_search_results: false
        wait_for_checkpoints: [1]
        body: { query: { match_all: {} } }

  - match: { _shards.successful: 1 }
  - match: { hits.total.value: 2 }

---
"Cannot use alias":
  - do:
      catch: bad_request
      fleet.search:
        index: "test-alias"
        allow_partial_search_results: false
        wait_for_checkpoints: [1]
        body: { query: { match_all: {} } }

---
"After refresh timeout":
  - do:
      fleet.search:
        index: "test-timeout"
        allow_partial_search_results: true
        wait_for_checkpoints: [0]
        wait_for_checkpoints_timeout: "50ms"
        body: { query: { match_all: { } } }

  - do:
      index:
        index: test-timeout
        body: {}

  - do:
      catch: request
      fleet.search:
        index: "test-timeout"
        allow_partial_search_results: true
        wait_for_checkpoints: [ 1 ]
        wait_for_checkpoints_timeout: "50ms"
        body: { query: { match_all: { } } }

---
"Wait for unprocessed checkpoint fails":
  - do:
      catch: bad_request
      fleet.search:
        index: "test-after-refresh"
        allow_partial_search_results: false
        wait_for_checkpoints: [2]
        body: { query: { match_all: {} } }

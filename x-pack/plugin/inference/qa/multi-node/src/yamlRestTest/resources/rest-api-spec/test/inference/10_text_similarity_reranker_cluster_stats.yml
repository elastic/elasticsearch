setup:
  - skip:
      features:
        - close_to
  - requires:
      test_runner_features: "close_to"

  - do:
      inference.put:
        task_type: rerank
        inference_id: my-rerank-model
        body: >
          {
            "service": "test_reranking_service",
            "service_settings": {
              "model_id": "my_model",
              "api_key": "abc64"
            },
            "task_settings": {
            }
          }

  - do:
      inference.put:
        task_type: sparse_embedding
        inference_id: sparse-inference-id
        body: >
          {
            "service": "test_service",
            "service_settings": {
              "model": "my_model",
              "api_key": "abc64"
            },
            "task_settings": {
            }
          }

  - do:
      indices.create:
        index: test-index
        body:
          mappings:
            properties:
              text:
                type: text
                copy_to: semantic_text_field
              topic:
                type: keyword
              subtopic:
                type: keyword
              inference_text_field:
                type: text
              semantic_text_field:
                type: semantic_text
                inference_id: sparse-inference-id
                chunking_settings:
                  strategy: word
                  max_chunk_size: 10
                  overlap: 1

  - do:
      index:
        index: test-index
        id: doc_2
        body:
          text: "The phases of the Moon come from the position of the Moon relative to the Earth and Sun."
          topic: [ "science" ]
          subtopic: [ "astronomy" ]
          inference_text_field: "0"
        refresh: true

  - do:
      index:
        index: test-index
        id: doc_3
        body:
          text: "Sun Moon Lake is a lake in Nantou County, Taiwan. It is the largest lake in Taiwan."
          topic: [ "geography" ]
          inference_text_field: "1"
        refresh: true

  - do:
      index:
        index: test-index
        id: doc_1
        body:
          text: "As seen from Earth, a solar eclipse happens when the Moon is directly between the Earth and the Sun."
          topic: [ "science" ]
          subtopic: [ "technology" ]
          inference_text_field: "-1"
        refresh: true

---
"Reranking based on rescore_chunks on a semantic_text field specifying chunk size":

  - do:
      search:
        index: test-index
        body:
          track_total_hits: true
          fields: [ "text", "semantic_text_field", "topic" ]
          retriever:
            text_similarity_reranker:
              retriever:
                standard:
                  query:
                    match:
                      topic:
                        query: "science"
              rank_window_size: 10
              inference_id: my-rerank-model
              inference_text: "how often does the moon hide the sun?"
              field: semantic_text_field
              chunk_rescorer:
                chunk_size: 20
          size: 10

  - match: { hits.total.value: 2 }
  - length: { hits.hits: 2 }

  - match: { hits.hits.0._id: "doc_1" }
  - match: { hits.hits.1._id: "doc_2" }

  - do:
      cluster.stats: {}

  - not_exists: _nodes.failures
  - exists: indices.search.extended.retrievers.text_similarity_reranker.chunk_rescorer


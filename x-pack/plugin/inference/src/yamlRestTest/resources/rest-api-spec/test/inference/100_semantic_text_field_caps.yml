setup:
  - requires:
      cluster_features: "semantic_text.filter_field_caps_fix"
      reason: "fixed bug with semantic query filtering in field_caps (#116106)"

  - do:
      inference.put:
        task_type: sparse_embedding
        inference_id: sparse-inference-id
        body: >
          {
            "service": "test_service",
            "service_settings": {
              "model": "my_model",
              "api_key": "abc64"
            },
            "task_settings": {
            }
          }

  - do:
      indices.create:
        index: test-index
        body:
          mappings:
            properties:
              semantic_text_field:
                type: semantic_text
                inference_id: sparse-inference-id
              std_text_field:
                type: text

  - do:
      index:
        index: test-index
        id: doc_1
        body:
          semantic_text_field: "This is a story about a cat and a dog."
          std_text_field: "some text"
        refresh: true

---
"Field caps with semantic_text filter does not fail":
  - do:
      field_caps:
        index: test-index
        fields: "*"
        body:
          index_filter:
            semantic:
              field: "semantic_text_field"
              query: "test"

  - match: { indices: [ "test-index" ] }
  - match: { fields.semantic_text_field.text.searchable: true }
  - match: { fields.std_text_field.text.searchable: true }

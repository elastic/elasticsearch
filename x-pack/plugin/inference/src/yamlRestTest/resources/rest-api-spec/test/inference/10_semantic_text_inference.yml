setup:
  - skip:
      version: " - 8.12.99"
      reason: semantic field type introduced in 8.13.0 # TODO change when 8.13.0 is released

  - do:
      inference.put_model:
        task_type: sparse_embedding
        inference_id: sparse-inference-id
        body: >
          {
            "service": "test_service",
            "service_settings": {
              "model": "my_model",
              "api_key": "abc64"
            },
            "task_settings": {
            }
          }
  - do:
      inference.put_model:
        task_type: text_embedding
        inference_id: dense-inference-id
        body: >
          {
            "service": "text_embedding_test_service",
            "service_settings": {
              "model": "my_model",
              "dimensions": 10,
              "similarity": "cosine",
              "api_key": "abc64"
            },
            "task_settings": {
            }
          }

  - do:
      indices.create:
        index: test-sparse-index
        body:
          mappings:
            properties:
              inference_field:
                type: semantic
                inference_id: sparse-inference-id
              another_inference_field:
                type: semantic
                inference_id: sparse-inference-id
              non_inference_field:
                type: text

  - do:
      indices.create:
        index: test-dense-index
        body:
          mappings:
            properties:
              inference_field:
                type: semantic
                inference_id: dense-inference-id
              another_inference_field:
                type: semantic
                inference_id: dense-inference-id
              non_inference_field:
                type: text

---
"Calculates text expansion results for new documents":
    - do:
        index:
          index: test-sparse-index
          id: doc_1
          body:
            inference_field: "inference test"
            another_inference_field: "another inference test"
            non_inference_field: "non inference test"

    - do:
        get:
          index: test-sparse-index
          id: doc_1

    - match: { _source.inference_field: "inference test" }
    - match: { _source.another_inference_field: "another inference test" }
    - match: { _source.non_inference_field: "non inference test" }

    - match: { _source._inference.inference_field.chunks.0.text: "inference test" }
    - match: { _source._inference.another_inference_field.chunks.0.text: "another inference test" }

    - exists: _source._inference.inference_field.chunks.0.inference
    - exists: _source._inference.another_inference_field.chunks.0.inference

---
"text expansion documents do not create new mappings":
  - do:
      indices.get_mapping:
        index: test-sparse-index

  - match: {test-sparse-index.mappings.properties.inference_field.type: semantic}
  - match: {test-sparse-index.mappings.properties.another_inference_field.type: semantic}
  - match: {test-sparse-index.mappings.properties.non_inference_field.type: text}
  - length: {test-sparse-index.mappings.properties: 3}

---
"Calculates text embeddings results for new documents":
  - do:
      index:
        index: test-dense-index
        id: doc_1
        body:
          inference_field: "inference test"
          another_inference_field: "another inference test"
          non_inference_field: "non inference test"

  - do:
      get:
        index: test-dense-index
        id: doc_1

  - match: { _source.inference_field: "inference test" }
  - match: { _source.another_inference_field: "another inference test" }
  - match: { _source.non_inference_field: "non inference test" }

  - match: { _source._inference.inference_field.chunks.0.text: "inference test" }
  - match: { _source._inference.another_inference_field.chunks.0.text: "another inference test" }

  - exists: _source._inference.inference_field.chunks.0.inference
  - exists: _source._inference.another_inference_field.chunks.0.inference


---
"text embeddings documents do not create new mappings":
  - do:
      indices.get_mapping:
        index: test-dense-index

  - match: {test-dense-index.mappings.properties.inference_field.type: semantic}
  - match: {test-dense-index.mappings.properties.another_inference_field.type: semantic}
  - match: {test-dense-index.mappings.properties.non_inference_field.type: text}
  - length: {test-dense-index.mappings.properties: 3}

---
"Updating non semantic fields does not recalculate embeddings":
    - do:
        index:
          index: test-sparse-index
          id: doc_1
          body:
            inference_field: "inference test"
            another_inference_field: "another inference test"
            non_inference_field: "non inference test"

    - do:
        get:
          index: test-sparse-index
          id: doc_1

    - set: { _source._inference.inference_field.chunks.0.inference: inference_field_embedding }
    - set: { _source._inference.another_inference_field.chunks.0.inference: another_inference_field_embedding }

    - do:
        update:
          index: test-sparse-index
          id: doc_1
          body:
            doc:
              non_inference_field: "another non inference test"

    - do:
        get:
          index: test-sparse-index
          id: doc_1

    - match:  { _source.inference_field: "inference test" }
    - match:  { _source.another_inference_field: "another inference test" }
    - match:  { _source.non_inference_field: "another non inference test" }

    - length: { _source._inference: 2 }
    - match:  { _source._inference.inference_field.chunks.0.text: "inference test" }
    - match:  { _source._inference.another_inference_field.chunks.0.text: "another inference test" }

    - match:  { _source._inference.inference_field.chunks.0.inference: $inference_field_embedding }
    - match:  { _source._inference.another_inference_field.chunks.0.inference: $another_inference_field_embedding }

---
"Updating semantic fields recalculates embeddings":
    - do:
        index:
          index: test-sparse-index
          id: doc_1
          body:
            inference_field: "inference test"
            another_inference_field: "another inference test"
            non_inference_field: "non inference test"

    - do:
        get:
          index: test-sparse-index
          id: doc_1

    - match:  { _source.inference_field: "inference test" }
    - match:  { _source.another_inference_field: "another inference test" }
    - match:  { _source.non_inference_field: "non inference test" }
    - length: { _source._inference: 2 }
    - match:  { _source._inference.inference_field.chunks.0.text: "inference test" }
    - match:  { _source._inference.another_inference_field.chunks.0.text: "another inference test" }

    - do:
        bulk:
          index: test-sparse-index
          body:
            - '{"update": {"_id": "doc_1"}}'
            - '{"doc":{"inference_field": "I am a test", "another_inference_field": "I am a teapot"}}'

    - do:
        get:
          index: test-sparse-index
          id: doc_1

    - match:  { _source.inference_field: "I am a test" }
    - match:  { _source.another_inference_field: "I am a teapot" }
    - match:  { _source.non_inference_field: "non inference test" }
    - length: { _source._inference: 2 }
    - match:  { _source._inference.inference_field.chunks.0.text: "I am a test" }
    - match:  { _source._inference.another_inference_field.chunks.0.text: "I am a teapot" }

    - do:
        update:
          index: test-sparse-index
          id: doc_1
          body:
            doc:
              inference_field: "updated inference test"
              another_inference_field: "another updated inference test"

    - do:
        get:
          index: test-sparse-index
          id: doc_1

    - match:  { _source.inference_field: "updated inference test" }
    - match:  { _source.another_inference_field: "another updated inference test" }
    - match:  { _source.non_inference_field: "non inference test" }
    - length: { _source._inference: 2 }
    - match:  { _source._inference.inference_field.chunks.0.text: "updated inference test" }
    - match:  { _source._inference.another_inference_field.chunks.0.text: "another updated inference test" }

    - do:
        bulk:
          index: test-sparse-index
          body:
            - '{"update": {"_id": "doc_1"}}'
            - '{"doc":{"inference_field": "bulk inference test", "another_inference_field": "bulk updated inference test"}}'

    - do:
        get:
          index: test-sparse-index
          id: doc_1

    - match:  { _source.inference_field: "bulk inference test" }
    - match:  { _source.another_inference_field: "bulk updated inference test" }
    - match:  { _source.non_inference_field: "non inference test" }
    - length: { _source._inference: 2 }
    - match:  { _source._inference.inference_field.chunks.0.text: "bulk inference test" }
    - match:  { _source._inference.another_inference_field.chunks.0.text: "bulk updated inference test" }

---
"Reindex works for semantic fields":
  - do:
      index:
        index: test-sparse-index
        id: doc_1
        body:
          inference_field: "inference test"
          another_inference_field: "another inference test"
          non_inference_field: "non inference test"

  - do:
      get:
        index: test-sparse-index
        id: doc_1

  - set: { _source._inference.inference_field.chunks.0.inference: inference_field_embedding }
  - set: { _source._inference.another_inference_field.chunks.0.inference: another_inference_field_embedding }

  - do:
      indices.refresh: { }

  - do:
      indices.create:
        index: destination-index
        body:
          mappings:
            properties:
              inference_field:
                type: semantic
                inference_id: sparse-inference-id
              another_inference_field:
                type: semantic
                inference_id: sparse-inference-id
              non_inference_field:
                type: text

  - do:
      reindex:
        wait_for_completion: true
        body:
          source:
            index: test-sparse-index
          dest:
            index: destination-index
  - do:
      get:
        index: destination-index
        id: doc_1

  - match:  { _source.inference_field: "inference test" }
  - match:  { _source.another_inference_field: "another inference test" }
  - match:  { _source.non_inference_field: "non inference test" }

  - length: { _source._inference: 2 }
  - match:  { _source._inference.inference_field.chunks.0.text: "inference test" }
  - match:  { _source._inference.another_inference_field.chunks.0.text: "another inference test" }

  - match:  { _source._inference.inference_field.chunks.0.inference: $inference_field_embedding }
  - match:  { _source._inference.another_inference_field.chunks.0.inference: $another_inference_field_embedding }

---
"Fails for non-existent inference":
  - do:
      indices.create:
        index: incorrect-test-sparse-index
        body:
          mappings:
            properties:
              inference_field:
                type: semantic
                inference_id: non-existing-inference-id
              non_inference_field:
                type: text

  - do:
      catch: missing
      index:
        index: incorrect-test-sparse-index
        id: doc_1
        body:
          inference_field: "inference test"
          non_inference_field: "non inference test"

  - match: { error.reason: "Inference id [non-existing-inference-id] not found for field [inference_field]" }

  # Succeeds when semantic field is not used
  - do:
      index:
        index: incorrect-test-sparse-index
        id: doc_1
        body:
          non_inference_field: "non inference test"

---
"Updates with script are not allowed":
  - do:
      bulk:
        index: test-sparse-index
        body:
          - '{"index": {"_id": "doc_1"}}'
          - '{"doc":{"inference_field": "I am a test", "another_inference_field": "I am a teapot"}}'

  - do:
      bulk:
        index: test-sparse-index
        body:
          - '{"update": {"_id": "doc_1"}}'
          - '{"script": "ctx._source.new_field = \"hello\"", "scripted_upsert": true}'

  - match: { errors: true }
  - match: { items.0.update.status: 400 }
  - match: { items.0.update.error.reason: "Cannot apply update with a script on indices that contain [semantic] field(s)" }

setup:
  - skip:
      version: " - 8.12.99"
      reason: semantic_text introduced in 8.13.0 # TODO change when 8.13.0 is released

  - do:
      inference.put_model:
        task_type: sparse_embedding
        inference_id: sparse-inference-id
        body: >
          {
            "service": "test_service",
            "service_settings": {
              "model": "my_model",
              "api_key": "abc64"
            },
            "task_settings": {
            }
          }

  - do:
      inference.put_model:
        task_type: text_embedding
        inference_id: dense-inference-id
        body: >
          {
            "service": "text_embedding_test_service",
            "service_settings": {
              "model": "my_model",
              "dimensions": 10,
              "api_key": "abc64"
            },
            "task_settings": {
            }
          }

  - do:
      indices.create:
        index: test-sparse-index
        body:
          mappings:
            properties:
              inference_field:
                type: semantic_text
                model_id: sparse-inference-id
              non_inference_field:
                type: text

  - do:
      indices.create:
        index: test-dense-index
        body:
          mappings:
            properties:
              inference_field:
                type: semantic_text
                model_id: dense-inference-id
              non_inference_field:
                type: text

---
"Query using a sparse embedding model":
  - do:
      index:
        index: test-sparse-index
        id: doc_1
        body:
          inference_field: "inference test"
          non_inference_field: "non inference test"
        refresh: true

  - do:
      search:
        index: test-sparse-index
        body:
          query:
            semantic_query:
              inference_field:
                query: "inference test"

  - match: { hits.total.value: 1 }
  - match: { hits.hits.0._id: "doc_1" }
  - match: { hits.hits.0._score: 9.4934225 }

---
"Apply boost and query name":
  - do:
      index:
        index: test-sparse-index
        id: doc_1
        body:
          inference_field: "inference test"
          non_inference_field: "non inference test"
        refresh: true

  - do:
      search:
        index: test-sparse-index
        body:
          query:
            semantic_query:
              inference_field:
                query: "inference test"
                boost: 100.0
                _name: i-like-naming-my-queries

  - match: { hits.total.value: 1 }
  - match: { hits.hits.0._id: "doc_1" }
  - match: { hits.hits.0._score: 949.3422 }
  - match: { hits.hits.0.matched_queries: ["i-like-naming-my-queries"] }

---
"Query the wrong field type":
  - do:
      index:
        index: test-sparse-index
        id: doc_1
        body:
          inference_field: "inference test"
          non_inference_field: "non inference test"
        refresh: true

  - do:
      catch: bad_request
      search:
        index: test-sparse-index
        body:
          query:
            semantic_query:
              non_inference_field:
                query: "inference test"

  - match: { error.type: "illegal_argument_exception" }
  - match: { error.reason: "Field [non_inference_field] is not a semantic_text field type" }

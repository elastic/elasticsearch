setup:
  - requires:
      cluster_features: "search.semantic_text_supports_multi_match_query"
      reason: semantic_text multi_match support

  - do:
      inference.put:
        task_type: sparse_embedding
        inference_id: sparse-inference-id
        body: >
          {
            "service": "test_service",
            "service_settings": {
              "model": "my_model",
              "api_key": "abc64"
            },
            "task_settings": {
            }
          }

  - do:
      inference.put:
        task_type: text_embedding
        inference_id: dense-inference-id
        body: >
          {
            "service": "text_embedding_test_service",
            "service_settings": {
              "model": "my_model",
              "dimensions": 10,
              "api_key": "abc64",
              "similarity": "COSINE"
            },
            "task_settings": {
            }
          }

  - do:
      indices.create:
        index: test-semantic-index
        body:
          mappings:
            properties:
              title:
                type: semantic_text
                inference_id: sparse-inference-id
              content:
                type: semantic_text
                inference_id: sparse-inference-id
              summary:
                type: semantic_text
                inference_id: dense-inference-id

  - do:
      indices.create:
        index: test-mixed-index
        body:
          mappings:
            properties:
              title:
                type: text
              content:
                type: semantic_text
                inference_id: sparse-inference-id
              summary:
                type: keyword

  - do:
      indices.create:
        index: test-text-only-index
        body:
          mappings:
            properties:
              title:
                type: text
              content:
                type: text
              summary:
                type: text

---
"Multi-match query on semantic_text fields":
  - do:
      index:
        index: test-semantic-index
        id: doc_1
        body:
          title: "Machine learning algorithms"
          content: "Deep neural networks for computer vision"
          summary: "AI and machine learning fundamentals"
        refresh: true

  - do:
      search:
        index: test-semantic-index
        body:
          query:
            multi_match:
              query: "machine learning neural networks"
              fields: ["title", "content"]

  - match: { hits.total.value: 1 }
  - match: { hits.hits.0._id: "doc_1" }

---
"Multi-match query on mixed semantic_text and text fields":
  - do:
      index:
        index: test-mixed-index
        id: doc_1
        body:
          title: "Quantum computing breakthrough"
          content: "Revolutionary quantum algorithms for cryptography"
          tags: ["quantum", "computing"]
        refresh: true

  - do:
      index:
        index: test-mixed-index
        id: doc_2
        body:
          title: "AI research advances"
          content: "Neural network architectures and deep learning"
          tags: ["ai", "research"]
        refresh: true

  - do:
      search:
        index: test-mixed-index
        body:
          query:
            multi_match:
              query: "quantum algorithms"
              fields: ["title", "content"]

  - match: { hits.total.value: 2 }

---
"Multi-match most_fields query on semantic_text":
  - do:
      index:
        index: test-semantic-index
        id: doc_1
        body:
          title: "Computer vision systems"
          content: "Image recognition and computer vision algorithms"
          summary: "Visual processing and pattern recognition"
        refresh: true

  - do:
      search:
        index: test-semantic-index
        body:
          query:
            multi_match:
              query: "computer vision"
              fields: ["title", "content", "summary"]
              type: "most_fields"

  - match: { hits.total.value: 1 }
  - match: { hits.hits.0._id: "doc_1" }

---
"Multi-match query across multiple indices with different field types":
  - do:
      index:
        index: test-semantic-index
        id: doc_1
        body:
          title: "Robotics automation"
          content: "Autonomous systems and robotic controls"
        refresh: true

  - do:
      index:
        index: test-text-only-index
        id: doc_2
        body:
          title: "Robotics research"
          content: "Industrial automation and robotics"
        refresh: true

  - do:
      search:
        index: "test-semantic-index,test-text-only-index"
        body:
          query:
            multi_match:
              query: "robotics automation"
              fields: ["title", "content"]

  - match: { hits.total.value: 2 }

---
"Multi-match boost and query name propagation":
  - skip:
      features: ["headers", "close_to"]

  - do:
      index:
        index: test-semantic-index
        id: doc_1
        body:
          title: "Machine learning algorithms"
          content: "Deep neural networks for computer vision"
          summary: "AI and machine learning fundamentals"
        refresh: true

  # Baseline query - no boost
  - do:
      headers:
        Content-Type: application/json
      search:
        index: test-semantic-index
        body:
          query:
            multi_match:
              query: "machine learning"
              fields: ["title", "content"]

  - match: { hits.total.value: 1 }
  - match: { hits.hits.0._id: "doc_1" }
  - close_to: { hits.hits.0._score: { value: 3.398582E18, error: 1e15 } }
  - not_exists: hits.hits.0.matched_queries

  # Field-level boost
  - do:
      headers:
        Content-Type: application/json
      search:
        index: test-semantic-index
        body:
          query:
            multi_match:
              query: "machine learning"
              fields: ["title", "content^2"]

  - match: { hits.total.value: 1 }
  - match: { hits.hits.0._id: "doc_1" }
  - close_to: { hits.hits.0._score: { value: 6.797164E18, error: 1e15 } }
  - not_exists: hits.hits.0.matched_queries

  # Overall boost with query name
  - do:
      headers:
        Content-Type: application/json
      search:
        index: test-semantic-index
        body:
          query:
            multi_match:
              query: "machine learning"
              fields: ["title", "content^2"]
              boost: 3.0
              _name: "boosted-multi-match"

  - match: { hits.total.value: 1 }
  - match: { hits.hits.0._id: "doc_1" }
  - close_to: { hits.hits.0._score: { value: 2.0391492E19, error: 1e16 } }
  - match: { hits.hits.0.matched_queries: ["boosted-multi-match"] }

---
"Multi-match query error on unsupported type with multiple fields":
  - do:
      catch: /multi_match query with type \[cross_fields\] is not supported for semantic_text fields/
      search:
        index: test-semantic-index
        body:
          query:
            multi_match:
              query: "test query"
              fields: ["title", "content"]
              type: "cross_fields"

  - do:
      catch: /multi_match query with type \[phrase\] is not supported for semantic_text fields/
      search:
        index: test-semantic-index
        body:
          query:
            multi_match:
              query: "test query"
              fields: [ "title", "content" ]
              type: "phrase"

  - do:
      catch: /multi_match query with type \[bool_prefix\] is not supported for semantic_text fields/
      search:
        index: test-semantic-index
        body:
          query:
            multi_match:
              query: "test query"
              fields: [ "title", "content" ]
              type: "bool_prefix"

  - do:
      catch: /multi_match query with type \[phrase_prefix\] is not supported for semantic_text fields/
      search:
        index: test-semantic-index
        body:
          query:
            multi_match:
              query: "test query"
              fields: [ "title", "content" ]
              type: "phrase_prefix"

---
"Multi-match query with default fields - single index":
  - do:
      indices.create:
        index: test-default-semantic-index
        body:
          settings:
            index.query.default_field: ["title", "content"]
          mappings:
            properties:
              title:
                type: semantic_text
                inference_id: sparse-inference-id
              content:
                type: semantic_text
                inference_id: sparse-inference-id
              summary:
                type: semantic_text
                inference_id: dense-inference-id

  - do:
      index:
        index: test-default-semantic-index
        id: doc_1
        body:
          title: "Artificial intelligence advances"
          content: "Machine learning and neural networks"
          summary: "AI technology overview"
        refresh: true

  - do:
      search:
        index: test-default-semantic-index
        body:
          query:
            multi_match:
              query: "artificial intelligence neural"

  - match: { hits.total.value: 1 }
  - match: { hits.hits.0._id: "doc_1" }

---
"Multi-match query with custom default fields and boosts - multi-index":
  - do:
      indices.create:
        index: test-default-mixed-index1
        body:
          settings:
            index.query.default_field: ["title^2", "content"]
          mappings:
            properties:
              title:
                type: semantic_text
                inference_id: sparse-inference-id
              content:
                type: text
              summary:
                type: keyword

  - do:
      indices.create:
        index: test-default-mixed-index2
        body:
          settings:
            index.query.default_field: ["title", "summary^3"]
          mappings:
            properties:
              title:
                type: text
              content:
                type: semantic_text
                inference_id: dense-inference-id
              summary:
                type: text

  - do:
      index:
        index: test-default-mixed-index1
        id: doc_1
        body:
          title: "Quantum computing breakthrough"
          content: "Revolutionary quantum algorithms for cryptography"
          summary: "quantum-tech"
        refresh: true

  - do:
      index:
        index: test-default-mixed-index2
        id: doc_2
        body:
          title: "Classical computing methods"
          content: "Traditional computational approaches"
          summary: "Quantum computing and classical methods comparison"
        refresh: true

  - do:
      search:
        index: "test-default-mixed-index1,test-default-mixed-index2"
        body:
          query:
            multi_match:
              query: "quantum computing"

  - match: { hits.total.value: 2 }

---
"Multi-match query with mixed field types across indices using default fields":
  - do:
      indices.create:
        index: test-default-semantic-only
        body:
          settings:
            index.query.default_field: ["title", "content", "summary"]
          mappings:
            properties:
              title:
                type: semantic_text
                inference_id: sparse-inference-id
              content:
                type: semantic_text
                inference_id: sparse-inference-id
              summary:
                type: semantic_text
                inference_id: dense-inference-id

  - do:
      indices.create:
        index: test-default-text-only
        body:
          settings:
            index.query.default_field: ["title^1.5", "content", "summary^0.5"]
          mappings:
            properties:
              title:
                type: text
              content:
                type: text
              summary:
                type: text

  - do:
      index:
        index: test-default-semantic-only
        id: doc_1
        body:
          title: "Deep learning frameworks"
          content: "TensorFlow and PyTorch for neural networks"
          summary: "Machine learning framework comparison"
        refresh: true

  - do:
      index:
        index: test-default-text-only
        id: doc_2
        body:
          title: "Deep learning applications"
          content: "Computer vision and natural language processing"
          summary: "Deep learning in various domains"
        refresh: true

  - do:
      search:
        index: "test-default-semantic-only,test-default-text-only"
        body:
          query:
            multi_match:
              query: "deep learning neural"

  - match: { hits.total.value: 2 }


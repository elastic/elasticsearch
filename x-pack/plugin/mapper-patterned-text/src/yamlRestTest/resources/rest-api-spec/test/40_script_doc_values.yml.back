setup:
  - do:
      indices.create:
        index: test
        body:
          settings:
            number_of_shards: 1
          mappings:
            properties:
              patterned_text:
                type: patterned_text
              rank:
                type: integer

  - do:
      index:
        index: test
        id: "1"
        body:
          rank: 1
          patterned_text: "Lots of text."

  - do:
      index:
        index: test
        id: "2"
        body:
          rank: 2

  - do:
      index:
        index: test
        id: "3"
        body:
          rank: 3
          patterned_text: [ "Lots of text.", "even more text", "SOOOOO much text" ]

  - do:
      indices.create:
        index: test_synthetic
        body:
          settings:
            number_of_shards: 1
            index:
              mapping.source.mode: synthetic
          mappings:
            properties:
              patterned_text:
                type: patterned_text
              rank:
                type: integer

  - do:
      index:
        index: test_synthetic
        id: "1"
        body:
          rank: 1
          patterned_text: "Lots of text."

  - do:
      index:
        index: test_synthetic
        id: "2"
        body:
          rank: 2

  - do:
      index:
        index: test_synthetic
        id: "3"
        body:
          rank: 3
          patterned_text: [ "Lots of text.", "even more text", "SOOOOO much text" ]


---
patterned_text:
  - do:
      catch: bad_request
      search:
        index: test
        body:
          query: { term: { _id: "1" } }
          script_fields:
            field:
              script:
                source: "doc['patterned_text'].get(0)"

  - match: { hits.hits.0.fields.field.0: "Lots of text." }

  - do:
      catch: bad_request
      search:
        index: test
        body:
          query: { term: { _id: "1" } }
          script_fields:
            field:
              script:
                source: "doc['patterned_text'].value"

  - match: { hits.hits.0.fields.field.0: "Lots of text." }

  - do:
      search:
        index: test
        body:
          sort: [ { rank: asc } ]
          script_fields:
            field:
              script:
                source: "field('patterned_text').get('')"
  - match: { hits.hits.0.fields.field.0: "Lots of text." }
  - match: { hits.hits.1.fields.field.0: "" }
  - match: { hits.hits.2.fields.field.0: "Lots of text." }

  - do:
      search:
        index: test
        body:
          sort: [ { rank: asc } ]
          script_fields:
            field:
              script:
                source: "/* avoid yaml stash */ $('patterned_text', '')"
  - match: { hits.hits.0.fields.field.0: "Lots of text." }
  - match: { hits.hits.1.fields.field.0: "" }
  - match: { hits.hits.2.fields.field.0: "Lots of text." }

  - do:
      search:
        index: test
        body:
          sort: [ { rank: asc } ]
          script_fields:
            field:
              script:
                source: "String defaultText = 'default text'; field('patterned_text').get(defaultText)"
  - match: { hits.hits.0.fields.field.0: "Lots of text." }
  - match: { hits.hits.1.fields.field.0: "default text" }
  - match: { hits.hits.2.fields.field.0: "Lots of text." }

  - do:
      search:
        index: test
        body:
          sort: [ { rank: asc } ]
          script_fields:
            field:
              script:
                source: "String defaultText = 'default text'; $('patterned_text', defaultText)"
  - match: { hits.hits.0.fields.field.0: "Lots of text." }
  - match: { hits.hits.1.fields.field.0: "default text" }
  - match: { hits.hits.2.fields.field.0: "Lots of text." }

  - do:
      search:
        index: test
        body:
          sort: [ { rank: asc } ]
          script_fields:
            field:
              script:
                source: "field('patterned_text').get(1, '')"
  - match: { hits.hits.0.fields.field.0: "" }
  - match: { hits.hits.1.fields.field.0: "" }
  - match: { hits.hits.2.fields.field.0: "SOOOOO much text" }

  - do:
      search:
        index: test
        body:
          sort: [ { rank: asc } ]
          script_fields:
            field:
              script:
                source: "String defaultText = 'default text'; field('patterned_text').get(1, defaultText)"
  - match: { hits.hits.0.fields.field.0: "default text" }
  - match: { hits.hits.1.fields.field.0: "default text" }
  - match: { hits.hits.2.fields.field.0: "SOOOOO much text" }

  - do:
      search:
        index: test
        body:
          sort: [ { rank: asc } ]
          script_fields:
            field:
              script:
                source: "field('patterned_text').get(1, '')"
  - match: { hits.hits.0.fields.field.0: "" }
  - match: { hits.hits.1.fields.field.0: "" }
  - match: { hits.hits.2.fields.field.0: "SOOOOO much text" }

  - do:
      search:
        index: test
        body:
          sort: [ { rank: asc } ]
          script_fields:
            field:
              script:
                source: "String cat = ''; for (String s : field('patterned_text')) { cat += s; } cat + field('patterned_text').size();"
  - match: { hits.hits.0.fields.field.0: "Lots of text.1" }
  - match: { hits.hits.1.fields.field.0: "0" }
  - match: { hits.hits.2.fields.field.0: "Lots of text.SOOOOO much texteven more text3" }

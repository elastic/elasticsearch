---
setup:

  - do:
      snapshot.create_repository:
        repository: test_repo
        body:
          type: fs
          settings:
            location: "test_repo_loc"

  - do:
      snapshot.create_repository:
        repository: test_repo_readonly
        body:
          type: fs
          settings:
            readonly: true
            location: "test_repo_loc"

---
"Analysis fails on readonly repositories":
  - skip:
      version: "- 7.99.99"
      reason: "introduced in 8.0"

  - do:
      catch: bad_request
      snapshot.repository_analyse:
        repository: test_repo_readonly

  - match: { status: 400 }
  - match: { error.type: illegal_argument_exception }
  - match: { error.reason: "repository [test_repo_readonly] is read-only" }


---
"Analysis without details":
  - skip:
      version: "- 7.99.99"
      reason: "introduced in 8.0"

  - do:
      snapshot.repository_analyse:
        repository: test_repo
        blob_count: 10
        concurrency: 5
        max_blob_size: 1mb
        read_node_count: 2
        early_read_node_count: 1
        rare_action_probability: 0.01
        max_total_data_size: 5mb

  - is_true: coordinating_node.id
  - is_true: coordinating_node.name
  - match: { repository:    test_repo }
  - match: { blob_count:    10 }
  - match: { concurrency:   5 }
  - match: { read_node_count: 2 }
  - match: { early_read_node_count: 1 }
  - match: { rare_action_probability: 0.01 }
  - match: { max_blob_size: 1mb }
  - match: { max_total_data_size: 5mb }
  - is_true: seed
  - is_true: blob_path
  - is_false: details
  - gte: { listing_nanos: 0}
  - gte: { delete_nanos:  0}
  - match: { summary.write.count: 10}
  - gte: { summary.write.total_bytes: 0}
  - gte: { summary.write.total_throttled_nanos: 0}
  - gte: { summary.write.total_elapsed_nanos: 0}
  - gte: { summary.read.count: 10}
  - gte: { summary.read.total_bytes: 0}
  - gte: { summary.read.total_wait_nanos: 0}
  - gte: { summary.read.max_wait_nanos: 0}
  - gte: { summary.read.total_throttled_nanos: 0}
  - gte: { summary.read.total_elapsed_nanos: 0}

---
"Analysis with details":
  - skip:
      version: "- 7.99.99"
      reason: "introduced in 8.0"

  - do:
      snapshot.repository_analyse:
        repository: test_repo
        blob_count: 10
        concurrency: 5
        max_blob_size: 1mb
        detailed: true

  - is_true: coordinating_node.id
  - is_true: coordinating_node.name
  - match: { repository:    test_repo }
  - match: { blob_count:    10 }
  - match: { concurrency:   5 }
  - match: { read_node_count: 10 }
  - match: { early_read_node_count: 2 }
  - match: { rare_action_probability: 0.02 }
  - match: { max_blob_size: 1mb }
  - is_true: seed
  - is_true: blob_path
  - is_true: details
  - gte: { listing_nanos: 0}
  - gte: { delete_nanos:  0}
  - match: { summary.write.count: 10}
  - gte: { summary.write.total_bytes: 0}
  - gte: { summary.write.total_throttled_nanos: 0}
  - gte: { summary.write.total_elapsed_nanos: 0}
  - gte: { summary.read.count: 10}
  - gte: { summary.read.total_bytes: 0}
  - gte: { summary.read.total_wait_nanos: 0}
  - gte: { summary.read.max_wait_nanos: 0}
  - gte: { summary.read.total_throttled_nanos: 0}
  - gte: { summary.read.total_elapsed_nanos: 0}

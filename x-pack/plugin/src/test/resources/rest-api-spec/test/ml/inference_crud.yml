setup:
  - skip:
      features: headers
  - do:
      headers:
        Authorization: "Basic eF9wYWNrX3Jlc3RfdXNlcjp4LXBhY2stdGVzdC1wYXNzd29yZA==" # run as x_pack_rest_user, i.e. the test setup superuser
      ml.put_trained_model:
        model_id: a-regression-model-0
        body: >
          {
            "description": "empty model for tests",
            "input": {"field_names": ["field1", "field2"]},
            "definition": {
               "preprocessors": [],
               "trained_model": {
                  "tree": {
                     "feature_names": ["field1", "field2"],
                     "tree_structure": [
                        {"node_index": 0, "leaf_value": 1}
                     ],
                     "target_type": "regression"
                  }
               }
            }
          }

  - do:
      headers:
        Authorization: "Basic eF9wYWNrX3Jlc3RfdXNlcjp4LXBhY2stdGVzdC1wYXNzd29yZA==" # run as x_pack_rest_user, i.e. the test setup superuser
      ml.put_trained_model:
        model_id: a-regression-model-1
        body: >
          {
            "description": "empty model for tests",
            "input": {"field_names": ["field1", "field2"]},
            "definition": {
               "preprocessors": [],
               "trained_model": {
                  "tree": {
                     "feature_names": ["field1", "field2"],
                     "tree_structure": [
                        {"node_index": 0, "leaf_value": 1}
                     ],
                     "target_type": "regression"
                  }
               }
            }
          }
  - do:
      headers:
        Authorization: "Basic eF9wYWNrX3Jlc3RfdXNlcjp4LXBhY2stdGVzdC1wYXNzd29yZA==" # run as x_pack_rest_user, i.e. the test setup superuser
      ml.put_trained_model:
        model_id: a-classification-model
        body: >
          {
            "description": "empty model for tests",
            "input": {"field_names": ["field1", "field2"]},
            "definition": {
               "preprocessors": [],
               "trained_model": {
                  "tree": {
                     "feature_names": ["field1", "field2"],
                     "tree_structure": [
                        {"node_index": 0, "leaf_value": 1}
                     ],
                     "target_type": "classification",
                     "classification_labels": ["no", "yes"]
                  }
               }
            }
          }
---
"Test get given missing trained model":

  - do:
      catch: missing
      ml.get_trained_models:
        model_id: "missing-trained-model"
---
"Test get given expression without matches and allow_no_match is false":

  - do:
      catch: missing
      ml.get_trained_models:
        model_id: "missing-trained-model*"
        allow_no_match: false

---
"Test get given expression without matches and allow_no_match is true":

  - do:
      ml.get_trained_models:
        model_id: "missing-trained-model*"
        allow_no_match: true
  - match: { count: 0 }
  - match: { trained_model_configs: [] }
---
"Test get models":
  - do:
      ml.get_trained_models:
        model_id: "*"
  - match: { count: 4 }
  - match: { trained_model_configs.0.model_id: "a-classification-model" }
  - match: { trained_model_configs.1.model_id: "a-regression-model-0" }
  - match: { trained_model_configs.2.model_id: "a-regression-model-1" }

  - do:
      ml.get_trained_models:
        model_id: "a-regression*"
  - match: { count: 2 }
  - match: { trained_model_configs.0.model_id: "a-regression-model-0" }
  - match: { trained_model_configs.1.model_id: "a-regression-model-1" }

  - do:
      ml.get_trained_models:
        model_id: "*"
        from: 0
        size: 2
  - match: { count: 4 }
  - match: { trained_model_configs.0.model_id: "a-classification-model" }
  - match: { trained_model_configs.1.model_id: "a-regression-model-0" }

  - do:
      ml.get_trained_models:
        model_id: "*"
        from: 1
        size: 1
  - match: { count: 4 }
  - match: { trained_model_configs.0.model_id: "a-regression-model-0" }
---
"Test delete given unused trained model":
  - do:
      ml.delete_trained_model:
        model_id: "a-classification-model"
  - match: { acknowledged: true }
---
"Test delete with missing model":
  - do:
      catch: missing
      ml.delete_trained_model:
        model_id: "missing-trained-model"
---
"Test delete given used trained model":
  - do:
      ingest.put_pipeline:
        id: "regression-model-pipeline"
        body:  >
          {
            "processors": [
              {
                "inference" : {
                  "model_id" : "a-regression-model-0",
                  "inference_config": {"regression": {}},
                  "target_field": "regression_field",
                  "field_mappings": {}
                }
              }
            ]
          }
  - match: { acknowledged: true }

  - do:
      catch: conflict
      ml.delete_trained_model:
        model_id: "a-regression-model-0"
---
"Test get pre-packaged trained models":
  - do:
      ml.get_trained_models:
        model_id: "lang_ident_model_1"
        allow_no_match: false
  - match: { count: 1 }
  - match: { trained_model_configs.0.model_id: "lang_ident_model_1" }

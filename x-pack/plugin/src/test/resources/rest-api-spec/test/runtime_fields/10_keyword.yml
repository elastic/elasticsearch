---
setup:
  - do:
      indices.create:
        index: sensor
        body:
          settings:
            number_of_shards: 1
            number_of_replicas: 0
          mappings:
            properties:
              timestamp:
                type: date
              temperature:
                type: long
              voltage:
                type: double
              node:
                type: keyword
              day_of_week:
                type: script
                runtime_type: keyword
                script: |
                  value(doc['timestamp'].value.dayOfWeekEnum.getDisplayName(TextStyle.FULL, Locale.ROOT))
              days_starting_with_t:
                type: script
                runtime_type: keyword
                script: |
                  for (String dow: doc['day_of_week']) {
                    if (dow.startsWith('T')) {
                      value(dow);
                    }
                  }
              prefixed_node:
                type: script
                runtime_type: keyword
                script:
                  source: |
                    for (String node : doc['node']) {
                      value(params.prefix + node);
                    }
                  params:
                    prefix: node_

  - do:
      bulk:
        index: sensor
        refresh: true
        body: |
          {"index":{}}
          {"timestamp": 1516729294000, "temperature": 200, "voltage": 5.2, "node": "a"}
          {"index":{}}
          {"timestamp": 1516642894000, "temperature": 201, "voltage": 5.8, "node": "b"}
          {"index":{}}
          {"timestamp": 1516556494000, "temperature": 202, "voltage": 5.1, "node": "a"}
          {"index":{}}
          {"timestamp": 1516470094000, "temperature": 198, "voltage": 5.6, "node": "b"}
          {"index":{}}
          {"timestamp": 1516383694000, "temperature": 200, "voltage": 4.2, "node": "c"}
          {"index":{}}
          {"timestamp": 1516297294000, "temperature": 202, "voltage": 4.0, "node": "c"}

---
"get mapping":
  - do:
      indices.get_mapping:
        index: sensor
  - match: {sensor.mappings.properties.day_of_week.type: script }
  - match: {sensor.mappings.properties.day_of_week.runtime_type: keyword }
  - match:
      sensor.mappings.properties.day_of_week.script.source: |
        value(doc['timestamp'].value.dayOfWeekEnum.getDisplayName(TextStyle.FULL, Locale.ROOT))
  - match: {sensor.mappings.properties.day_of_week.script.lang: painless }
  - match: {sensor.mappings.properties.days_starting_with_t.type: script }
  - match: {sensor.mappings.properties.days_starting_with_t.runtime_type: keyword }
  - match:
      sensor.mappings.properties.days_starting_with_t.script.source: |
        for (String dow: doc['day_of_week']) {
          if (dow.startsWith('T')) {
            value(dow);
          }
        }
  - match: {sensor.mappings.properties.days_starting_with_t.script.lang: painless }
  - match: {sensor.mappings.properties.prefixed_node.type: script }
  - match: {sensor.mappings.properties.prefixed_node.runtime_type: keyword }
  - match:
      sensor.mappings.properties.prefixed_node.script.source: |
        for (String node : doc['node']) {
          value(params.prefix + node);
        }
  - match: {sensor.mappings.properties.prefixed_node.script.params: {prefix: node_} }
  - match: {sensor.mappings.properties.prefixed_node.script.lang: painless }

---
"get field mapping":
  - do:
      indices.get_field_mapping:
        index: sensor
        fields: day_of_week
        include_defaults: true
  - match:
      sensor.mappings.day_of_week.mapping.day_of_week:
        type: script
        runtime_type: keyword
        script:
          source: |
            value(doc['timestamp'].value.dayOfWeekEnum.getDisplayName(TextStyle.FULL, Locale.ROOT))
          lang: painless
        meta: {}
---
"docvalue_fields":
  - do:
      search:
        index: sensor
        body:
          sort: timestamp
          docvalue_fields: [day_of_week, days_starting_with_t, prefixed_node]
  - match: {hits.total.value: 6}
  - match: {hits.hits.0.fields.day_of_week: [Thursday] }
  - match: {hits.hits.0.fields.days_starting_with_t: [Thursday] }
  - match: {hits.hits.0.fields.prefixed_node: [node_c] }

---
"terms agg":
  - do:
      search:
        index: sensor
        body:
          aggs:
            dow:
              terms:
                field: day_of_week
  - match: {hits.total.value: 6}
  - match: {aggregations.dow.buckets.0.key: Friday}
  - match: {aggregations.dow.buckets.0.doc_count: 1}
  - match: {aggregations.dow.buckets.1.key: Monday}
  - match: {aggregations.dow.buckets.1.doc_count: 1}

---
"exists query":
  - do:
      search:
        index: sensor
        body:
          query:
            exists:
              field: days_starting_with_t
          sort: timestamp
  - match: {hits.total.value: 2}
  - match: {hits.hits.0._source.voltage: 4.0}
  - match: {hits.hits.1._source.voltage: 5.2}

---
"fuzzy query":
  - do:
      search:
        index: sensor
        body:
          query:
            fuzzy:
              day_of_week:
                value: Manday
                fuzziness: 1
  - match: {hits.total.value: 1}
  - match: {hits.hits.0._source.voltage: 5.8}

---
"prefix query":
  - do:
      search:
        index: sensor
        body:
          query:
            prefix:
              day_of_week: M
  - match: {hits.total.value: 1}
  - match: {hits.hits.0._source.voltage: 5.8}

---
"range query":
  - do:
      search:
        index: sensor
        body:
          query:
            range:
              day_of_week:
                gt: M
                lt: N
  - match: {hits.total.value: 1}
  - match: {hits.hits.0._source.voltage: 5.8}

---
"regexp query":
  - do:
      search:
        index: sensor
        body:
          query:
            regexp:
              day_of_week: M[aeiou]nday
  - match: {hits.total.value: 1}
  - match: {hits.hits.0._source.voltage: 5.8}

---
"term query":
  - do:
      search:
        index: sensor
        body:
          query:
            term:
              day_of_week: Monday
  - match: {hits.total.value: 1}
  - match: {hits.hits.0._source.voltage: 5.8}

---
"match query":
  - do:
      search:
        index: sensor
        body:
          query:
            match:
              day_of_week: Monday
  - match: {hits.total.value: 1}
  - match: {hits.hits.0._source.voltage: 5.8}

  - do:
      search:
        index: sensor
        body:
          query:
            match:
              day_of_week:
                query: Monday
                analyzer: standard
  - match: {hits.total.value: 0}

---
"terms query":
  - do:
      search:
        index: sensor
        body:
          query:
            terms:
              day_of_week: [Monday, Tuesday]
          sort: timestamp
  - match: {hits.total.value: 2}
  - match: {hits.hits.0._source.voltage: 5.8}
  - match: {hits.hits.1._source.voltage: 5.2}

---
"wildcard query":
  - do:
      search:
        index: sensor
        body:
          query:
            wildcard:
              day_of_week: M*ay
  - match: {hits.total.value: 1}
  - match: {hits.hits.0._source.voltage: 5.8}

---
"runtime defined docvalue_fields":
  - do:
      search:
        index: sensor
        body:
          runtime_mappings:
            first_letter:
              type: script
              runtime_type: keyword
              script: |
                for (String node : doc['day_of_week']) {
                  value(node.charAt(0).toString());
                }
          sort: timestamp
          docvalue_fields: [first_letter]
  - match: {hits.total.value: 6}
  - match: {hits.hits.0.fields.first_letter: [T] }
  - match: {hits.hits.1.fields.first_letter: [F] }
  - match: {hits.hits.2.fields.first_letter: [S] }
  - match: {hits.hits.3.fields.first_letter: [S] }
  - match: {hits.hits.4.fields.first_letter: [M] }
  - match: {hits.hits.5.fields.first_letter: [T] }

---
"runtime defined query":
  - do:
      search:
        index: sensor
        body:
          runtime_mappings:
            first_letter:
              type: script
              runtime_type: keyword
              script: |
                for (String node : doc['day_of_week']) {
                  value(node.charAt(0).toString());
                }
          query:
            term:
              first_letter: M
  - match: {hits.total.value: 1}
  - match: {hits.hits.0._source.voltage: 5.8}

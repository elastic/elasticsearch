setup:
  - skip:
      version: " - 8.13.99"
      reason: "Union types introduced in 8.14.0"
      features: allowed_warnings_regex

  - do:
      indices.create:
        index: events_ip_long
        body:
          mappings:
            properties:
              "@timestamp":
                type: date
              client_ip:
                type: ip
              event_duration:
                type: long
              message:
                type: keyword

  - do:
      bulk:
        refresh: true
        index: events_ip_long
        body:
          - '{"index": {}}'
          - '{"@timestamp": "2023-10-23T13:55:01.543Z", "client_ip": "172.21.3.15", "event_duration": 1756467, "message": "Connected to 10.1.0.1"}'
          - '{"index": {}}'
          - '{"@timestamp": "2023-10-23T13:53:55.832Z", "client_ip": "172.21.3.15", "event_duration": 5033755, "message": "Connection error"}'
          - '{"index": {}}'
          - '{"@timestamp": "2023-10-23T13:52:55.015Z", "client_ip": "172.21.3.15", "event_duration": 8268153, "message": "Connection error"}'
          - '{"index": {}}'
          - '{"@timestamp": "2023-10-23T13:51:54.732Z", "client_ip": "172.21.3.15", "event_duration": 725448, "message": "Connection error"}'
          - '{"index": {}}'
          - '{"@timestamp": "2023-10-23T13:33:34.937Z", "client_ip": "172.21.0.5", "event_duration": 1232382, "message": "Disconnected"}'
          - '{"index": {}}'
          - '{"@timestamp": "2023-10-23T12:27:28.948Z", "client_ip": "172.21.2.113", "event_duration": 2764889, "message": "Connected to 10.1.0.2"}'
          - '{"index": {}}'
          - '{"@timestamp": "2023-10-23T12:15:03.360Z", "client_ip": "172.21.2.162", "event_duration": 3450233, "message": "Connected to 10.1.0.3"}'
  - do:
      indices.create:
        index: events_keyword_long
        body:
          mappings:
            properties:
              "@timestamp":
                type: date
              client_ip:
                type: keyword
              event_duration:
                type: long
              message:
                type: keyword

  - do:
      bulk:
        refresh: true
        index: events_keyword_long
        body:
          - '{"index": {}}'
          - '{"@timestamp": "2023-10-23T13:55:01.543Z", "client_ip": "172.21.3.15", "event_duration": 1756467, "message": "Connected to 10.1.0.1"}'
          - '{"index": {}}'
          - '{"@timestamp": "2023-10-23T13:53:55.832Z", "client_ip": "172.21.3.15", "event_duration": 5033755, "message": "Connection error"}'
          - '{"index": {}}'
          - '{"@timestamp": "2023-10-23T13:52:55.015Z", "client_ip": "172.21.3.15", "event_duration": 8268153, "message": "Connection error"}'
          - '{"index": {}}'
          - '{"@timestamp": "2023-10-23T13:51:54.732Z", "client_ip": "172.21.3.15", "event_duration": 725448, "message": "Connection error"}'
          - '{"index": {}}'
          - '{"@timestamp": "2023-10-23T13:33:34.937Z", "client_ip": "172.21.0.5", "event_duration": 1232382, "message": "Disconnected"}'
          - '{"index": {}}'
          - '{"@timestamp": "2023-10-23T12:27:28.948Z", "client_ip": "172.21.2.113", "event_duration": 2764889, "message": "Connected to 10.1.0.2"}'
          - '{"index": {}}'
          - '{"@timestamp": "2023-10-23T12:15:03.360Z", "client_ip": "172.21.2.162", "event_duration": 3450233, "message": "Connected to 10.1.0.3"}'

  - do:
      indices.create:
        index: events_ip_keyword
        body:
          mappings:
            properties:
              "@timestamp":
                type: date
              client_ip:
                type: ip
              event_duration:
                type: keyword
              message:
                type: keyword

  - do:
      bulk:
        refresh: true
        index: events_ip_keyword
        body:
          - '{"index": {}}'
          - '{"@timestamp": "2023-10-23T13:55:01.543Z", "client_ip": "172.21.3.15", "event_duration": "1756467", "message": "Connected to 10.1.0.1"}'
          - '{"index": {}}'
          - '{"@timestamp": "2023-10-23T13:53:55.832Z", "client_ip": "172.21.3.15", "event_duration": "5033755", "message": "Connection error"}'
          - '{"index": {}}'
          - '{"@timestamp": "2023-10-23T13:52:55.015Z", "client_ip": "172.21.3.15", "event_duration": "8268153", "message": "Connection error"}'
          - '{"index": {}}'
          - '{"@timestamp": "2023-10-23T13:51:54.732Z", "client_ip": "172.21.3.15", "event_duration": "725448", "message": "Connection error"}'
          - '{"index": {}}'
          - '{"@timestamp": "2023-10-23T13:33:34.937Z", "client_ip": "172.21.0.5", "event_duration": "1232382", "message": "Disconnected"}'
          - '{"index": {}}'
          - '{"@timestamp": "2023-10-23T12:27:28.948Z", "client_ip": "172.21.2.113", "event_duration": "2764889", "message": "Connected to 10.1.0.2"}'
          - '{"index": {}}'
          - '{"@timestamp": "2023-10-23T12:15:03.360Z", "client_ip": "172.21.2.162", "event_duration": "3450233", "message": "Connected to 10.1.0.3"}'

  - do:
      indices.create:
        index: events_keyword_keyword
        body:
          mappings:
            properties:
              "@timestamp":
                type: date
              client_ip:
                type: keyword
              event_duration:
                type: keyword
              message:
                type: keyword

  - do:
      bulk:
        refresh: true
        index: events_keyword_keyword
        body:
          - '{"index": {}}'
          - '{"@timestamp": "2023-10-23T13:55:01.543Z", "client_ip": "172.21.3.15", "event_duration": "1756467", "message": "Connected to 10.1.0.1"}'
          - '{"index": {}}'
          - '{"@timestamp": "2023-10-23T13:53:55.832Z", "client_ip": "172.21.3.15", "event_duration": "5033755", "message": "Connection error"}'
          - '{"index": {}}'
          - '{"@timestamp": "2023-10-23T13:52:55.015Z", "client_ip": "172.21.3.15", "event_duration": "8268153", "message": "Connection error"}'
          - '{"index": {}}'
          - '{"@timestamp": "2023-10-23T13:51:54.732Z", "client_ip": "172.21.3.15", "event_duration": "725448", "message": "Connection error"}'
          - '{"index": {}}'
          - '{"@timestamp": "2023-10-23T13:33:34.937Z", "client_ip": "172.21.0.5", "event_duration": "1232382", "message": "Disconnected"}'
          - '{"index": {}}'
          - '{"@timestamp": "2023-10-23T12:27:28.948Z", "client_ip": "172.21.2.113", "event_duration": "2764889", "message": "Connected to 10.1.0.2"}'
          - '{"index": {}}'
          - '{"@timestamp": "2023-10-23T12:15:03.360Z", "client_ip": "172.21.2.162", "event_duration": "3450233", "message": "Connected to 10.1.0.3"}'

---
load single index ip_long:
  - do:
      allowed_warnings_regex:
        - "No limit defined, adding default limit of \\[.*\\]"
      esql.query:
        body:
          query: 'FROM events_ip_long METADATA _index | KEEP _index, @timestamp, client_ip, event_duration, message | SORT _index ASC, @timestamp DESC'

  - match: { columns.0.name: "_index" }
  - match: { columns.0.type: "keyword" }
  - match: { columns.1.name: "@timestamp" }
  - match: { columns.1.type: "date" }
  - match: { columns.2.name: "client_ip" }
  - match: { columns.2.type: "ip" }
  - match: { columns.3.name: "event_duration" }
  - match: { columns.3.type: "long" }
  - match: { columns.4.name: "message" }
  - match: { columns.4.type: "keyword" }
  - length: { values: 7 }
  - match: { values.0.0: "events_ip_long" }
  - match: { values.0.1: "2023-10-23T13:55:01.543Z" }
  - match: { values.0.2: "172.21.3.15" }
  - match: { values.0.3: 1756467 }
  - match: { values.0.4: "Connected to 10.1.0.1" }

---
load single index keyword_keyword:
  - do:
      allowed_warnings_regex:
        - "No limit defined, adding default limit of \\[.*\\]"
      esql.query:
        body:
          query: 'FROM events_keyword_keyword METADATA _index | KEEP _index, @timestamp, client_ip, event_duration, message | SORT _index ASC, @timestamp DESC'

  - match: { columns.0.name: "_index" }
  - match: { columns.0.type: "keyword" }
  - match: { columns.1.name: "@timestamp" }
  - match: { columns.1.type: "date" }
  - match: { columns.2.name: "client_ip" }
  - match: { columns.2.type: "keyword" }
  - match: { columns.3.name: "event_duration" }
  - match: { columns.3.type: "keyword" }
  - match: { columns.4.name: "message" }
  - match: { columns.4.type: "keyword" }
  - length: { values: 7 }
  - match: { values.0.0: "events_keyword_keyword" }
  - match: { values.0.1: "2023-10-23T13:55:01.543Z" }
  - match: { values.0.2: "172.21.3.15" }
  - match: { values.0.3: "1756467" }
  - match: { values.0.4: "Connected to 10.1.0.1" }



---
load two indices with no conversion function, but needs TO_LONG conversion:
  - do:
      catch: '/Cannot use field \[event_duration\] due to ambiguities being mapped as \[2\] incompatible types: \[keyword\] in \[events_ip_keyword\], \[long\] in \[events_ip_long\]/'
      esql.query:
        body:
          query: 'FROM events_ip_* METADATA _index | KEEP _index, @timestamp, client_ip, event_duration, message | SORT _index ASC, @timestamp DESC'

---
load two indices with single conversion function TO_LONG:
  - do:
      allowed_warnings_regex:
        - "No limit defined, adding default limit of \\[.*\\]"
      esql.query:
        body:
          query: 'FROM events_ip_* METADATA _index | EVAL event_duration = TO_LONG(event_duration) | KEEP _index, @timestamp, client_ip, event_duration, message | SORT _index ASC, @timestamp DESC'

  - match: { columns.0.name: "_index" }
  - match: { columns.0.type: "keyword" }
  - match: { columns.1.name: "@timestamp" }
  - match: { columns.1.type: "date" }
  - match: { columns.2.name: "client_ip" }
  - match: { columns.2.type: "ip" }
  - match: { columns.3.name: "event_duration" }
  - match: { columns.3.type: "long" }
  - match: { columns.4.name: "message" }
  - match: { columns.4.type: "keyword" }
  - length: { values: 14 }
  - match: { values.0.0: "events_ip_keyword" }
  - match: { values.0.1: "2023-10-23T13:55:01.543Z" }
  - match: { values.0.2: "172.21.3.15" }
  - match: { values.0.3: 1756467 }
  - match: { values.0.4: "Connected to 10.1.0.1" }
  - match: { values.7.0: "events_ip_long" }
  - match: { values.7.1: "2023-10-23T13:55:01.543Z" }
  - match: { values.7.2: "172.21.3.15" }
  - match: { values.7.3: 1756467 }
  - match: { values.7.4: "Connected to 10.1.0.1" }

---
load two indices with no conversion function, but needs TO_IP conversion:
  - do:
      catch: '/Cannot use field \[client_ip\] due to ambiguities being mapped as \[2\] incompatible types: \[ip\] in \[events_ip_long\], \[keyword\] in \[events_keyword_long\]/'
      esql.query:
        body:
          query: 'FROM events_*_long METADATA _index | KEEP _index, @timestamp, client_ip, event_duration, message | SORT _index ASC, @timestamp DESC'

---
load two indices with single conversion function TO_IP:
  - do:
      allowed_warnings_regex:
        - "No limit defined, adding default limit of \\[.*\\]"
      esql.query:
        body:
          query: 'FROM events_*_long METADATA _index | EVAL client_ip = TO_IP(client_ip) | KEEP _index, @timestamp, client_ip, event_duration, message | SORT _index ASC, @timestamp DESC'

  - match: { columns.0.name: "_index" }
  - match: { columns.0.type: "keyword" }
  - match: { columns.1.name: "@timestamp" }
  - match: { columns.1.type: "date" }
  - match: { columns.2.name: "client_ip" }
  - match: { columns.2.type: "ip" }
  - match: { columns.3.name: "event_duration" }
  - match: { columns.3.type: "long" }
  - match: { columns.4.name: "message" }
  - match: { columns.4.type: "keyword" }
  - length: { values: 14 }
  - match: { values.0.0: "events_ip_long" }
  - match: { values.0.1: "2023-10-23T13:55:01.543Z" }
  - match: { values.0.2: "172.21.3.15" }
  - match: { values.0.3: 1756467 }
  - match: { values.0.4: "Connected to 10.1.0.1" }
  - match: { values.7.0: "events_keyword_long" }
  - match: { values.7.1: "2023-10-23T13:55:01.543Z" }
  - match: { values.7.2: "172.21.3.15" }
  - match: { values.7.3: 1756467 }
  - match: { values.7.4: "Connected to 10.1.0.1" }

---
load four indices with single conversion function TO_LONG:
  - do:
      catch: '/Cannot use field \[client_ip\] due to ambiguities being mapped as \[2\] incompatible types: \[ip\] in \[events_ip_keyword, events_ip_long\], \[keyword\] in \[events_keyword_keyword, events_keyword_long\]/'
      esql.query:
        body:
          query: 'FROM events_* METADATA _index | EVAL event_duration = TO_LONG(event_duration) | KEEP _index, @timestamp, client_ip, event_duration, message | SORT _index ASC, @timestamp DESC'

---
load four indices with single conversion function TO_IP:
  - do:
      catch: '/Cannot use field \[event_duration\] due to ambiguities being mapped as \[2\] incompatible types: \[keyword\] in \[events_ip_keyword, events_keyword_keyword\], \[long\] in \[events_ip_long, events_keyword_long\]/'
      esql.query:
        body:
          query: 'FROM events_* METADATA _index | EVAL client_ip = TO_IP(client_ip) | KEEP _index, @timestamp, client_ip, event_duration, message | SORT _index ASC, @timestamp DESC'

---
load four indices with multiple conversion functions TO_LONG and TO_IP:
  - do:
      allowed_warnings_regex:
        - "No limit defined, adding default limit of \\[.*\\]"
      esql.query:
        body:
          query: 'FROM events_* METADATA _index | EVAL event_duration = TO_LONG(event_duration), client_ip = TO_IP(client_ip) | KEEP _index, @timestamp, client_ip, event_duration, message | SORT _index ASC, @timestamp DESC'

  - match: { columns.0.name: "_index" }
  - match: { columns.0.type: "keyword" }
  - match: { columns.1.name: "@timestamp" }
  - match: { columns.1.type: "date" }
  - match: { columns.2.name: "client_ip" }
  - match: { columns.2.type: "ip" }
  - match: { columns.3.name: "event_duration" }
  - match: { columns.3.type: "long" }
  - match: { columns.4.name: "message" }
  - match: { columns.4.type: "keyword" }
  - length: { values: 28 }
  - match: { values.0.0: "events_ip_keyword" }
  - match: { values.0.1: "2023-10-23T13:55:01.543Z" }
  - match: { values.0.2: "172.21.3.15" }
  - match: { values.0.3: 1756467 }
  - match: { values.0.4: "Connected to 10.1.0.1" }
  - match: { values.7.0: "events_ip_long" }
  - match: { values.7.1: "2023-10-23T13:55:01.543Z" }
  - match: { values.7.2: "172.21.3.15" }
  - match: { values.7.3: 1756467 }
  - match: { values.7.4: "Connected to 10.1.0.1" }
  - match: { values.14.0: "events_keyword_keyword" }
  - match: { values.14.1: "2023-10-23T13:55:01.543Z" }
  - match: { values.14.2: "172.21.3.15" }
  - match: { values.14.3: 1756467 }
  - match: { values.14.4: "Connected to 10.1.0.1" }
  - match: { values.21.0: "events_keyword_long" }
  - match: { values.21.1: "2023-10-23T13:55:01.543Z" }
  - match: { values.21.2: "172.21.3.15" }
  - match: { values.21.3: 1756467 }
  - match: { values.21.4: "Connected to 10.1.0.1" }

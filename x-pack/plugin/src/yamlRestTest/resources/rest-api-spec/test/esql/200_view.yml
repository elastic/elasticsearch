---
setup:
  - requires:
      cluster_features: [ "esql.esql_views" ]
      reason: requires esql views to be enabled

  - do:
      indices.create:
        index: test
        body:
          mappings:
            properties:
              content:
                type: keyword
              color:
                type: keyword
              animal:
                type: keyword
              id:
                type: integer
  - do:
      bulk:
        index: "test"
        refresh: true
        body:
          - { "index": { } }
          - { "content": "This is a brown fox", "color": "brown", "animal": "fox", "id": 1 }
          - { "index": { } }
          - { "content": "This is a brown dog", "color": "brown", "animal": "dog", "id": 2 }
          - { "index": { } }
          - { "content": "This dog is really white", "color": "white", "animal": "dog", "id": 3 }
          - { "index": { } }
          - { "content": "The dog is brown but this document is very very long", "color": "brown", "animal": "dog", "id": 4 }
          - { "index": { } }
          - { "content": "There is also a white cat", "color": "white", "animal": "cat", "id": 5 }
          - { "index": { } }
          - { "content": "The quick brown fox jumps over the lazy dog", "color": "brown", "animal": "dog", "id": 6 }

---
"crud":
  - requires:
      cluster_features: [ "esql.esql_views" ]
      reason: requires esql views to be enabled

  - do:
      esql.put_view:
        name: dogs
        body:
          query: 'FROM test | WHERE animal == "dog"'

  - do:
      esql.get_view:
        name: dogs

  - match: { views.0.name: "dogs" }
  - match: { views.0.query: 'FROM test | WHERE animal == "dog"' }

  - do:
      esql.get_view: { }

  - match: { views.0.name: "dogs" }
  - match: { views.0.query: 'FROM test | WHERE animal == "dog"' }

  - do:
      esql.put_view:
        name: dogs
        body:
          query: 'FROM test | WHERE animal == "pooch"'

  - do:
      esql.get_view:
        name: dogs

  - match: { views.0.name: "dogs" }
  - match: { views.0.query: 'FROM test | WHERE animal == "pooch"' }

  - do:
      esql.delete_view:
        name: dogs

  - do:
      esql.get_view: { }

  - match: { views: [] }

---
"invalid-views":
  - requires:
      cluster_features: [ "esql.esql_views" ]
      reason: requires esql views to be enabled

  - do:
      esql.put_view:
        name: dogs
        body:
          query: 'FRO test'

  - do:
      esql.get_view:
        name: dogs

  - match: { views: { dogs: { query: 'FRO test' } } }

  - do:
      esql.delete_view:
        name: dogs

  - do:
      esql.get_view: { }

  - match: { views: { } }

---
"basic":
  - requires:
      cluster_features: [ "esql.esql_views" ]
      reason: requires esql views to be enabled
      test_runner_features: [ allowed_warnings_regex ]

  - do:
      esql.put_view:
        name: dogs
        body:
          query: 'FROM test | WHERE animal == "dog"'

  - do:
      allowed_warnings_regex:
        - "No limit defined, adding default limit of \\[.*\\]"
      esql.query:
        body:
          query: 'FROM dogs | WHERE color == "white" | KEEP id | SORT id'
  - match: { columns.0.name: "id" }
  - match: { columns.0.type: "integer" }
  - length: { values: 1 }
  - match: { values.0.0: 3 }

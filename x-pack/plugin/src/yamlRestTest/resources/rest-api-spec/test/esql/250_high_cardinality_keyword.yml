---
setup:
  - requires:
      cluster_features: ["mapper.keyword.high_cardinality_length_function_fuse_to_load"]
      reason: "testing binary doc values search"

  - do:
      indices.create:
        index:  test
        body:
          mappings:
            dynamic: false
            properties:
              keyword:
                type: keyword
                index: false
                doc_values:
                  cardinality: high

  - do:
      index:
        index: test
        id: "1"
        body:
          keyword: "abc"

  - do:
      index:
        index: test
        id: "2"
        body:
          keyword: "abcdef"
  - do:
      indices.refresh: {}

---
"Test avg length":
  - do:
      esql.query:
        body:
          query: 'FROM test | STATS l = avg(length(keyword)) | LIMIT 10'

  - length: {columns: 1}
  - length: {values: 1}
  - match: {columns.0.name: "l"}
  - match: {columns.0.type: "double"}
  - length: {values.0: 1}
  - match: {values.0.0: 4.5}

---
"Test mv_min":
  - requires:
      cluster_features: ["mapper.keyword.mv_min_function_fuse_to_load"]
      reason: "testing mv_min fuse to load"

  - do:
      index:
        index: test
        id: "3"
        body:
          keyword: [ "abcdef", "ab", "abcdefg" ]
  - do:
      indices.refresh: {}

  - do:
      esql.query:
        body:
          query: 'FROM test METADATA _id | EVAL k = mv_min(keyword) | SORT k | KEEP _id, k | LIMIT 10'

  - length: {columns: 2}
  - match: {columns.0.name: "_id"}
  - match: {columns.0.type: "keyword"}
  - match: {columns.1.name: "k"}
  - match: {columns.1.type: "keyword"}
  - length: {values: 3}
  - match: {values.0.0: "3"}
  - match: {values.0.1: "ab"}
  - match: {values.1.0: "1"}
  - match: {values.1.1: "abc"}
  - match: {values.2.0: "2"}
  - match: {values.2.1: "abcdef"}

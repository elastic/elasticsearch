setup:
  - requires:
      cluster_features: [ "mapper.exponential_histogram_type" ]
      reason: exponential_histogram field type was introduced
      test_runner_features: [ allowed_warnings ]
  # Create an index template for the data stream with aggregate_metric_double field
  - do:
      allowed_warnings:
        - "Parameter [default_metric] is deprecated and will be removed in a future version"
      indices.put_index_template:
        name: test_data_stream_template
        body:
          index_patterns: ["test-data-stream*"]
          data_stream: {}
          template:
            mappings:
              properties:
                histo_or_aggregate_metric:
                  type: aggregate_metric_double
                  metrics: [min, max, sum, value_count]
                  default_metric: value_count

  # Create the data stream
  - do:
      allowed_warnings:
        - "Parameter [default_metric] is deprecated and will be removed in a future version"
      indices.create_data_stream:
        name: test-data-stream

  # Insert a document with aggregate_metric_double value
  - do:
      index:
        index: test-data-stream
        refresh: true
        body:
          '@timestamp': "2023-01-01T00:00:00Z"
          histo_or_aggregate_metric:
            min: 0.9
            max: 10.0
            sum: 20.0
            value_count: 3

  # Update the index template to change the field type to exponential_histogram
  - do:
      indices.put_index_template:
        name: test_data_stream_template
        body:
          index_patterns: ["test-data-stream*"]
          data_stream: {}
          template:
            mappings:
              properties:
                histo_or_aggregate_metric:
                  type: exponential_histogram

  # Rollover the data stream to apply the new mapping
  - do:
      indices.rollover:
        alias: test-data-stream

  # Insert a document with exponential_histogram value
  - do:
      index:
        index: test-data-stream
        refresh: true
        body:
          '@timestamp': "2023-01-02T00:00:00Z"
          histo_or_aggregate_metric:
            scale: 1
            sum: 100.0
            min: 1.0
            max: 10.0
            zero: { count: 1 }
            positive: { indices: [0,1], counts: [2,3] }
            negative: { indices: [0], counts: [1] }

---
"Value count aggregation over aggregate_metric_double and exponential_histogram":
  - do:
      search:
        index: test-data-stream
        size: 0
        body:
          aggs:
            value_count_metric:
              value_count:
                field: histo_or_aggregate_metric
  - match: { aggregations.value_count_metric.value: 10.0 }

---
"Sum aggregation over aggregate_metric_double and exponential_histogram":
  - do:
      search:
        index: test-data-stream
        size: 0
        body:
          aggs:
            sum_metric:
              sum:
                field: histo_or_aggregate_metric
  - match: { aggregations.sum_metric.value: 120.0 }

---
"Average aggregation over aggregate_metric_double and exponential_histogram":
  - do:
      search:
        index: test-data-stream
        size: 0
        body:
          aggs:
            avg_metric:
              avg:
                field: histo_or_aggregate_metric
  - match: { aggregations.avg_metric.value: 12.0 }

---
"Min aggregation over aggregate_metric_double and exponential_histogram":
  - requires:
      cluster_features: [ "search.exponential_histogram_querydsl_min_max" ]
      reason: exponential_histogram min/max aggregations were introduced
  - do:
      search:
        index: test-data-stream
        size: 0
        body:
          aggs:
            min_agg:
              min:
                field: histo_or_aggregate_metric

  - match: { hits.total.value: 2 }
  - match: { aggregations.min_agg.value: 0.9 }

---
"Max aggregation over aggregate_metric_double and exponential_histogram":
  - requires:
      cluster_features: [ "search.exponential_histogram_querydsl_min_max" ]
      reason: exponential_histogram min/max aggregations were introduced
  - do:
      search:
        index: test-data-stream
        size: 0
        body:
          aggs:
            max_agg:
              max:
                field: histo_or_aggregate_metric

  - match: { hits.total.value: 2 }
  - match: { aggregations.max_agg.value: 10.0 }

---
"Exists query over aggregate_metric_double and exponential_histogram":
  - do:
      search:
        index: test-data-stream
        body:
          query:
            exists:
              field: histo_or_aggregate_metric

  - match: { hits.total.value: 2 }


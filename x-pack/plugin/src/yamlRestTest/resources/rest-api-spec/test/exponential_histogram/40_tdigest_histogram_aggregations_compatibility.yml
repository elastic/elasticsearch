setup:
  - requires:
      cluster_features: [ "mapper.exponential_histogram_type" ]
      reason: exponential_histogram field type was introduced
  # Create an index template for the data stream with histogram field
  - do:
      indices.put_index_template:
        name: test_data_stream_template
        body:
          index_patterns: ["test-data-stream*"]
          data_stream: {}
          template:
            mappings:
              properties:
                tdigest_or_exp_histo:
                  type: histogram

  # Create the data stream
  - do:
      indices.create_data_stream:
        name: test-data-stream

  # Insert a document with T-Digest histogram value
  - do:
      index:
        index: test-data-stream
        refresh: true
        body:
          '@timestamp': "2023-01-01T00:00:00Z"
          tdigest_or_exp_histo:
            values: [0.9, 2.0, 4.0]
            counts: [2, 2, 1]

  # Update the index template to change the field type to exponential_histogram
  - do:
      indices.put_index_template:
        name: test_data_stream_template
        body:
          index_patterns: ["test-data-stream*"]
          data_stream: {}
          template:
            mappings:
              properties:
                tdigest_or_exp_histo:
                  type: exponential_histogram

  # Rollover the data stream to apply the new mapping
  - do:
      indices.rollover:
        alias: test-data-stream

  # Insert a document with exponential_histogram value
  - do:
      index:
        index: test-data-stream
        refresh: true
        body:
          '@timestamp': "2023-01-02T00:00:00Z"
          tdigest_or_exp_histo:
            scale: 0
            sum: 100.0
            min: 1.0
            max: 10.0
            zero: { count: 1 }
            positive: { indices: [0,1,2], counts: [1,2,1] }

---
"Value count aggregation over tdigest and exponential_histogram":
  - do:
      search:
        index: test-data-stream
        size: 0
        body:
          aggs:
            value_count_metric:
              value_count:
                field: tdigest_or_exp_histo
  - match: { aggregations.value_count_metric.value: 10.0 }

---
"Sum aggregation over tdigest and exponential_histogram":
  - do:
      search:
        index: test-data-stream
        size: 0
        body:
          aggs:
            sum_metric:
              sum:
                field: tdigest_or_exp_histo
  - match: { aggregations.sum_metric.value: 109.8 }

---
"Average aggregation over tdigest and exponential_histogram":
  - do:
      search:
        index: test-data-stream
        size: 0
        body:
          aggs:
            avg_metric:
              avg:
                field: tdigest_or_exp_histo
  - match: { aggregations.avg_metric.value: 10.98 }

---
"Min aggregation over tdigest and exponential_histogram":
  - requires:
      cluster_features: [ "search.exponential_histogram_querydsl_min_max" ]
      reason: exponential_histogram min/max aggregations were introduced
  - do:
      search:
        index: test-data-stream
        size: 0
        body:
          aggs:
            min_agg:
              min:
                field: tdigest_or_exp_histo

  - match: { hits.total.value: 2 }
  - match: { aggregations.min_agg.value: 0.9 }

---
"Max aggregation over tdigest and exponential_histogram":
  - requires:
      cluster_features: [ "search.exponential_histogram_querydsl_min_max" ]
      reason: exponential_histogram min/max aggregations were introduced
  - do:
      search:
        index: test-data-stream
        size: 0
        body:
          aggs:
            max_agg:
              max:
                field: tdigest_or_exp_histo

  - match: { hits.total.value: 2 }
  - match: { aggregations.max_agg.value: 10.0 }

---
"Histogram aggregation over tdigest and exponential_histogram":
  - do:
      search:
        index: test-data-stream
        size: 0
        body:
          aggs:
            histo_agg:
              histogram:
                field: tdigest_or_exp_histo
                interval: 0.5
                min_doc_count: 1
  - match:
      aggregations.histo_agg.buckets:
        - key: 0.0
          doc_count: 1
        - key: 0.5
          doc_count: 2
        - key: 1.0
          doc_count: 1
        - key: 2.0
          doc_count: 2
        - key: 2.5
          doc_count: 2
        - key: 4.0
          doc_count: 1
        - key: 5.0
          doc_count: 1

---
"Percentiles aggregation over tdigest and exponential_histogram":
  - requires:
      cluster_features: [ "search.exponential_histogram_querydsl_percentiles" ]
      reason: exponential_histogram percentile aggregations was introduced
  - do:
      search:
        index: test-data-stream
        size: 0
        body:
          aggs:
            percentiles_agg:
              percentiles:
                field: tdigest_or_exp_histo
                percents: [5, 25, 50, 75]

  - match: { hits.total.value: 2 }
  # Use range comparisons to handle small numeric errors across different machines
  - gte: { aggregations.percentiles_agg.values.5\.0: 0.899 }
  - lte: { aggregations.percentiles_agg.values.5\.0: 0.901 }
  - gte: { aggregations.percentiles_agg.values.25\.0: 1.007 }
  - lte: { aggregations.percentiles_agg.values.25\.0: 1.009 }
  - gte: { aggregations.percentiles_agg.values.50\.0: 1.999 }
  - lte: { aggregations.percentiles_agg.values.50\.0: 2.001 }
  - gte: { aggregations.percentiles_agg.values.75\.0: 2.665 }
  - lte: { aggregations.percentiles_agg.values.75\.0: 2.667 }

---
"Percentile ranks aggregation over tdigest and exponential_histogram":
  - requires:
      cluster_features: [ "search.exponential_histogram_querydsl_percentile_ranks" ]
      reason: exponential_histogram percentile_ranks aggregations was introduced
  - do:
      search:
        index: test-data-stream
        size: 0
        body:
          aggs:
            percentile_ranks_agg:
              percentile_ranks:
                field: tdigest_or_exp_histo
                values: [0, 1, 2, 5, 8]

  - match: { hits.total.value: 2 }
  - match:
      aggregations.percentile_ranks_agg.values:
        0.0: 0.0
        1.0: 30.0
        2.0: 60.0
        5.0: 90.0
        8.0: 100.0

---
"Exists query over tdigest and exponential_histogram":
  - do:
      search:
        index: test-data-stream
        body:
          query:
            exists:
              field: tdigest_or_exp_histo

  - match: { hits.total.value: 2 }


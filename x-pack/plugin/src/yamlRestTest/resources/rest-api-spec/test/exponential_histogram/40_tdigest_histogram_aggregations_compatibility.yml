setup:
  - requires:
      cluster_features: [ "mapper.exponential_histogram_type" ]
      reason: exponential_histogram field type was introduced
  # Create an index template for the data stream with histogram field
  - do:
      indices.put_index_template:
        name: test_data_stream_template
        body:
          index_patterns: ["test-data-stream*"]
          data_stream: {}
          template:
            mappings:
              properties:
                tdigest_or_exp_histo:
                  type: histogram

  # Create the data stream
  - do:
      indices.create_data_stream:
        name: test-data-stream

  # Insert a document with T-Digest histogram value
  - do:
      index:
        index: test-data-stream
        refresh: true
        body:
          '@timestamp': "2023-01-01T00:00:00Z"
          tdigest_or_exp_histo:
            values: [0.9, 2.0, 4.0]
            counts: [2, 2, 1]

  # Update the index template to change the field type to exponential_histogram
  - do:
      indices.put_index_template:
        name: test_data_stream_template
        body:
          index_patterns: ["test-data-stream*"]
          data_stream: {}
          template:
            mappings:
              properties:
                tdigest_or_exp_histo:
                  type: exponential_histogram

  # Rollover the data stream to apply the new mapping
  - do:
      indices.rollover:
        alias: test-data-stream

  # Insert a document with exponential_histogram value
  - do:
      index:
        index: test-data-stream
        refresh: true
        body:
          '@timestamp': "2023-01-02T00:00:00Z"
          tdigest_or_exp_histo:
            scale: 1
            sum: 100.0
            min: 1.0
            max: 10.0
            zero: { count: 1 }
            positive: { indices: [0,1], counts: [1,2] }
            negative: { indices: [0], counts: [1] }

---
"Value count aggregation over aggregate_metric_double and exponential_histogram":
  - do:
      search:
        index: test-data-stream
        size: 0
        body:
          aggs:
            value_count_metric:
              value_count:
                field: tdigest_or_exp_histo
  - match: { aggregations.value_count_metric.value: 10.0 }

---
"Sum aggregation over aggregate_metric_double and exponential_histogram":
  - do:
      search:
        index: test-data-stream
        size: 0
        body:
          aggs:
            sum_metric:
              sum:
                field: tdigest_or_exp_histo
  - match: { aggregations.sum_metric.value: 109.8 }

---
"Average aggregation over aggregate_metric_double and exponential_histogram":
  - do:
      search:
        index: test-data-stream
        size: 0
        body:
          aggs:
            avg_metric:
              avg:
                field: tdigest_or_exp_histo
  - match: { aggregations.avg_metric.value: 10.98 }

---
"Min aggregation over aggregate_metric_double and exponential_histogram":
  - requires:
      cluster_features: [ "search.exponential_histogram_querydsl_min_max" ]
      reason: exponential_histogram min/max aggregations were introduced
  - do:
      search:
        index: test-data-stream
        size: 0
        body:
          aggs:
            min_agg:
              min:
                field: tdigest_or_exp_histo

  - match: { hits.total.value: 2 }
  - match: { aggregations.min_agg.value: 0.9 }

---
"Max aggregation over aggregate_metric_double and exponential_histogram":
  - requires:
      cluster_features: [ "search.exponential_histogram_querydsl_min_max" ]
      reason: exponential_histogram min/max aggregations were introduced
  - do:
      search:
        index: test-data-stream
        size: 0
        body:
          aggs:
            max_agg:
              max:
                field: tdigest_or_exp_histo

  - match: { hits.total.value: 2 }
  - match: { aggregations.max_agg.value: 10.0 }

setup:
  - do:
      indices.create:
        index: airline-data
        body:
          mappings:
            properties:
              time:
                type: date
              airline:
                type: keyword
              responsetime:
                type: float
              event_rate:
                type: integer
  - do:
      transform.put_transform:
        transform_id: "airline-transform-stats"
        body: >
          {
            "source": { "index": "airline-data" },
            "dest": { "index": "airline-data-by-airline-stats" },
            "pivot": {
              "group_by": { "airline": {"terms": {"field": "airline"}}},
              "aggs": {"avg_response": {"avg": {"field": "responsetime"}}}
            },
            "sync": { "time": { "field": "time", "delay": "1m" } }
          }
  - do:
      transform.put_transform:
        transform_id: "airline-transform-stats-dos"
        body: >
          {
            "source": { "index": "airline-data" },
            "dest": { "index": "airline-data-by-airline-stats-dos" },
            "pivot": {
              "group_by": { "airline": {"terms": {"field": "airline"}}},
              "aggs": {"avg_response": {"avg": {"field": "responsetime"}}}
            },
            "sync": { "time": { "field": "time", "delay": "1m" } }
          }
  - do:
      transform.put_transform:
        transform_id: "airline-transform-stats-the-third"
        body: >
          {
            "source": { "index": "airline-data" },
            "dest": { "index": "airline-data-by-airline-stats-the-third" },
            "pivot": {
              "group_by": { "airline": {"terms": {"field": "airline"}}},
              "aggs": {"avg_response": {"avg": {"field": "responsetime"}}}
            },
            "sync": { "time": { "field": "time", "delay": "1m" } }
          }

---
teardown:
  - do:
      transform.stop_transform:
        wait_for_checkpoint: false
        transform_id: "airline-transform-stats"
        wait_for_completion: true
  - do:
      transform.delete_transform:
        transform_id: "airline-transform-stats"
  - do:
      transform.stop_transform:
        wait_for_checkpoint: false
        transform_id: "airline-transform-stats-dos"
        wait_for_completion: true
  - do:
      transform.delete_transform:
        transform_id: "airline-transform-stats-dos"
  - do:
      transform.stop_transform:
        wait_for_checkpoint: false
        transform_id: "airline-transform-stats-the-third"
        wait_for_completion: true
  - do:
      transform.delete_transform:
        transform_id: "airline-transform-stats-the-third"

---
"Test get node stats":
  - do:
      transform.get_node_stats: {}
  - match: { total.scheduler.registered_transform_count: 0 }

  - do:
      transform.start_transform:
        transform_id: "airline-transform-stats"

  - do:
      transform.get_node_stats: {}
  - match: { total.scheduler.registered_transform_count: 1 }

  - do:
      transform.start_transform:
        transform_id: "airline-transform-stats-dos"

  - do:
      transform.get_node_stats: {}
  - match: { total.scheduler.registered_transform_count: 2 }

  - do:
      transform.start_transform:
        transform_id: "airline-transform-stats-the-third"

  - do:
      transform.get_node_stats: {}
  - match: { total.scheduler.registered_transform_count: 3 }
